<div class="expense-form-container">
  <div class="page-header">
    <h2>{{ isEditing ? 'Edit Expense' : 'New Expense Request' }}</h2>
  </div>

  <div class="form-content" *ngIf="!loading">
    <div class="form-section">
      <h3>Expense Details</h3>
      
      <div class="form-group">
        <label>Title *</label>
        <input type="text" [(ngModel)]="expenseRequest.title" placeholder="Enter expense title">
      </div>
      
      <div class="form-group">
        <label>Description</label>
        <textarea [(ngModel)]="expenseRequest.description" rows="3" placeholder="Describe the expense"></textarea>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Expense Date</label>
          <input type="date" [(ngModel)]="expenseRequest.expenseDate">
        </div>
        <div class="form-group">
          <label>Project Code</label>
          <input type="text" [(ngModel)]="expenseRequest.projectCode" placeholder="Optional">
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Period From</label>
          <input type="date" [(ngModel)]="expenseRequest.periodFrom">
        </div>
        <div class="form-group">
          <label>Period To</label>
          <input type="date" [(ngModel)]="expenseRequest.periodTo">
        </div>
      </div>
      
      <div class="form-group checkbox-group">
        <label>
          <input type="checkbox" [(ngModel)]="expenseRequest.reimbursementRequired">
          Requires Reimbursement
        </label>
      </div>
    </div>

    <div class="form-section">
      <div class="section-header">
        <h3>Expense Items</h3>
        <button class="btn btn-sm btn-primary" (click)="openItemModal()">
          <i class="fas fa-plus"></i> Add Item
        </button>
      </div>
      
      <div class="items-table" *ngIf="expenseRequest.items && expenseRequest.items.length > 0">
        <table>
          <thead>
            <tr>
              <th>Category</th>
              <th>Description</th>
              <th>Date</th>
              <th>Vendor</th>
              <th>Amount</th>
              <th>Payment Method</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of expenseRequest.items; let i = index">
              <td>{{ getCategoryName(item.categoryId || item.category?.id!) }}</td>
              <td>{{ item.description }}</td>
              <td>{{ item.expenseDate }}</td>
              <td>{{ item.vendor || '-' }}</td>
              <td>{{ formatCurrency(item.amount) }}</td>
              <td>{{ getPaymentMethodLabel(item.paymentMethod!) }}</td>
              <td class="actions">
                <button class="btn-icon" (click)="openItemModal(i)" title="Edit">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn-icon danger" (click)="removeItem(i)" title="Remove">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="4" class="total-label">Total:</td>
              <td colspan="3" class="total-amount">{{ formatCurrency(expenseRequest.totalAmount!) }}</td>
            </tr>
          </tfoot>
        </table>
      </div>
      
      <div class="empty-items" *ngIf="!expenseRequest.items || expenseRequest.items.length === 0">
        <i class="fas fa-receipt"></i>
        <p>No expense items added yet. Click "Add Item" to add expenses.</p>
      </div>
    </div>

    <div class="form-actions">
      <button class="btn btn-secondary" (click)="cancel()">Cancel</button>
      <button class="btn btn-outline" (click)="saveExpense()" [disabled]="saving">
        <i class="fas fa-save"></i> Save as Draft
      </button>
      <button class="btn btn-primary" (click)="submitExpense()" 
              [disabled]="saving || !expenseRequest.items || expenseRequest.items.length === 0">
        <i class="fas fa-paper-plane"></i> Submit for Approval
      </button>
    </div>
  </div>

  <div class="loading-state" *ngIf="loading">
    <i class="fas fa-spinner fa-spin fa-2x"></i>
    <p>Loading expense...</p>
  </div>
</div>

<div class="modal-overlay" *ngIf="showItemModal" (click)="closeItemModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ editingItemIndex >= 0 ? 'Edit Item' : 'Add Expense Item' }}</h3>
      <button class="close-btn" (click)="closeItemModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="form-group">
        <label>Category *</label>
        <select [(ngModel)]="itemForm.categoryId">
          <option value="">Select Category</option>
          <option *ngFor="let category of categories" [value]="category.id">
            {{ category.name }} ({{ category.expenseType }})
          </option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Description *</label>
        <input type="text" [(ngModel)]="itemForm.description" placeholder="What was this expense for?">
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Date *</label>
          <input type="date" [(ngModel)]="itemForm.expenseDate">
        </div>
        <div class="form-group">
          <label>Vendor</label>
          <input type="text" [(ngModel)]="itemForm.vendor" placeholder="Merchant/Vendor name">
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Amount *</label>
          <input type="number" [(ngModel)]="itemForm.amount" step="0.01" min="0">
        </div>
        <div class="form-group">
          <label>Currency</label>
          <select [(ngModel)]="itemForm.currency">
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
            <option value="GBP">GBP</option>
            <option value="INR">INR</option>
          </select>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Quantity</label>
          <input type="number" [(ngModel)]="itemForm.quantity" min="1">
        </div>
        <div class="form-group">
          <label>Payment Method</label>
          <select [(ngModel)]="itemForm.paymentMethod">
            <option *ngFor="let method of paymentMethods" [value]="method.value">{{ method.label }}</option>
          </select>
        </div>
      </div>
      
      <div class="form-group">
        <label>Receipt Number</label>
        <input type="text" [(ngModel)]="itemForm.receiptNumber" placeholder="Optional">
      </div>
      
      <div class="form-group">
        <label>Notes</label>
        <textarea [(ngModel)]="itemForm.notes" rows="2" placeholder="Additional notes"></textarea>
      </div>
      
      <div class="form-group checkbox-group">
        <label>
          <input type="checkbox" [(ngModel)]="itemForm.billable">
          Billable to Client
        </label>
      </div>
      
      <div class="form-group" *ngIf="itemForm.billable">
        <label>Client Code</label>
        <input type="text" [(ngModel)]="itemForm.clientCode" placeholder="Client code">
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeItemModal()">Cancel</button>
      <button class="btn btn-primary" (click)="saveItem()">
        {{ editingItemIndex >= 0 ? 'Update' : 'Add' }} Item
      </button>
    </div>
  </div>
</div>
