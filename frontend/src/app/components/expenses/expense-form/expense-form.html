<div class="expense-form-container">
  <div class="page-header">
    <h2>{{ isEditing ? 'Edit Expense' : 'New Expense Request' }}</h2>
  </div>

  <div class="form-content" *ngIf="!loading">
    <div class="form-section">
      <h3>Expense Details</h3>
      
      <div class="form-group">
        <label>Title *</label>
        <input type="text" [(ngModel)]="expenseRequest.title" placeholder="Enter expense title">
      </div>
      
      <div class="form-group">
        <label>Description</label>
        <textarea [(ngModel)]="expenseRequest.description" rows="3" placeholder="Describe the expense"></textarea>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Expense Date</label>
          <input type="date" [(ngModel)]="expenseRequest.expenseDate">
        </div>
        <div class="form-group">
          <label>Payee Name *</label>
          <input type="text" [(ngModel)]="expenseRequest.payeeName" placeholder="Enter payee/vendor name">
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Project (Optional)</label>
          <select [(ngModel)]="expenseRequest.projectCode">
            <option value="">-- No Project --</option>
            <option *ngFor="let project of projects" [value]="project.projectCode">
              {{ project.projectCode }} - {{ project.name }}
            </option>
          </select>
        </div>
        <div class="form-group">
          <label>Expense Category</label>
          <select [(ngModel)]="expenseRequest.categoryId">
            <option value="">-- Select Category --</option>
            <option *ngFor="let cat of categories" [value]="cat.id">{{ cat.name }}</option>
          </select>
        </div>
      </div>
      
      <div class="form-group checkbox-group">
        <label>
          <input type="checkbox" [(ngModel)]="expenseRequest.reimbursementRequired">
          Requires Reimbursement
        </label>
      </div>
    </div>

    <div class="form-section">
      <div class="section-header">
        <h3>Expense Items</h3>
        <button class="btn btn-sm btn-primary" (click)="openItemModal()">
          <i class="fas fa-plus"></i> Add Item
        </button>
      </div>
      
      <div class="items-table" *ngIf="expenseRequest.items && expenseRequest.items.length > 0">
        <table>
          <thead>
            <tr>
              <th>Expense Type</th>
              <th>Description</th>
              <th>Amount</th>
              <th>Receipt</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of expenseRequest.items; let i = index">
              <td>{{ item.expenseType || '-' }}</td>
              <td>{{ item.description || '-' }}</td>
              <td>{{ formatCurrency(item.amount) }}</td>
              <td>
                <span class="receipt-badge" *ngIf="item.receiptFileName">
                  <i class="fas" [ngClass]="item.receiptFileName.endsWith('.pdf') ? 'fa-file-pdf' : 'fa-file-image'"></i>
                  {{ item.receiptFileName }}
                </span>
                <span class="no-receipt" *ngIf="!item.receiptFileName">No file</span>
              </td>
              <td class="actions">
                <button class="btn-icon" (click)="openItemModal(i)" title="Edit">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn-icon danger" (click)="removeItem(i)" title="Remove">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="2" class="total-label">Total:</td>
              <td colspan="3" class="total-amount">{{ formatCurrency(expenseRequest.totalAmount!) }}</td>
            </tr>
          </tfoot>
        </table>
      </div>
      
      <div class="empty-items" *ngIf="!expenseRequest.items || expenseRequest.items.length === 0">
        <i class="fas fa-receipt"></i>
        <p>No expense items added yet. Click "Add Item" to add expenses.</p>
      </div>
    </div>

    <div class="form-actions">
      <button class="btn btn-secondary" (click)="cancel()">Cancel</button>
      <button class="btn btn-outline" (click)="saveExpense()" [disabled]="saving">
        <i class="fas fa-save"></i> Save as Draft
      </button>
      <button class="btn btn-primary" (click)="submitExpense()" 
              [disabled]="saving || !expenseRequest.items || expenseRequest.items.length === 0">
        <i class="fas fa-paper-plane"></i> Submit for Approval
      </button>
    </div>
  </div>

  <div class="loading-state" *ngIf="loading">
    <i class="fas fa-spinner fa-spin fa-2x"></i>
    <p>Loading expense...</p>
  </div>
</div>

<div class="modal-overlay" *ngIf="showItemModal" (click)="closeItemModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ editingItemIndex >= 0 ? 'Edit Item' : 'Add Expense Item' }}</h3>
      <button class="close-btn" (click)="closeItemModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="form-group">
        <label>Expense Category *</label>
        <select [(ngModel)]="itemForm.categoryId">
          <option value="">Select Category</option>
          <option *ngFor="let cat of categories" [value]="cat.id">{{ cat.name }}</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Expense Type</label>
        <select [(ngModel)]="itemForm.expenseType">
          <option value="">Select Expense Type</option>
          <option *ngFor="let type of expenseTypesList" [value]="type.name">{{ type.name }}</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Amount *</label>
        <input type="number" [(ngModel)]="itemForm.amount" step="0.01" min="0" placeholder="Enter amount">
      </div>
      
      <div class="form-group">
        <label>Description</label>
        <input type="text" [(ngModel)]="itemForm.description" placeholder="Brief description (optional)">
      </div>
      
      <div class="form-group">
        <label>Payment Proof (Image/PDF) *</label>
        <div class="file-upload-area" 
             [class.has-file]="itemForm.receiptFileName"
             (click)="fileInput.click()"
             (dragover)="onDragOver($event)"
             (drop)="onFileDrop($event)">
          <input type="file" 
                 #fileInput 
                 accept="image/*,.pdf" 
                 (change)="onFileSelected($event)"
                 style="display: none;">
          <div class="upload-content" *ngIf="!itemForm.receiptFileName">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Click to upload or drag & drop</p>
            <span>Accepts: JPG, PNG, PDF (Max 10MB)</span>
          </div>
          <div class="file-preview" *ngIf="itemForm.receiptFileName">
            <i class="fas" [ngClass]="itemForm.receiptFileName.endsWith('.pdf') ? 'fa-file-pdf' : 'fa-file-image'"></i>
            <span class="file-name">{{ itemForm.receiptFileName }}</span>
            <button class="btn-remove" (click)="removeFile($event)">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeItemModal()">Cancel</button>
      <button class="btn btn-primary" (click)="saveItem()" [disabled]="!itemForm.expenseType || !itemForm.amount">
        {{ editingItemIndex >= 0 ? 'Update' : 'Add' }} Item
      </button>
    </div>
  </div>
</div>
