<div class="chat-panel" [class.open]="isOpen">
  <div class="chat-header">
    <div class="header-left">
      <button class="back-btn" *ngIf="selectedUser" (click)="goBack()">
        <i class="fas fa-arrow-left"></i>
      </button>
      <h3 *ngIf="!selectedUser">Messages</h3>
      <div class="connection-status" *ngIf="!selectedUser" [ngClass]="getConnectionStatusClass()">
        <i class="fas fa-circle"></i> {{ getConnectionStatusText() }}
      </div>
      <div class="selected-user-info" *ngIf="selectedUser">
        <div class="user-avatar" [class.online]="selectedUser.online">{{ selectedUser.avatar }}</div>
        <div class="user-details">
          <span class="user-name">{{ selectedUser.name }}</span>
          <span class="user-code" *ngIf="selectedUser.employeeCode">({{ selectedUser.employeeCode }})</span>
          <span class="user-status" [class.online]="selectedUser.online">
            {{ selectedUser.online ? 'Online' : getLastSeenText(selectedUser) }}
          </span>
        </div>
      </div>
    </div>
    <button class="close-btn" (click)="closePanel()">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <!-- Users List View -->
  <div class="chat-body" *ngIf="!selectedUser">
    <div class="search-section">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" [(ngModel)]="searchQuery" placeholder="Search conversations..." />
      </div>
    </div>

    <div class="tabs-section">
      <button class="tab-btn" [class.active]="activeTab === 'chats'" (click)="activeTab = 'chats'">
        Chats
        <span class="badge" *ngIf="totalUnread > 0">{{ totalUnread }}</span>
      </button>
      <button class="tab-btn" [class.active]="activeTab === 'contacts'" (click)="activeTab = 'contacts'">
        Contacts
      </button>
    </div>

    <div class="users-list">
      <div class="user-item" *ngFor="let user of filteredUsers" (click)="selectUser(user)">
        <div class="user-avatar" [class.online]="user.online">
          {{ user.avatar }}
        </div>
        <div class="user-info">
          <span class="user-name">{{ user.name }} <small *ngIf="user.employeeCode">({{ user.employeeCode }})</small></span>
          <span class="last-message">{{ user.lastMessage || 'No messages yet' }}</span>
        </div>
        <div class="user-meta">
          <span class="msg-time" *ngIf="user.lastMessageTime">{{ formatLastMessageTime(user.lastMessageTime) }}</span>
          <span class="unread-badge" *ngIf="user.unreadCount > 0">{{ user.unreadCount }}</span>
        </div>
      </div>

      <div class="empty-state" *ngIf="filteredUsers.length === 0">
        <i class="fas fa-comments"></i>
        <p>No conversations found</p>
      </div>
    </div>
  </div>

  <!-- Chat View -->
  <div class="chat-view" *ngIf="selectedUser">
    <div class="messages-container">
      <div class="loading" *ngIf="loading">
        <i class="fas fa-spinner fa-spin"></i> Loading messages...
      </div>

      <div class="messages-list" *ngIf="!loading">
        <div class="message-group" *ngFor="let msg of messages" [class.own]="msg.isOwn">
          <div class="message-bubble">
            <div class="message-image" *ngIf="msg.attachmentType === 'image' && msg.attachmentUrl">
              <img [src]="msg.attachmentUrl" [alt]="msg.attachmentName || 'Image'" (click)="openImagePreview(msg.attachmentUrl!)">
            </div>
            <div class="message-document" *ngIf="msg.attachmentType === 'document' && msg.attachmentName">
              <i class="fas" [ngClass]="getFileIcon(msg.attachmentName)"></i>
              <span class="doc-name">{{ msg.attachmentName }}</span>
              <a *ngIf="msg.attachmentUrl" [href]="msg.attachmentUrl" [download]="msg.attachmentName" class="download-btn">
                <i class="fas fa-download"></i>
              </a>
            </div>
            <p class="message-text" *ngIf="msg.message">{{ msg.message }}</p>
            <div class="message-meta">
              <span class="message-time">{{ formatTime(msg.timestamp) }}</span>
              <span class="message-status" *ngIf="msg.isOwn">
                <i class="fas fa-clock" *ngIf="msg.status === 'sending'" title="Sending"></i>
                <i class="fas fa-check" *ngIf="msg.status === 'sent'" title="Sent"></i>
                <i class="fas fa-check-double" *ngIf="msg.status === 'delivered'" title="Delivered"></i>
                <i class="fas fa-check-double read" *ngIf="msg.status === 'read'" title="Read"></i>
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="typing-indicator" *ngIf="isTyping">
      <span>{{ typingUser }} is typing...</span>
    </div>

    <div class="attachment-preview" *ngIf="selectedFile">
      <i class="fas" [ngClass]="getFileIcon(selectedFile.name)"></i>
      <span>{{ selectedFile.name }}</span>
      <button class="remove-file" (click)="removeFile()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="message-input">
      <div class="input-wrapper">
        <input 
          type="file" 
          #fileInput 
          (change)="onFileSelected($event)" 
          accept="image/*,.pdf,.doc,.docx,.xls,.xlsx"
          style="display: none;"
        />
        <button class="attach-btn" (click)="fileInput.click()" title="Attach file">
          <i class="fas fa-paperclip"></i>
        </button>
        <input 
          type="text" 
          [(ngModel)]="newMessage" 
          placeholder="Type a message..." 
          (keyup.enter)="sendMessage()"
          (input)="onTyping()"
        />
      </div>
      <button class="send-btn" (click)="sendMessage()" [disabled]="!newMessage.trim() && !selectedFile">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>
</div>
