<div class="loans-container">
  <div class="page-header">
    <h2>Loans & Advances Management</h2>
  </div>

  <div class="dashboard-cards">
    <div class="card stat-card">
      <div class="stat-value">{{ dashboard.pendingApproval || 0 }}</div>
      <div class="stat-label">Pending Approval</div>
    </div>
    <div class="card stat-card">
      <div class="stat-value">{{ dashboard.activeLoans || 0 }}</div>
      <div class="stat-label">Active Loans</div>
    </div>
    <div class="card stat-card">
      <div class="stat-value">{{ dashboard.overduePayments || 0 }}</div>
      <div class="stat-label">Overdue Payments</div>
    </div>
    <div class="card stat-card">
      <div class="stat-value">{{ dashboard.dueThisMonth || 0 }}</div>
      <div class="stat-label">Due This Month</div>
    </div>
  </div>

  <div class="tabs">
    <button [class.active]="activeTab === 'applications'" (click)="setTab('applications')">All Applications</button>
    <button [class.active]="activeTab === 'pending'" (click)="setTab('pending')">Pending Approval</button>
    <button [class.active]="activeTab === 'outstanding'" (click)="setTab('outstanding')">Outstanding Loans</button>
  </div>

  <div class="section-header">
    <h3>Loan Applications</h3>
    <button class="btn btn-primary" (click)="openForm()">+ New Loan Application</button>
  </div>

  <div class="table-container" >
    <table class="data-table">
      <thead>
        <tr>
          <th>Application #</th>
          <th>Employee</th>
          <th>Type</th>
          <th>Requested</th>
          <th>Approved</th>
          <th>Tenure</th>
          <th>EMI</th>
          <th>Outstanding</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let loan of loans">
          <td>{{ loan.applicationNumber }}</td>
          <td>{{ loan.employee?.firstName }} {{ loan.employee?.lastName }}</td>
          <td>{{ loan.loanType }}</td>
          <td>{{ formatCurrency(loan.requestedAmount) }}</td>
          <td>{{ loan.approvedAmount ? formatCurrency(loan.approvedAmount) : '-' }}</td>
          <td>{{ loan.approvedTenureMonths || loan.requestedTenureMonths }} months</td>
          <td>{{ loan.emiAmount ? formatCurrency(loan.emiAmount) : '-' }}</td>
          <td>{{ loan.outstandingBalance ? formatCurrency(loan.outstandingBalance) : '-' }}</td>
          <td><span class="badge" [ngClass]="getStatusClass(loan.status)">{{ loan.status }}</span></td>
          <td class="actions-cell">
            <button *ngIf="loan.status === 'DRAFT'" class="btn btn-sm btn-primary" (click)="submitLoan(loan.id)">Submit</button>
            <button *ngIf="loan.status === 'PENDING_APPROVAL'" class="btn btn-sm btn-success" (click)="openApprovalModal(loan)">Approve</button>
            <button *ngIf="loan.status === 'PENDING_APPROVAL'" class="btn btn-sm btn-danger" (click)="rejectLoan(loan.id)">Reject</button>
            <button *ngIf="loan.status === 'APPROVED'" class="btn btn-sm btn-info" (click)="disburseLoan(loan.id)">Disburse</button>
            <button *ngIf="loan.status === 'ACTIVE' || loan.status === 'CLOSED'" class="btn btn-sm" (click)="viewRepayments(loan)">Schedule</button>
            <button *ngIf="loan.status === 'ACTIVE' || loan.status === 'CLOSED'" class="btn btn-sm btn-outline" (click)="viewLedger(loan)">Ledger</button>
          </td>
        </tr>
        <tr *ngIf="loans.length === 0">
          <td colspan="10" class="text-center">No loan applications found</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- New Loan Application Form -->
  <div *ngIf="showForm" class="modal-overlay">
    <div class="modal-content modal-lg" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>New Loan Application</h3>
        <button class="close-btn" (click)="closeForm()">&times;</button>
      </div>
      <form (ngSubmit)="saveLoan()">
        <div class="form-row">
          <div class="form-group">
            <label>Employee <span class="required">*</span></label>
            <select [(ngModel)]="formData.employeeId" name="employeeId" required (change)="checkEligibility()">
              <option [ngValue]="null">Select Employee</option>
              <option *ngFor="let emp of employees" [ngValue]="emp.id">
                {{ emp.employeeId }} - {{ emp.firstName }} {{ emp.lastName }}
              </option>
            </select>
          </div>
          <div class="form-group">
            <label>Loan Type <span class="required">*</span></label>
            <select [(ngModel)]="formData.loanType" name="loanType" required (change)="checkEligibility()">
              <option *ngFor="let type of loanTypes" [value]="type.value">{{ type.label }}</option>
            </select>
          </div>
        </div>

        <div *ngIf="eligibilityMessage" class="eligibility-box" [ngClass]="getEligibilityClass()">
          {{ eligibilityMessage }}
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Requested Amount <span class="required">*</span></label>
            <input type="number" [(ngModel)]="formData.requestedAmount" name="requestedAmount" min="0" step="0.01" required>
          </div>
          <div class="form-group">
            <label>Tenure (months) <span class="required">*</span></label>
            <input type="number" [(ngModel)]="formData.requestedTenureMonths" name="requestedTenureMonths" min="1" max="360" required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Interest Rate (% per annum)</label>
            <input type="number" [(ngModel)]="formData.interestRate" name="interestRate" min="0" max="50" step="0.01">
          </div>
          <div class="form-group">
            <label>Interest Type</label>
            <select [(ngModel)]="formData.interestType" name="interestType">
              <option *ngFor="let type of interestTypes" [value]="type.value">{{ type.label }}</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Preferred Disbursement Date</label>
            <input type="date" [(ngModel)]="formData.requestedDisbursementDate" name="requestedDisbursementDate">
          </div>
          <div class="form-group">
            <label>Deduct from Payroll</label>
            <select [(ngModel)]="formData.deductFromPayroll" name="deductFromPayroll">
              <option [ngValue]="true">Yes</option>
              <option [ngValue]="false">No</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Purpose / Reason</label>
          <textarea [(ngModel)]="formData.purpose" name="purpose" rows="3" placeholder="Describe the purpose of this loan..."></textarea>
        </div>

        <div class="form-group">
          <label>Additional Notes</label>
          <textarea [(ngModel)]="formData.notes" name="notes" rows="2" placeholder="Any additional notes..."></textarea>
        </div>

        <div class="emi-preview-section" *ngIf="formData.requestedAmount > 0 && formData.requestedTenureMonths > 0">
          <button type="button" class="btn btn-outline" (click)="calculateEmiPreview()">Calculate EMI Preview</button>
          <div *ngIf="formData.calculatedEmi" class="emi-summary">
            <div class="emi-item">
              <span class="label">Monthly EMI:</span>
              <span class="value">{{ formatCurrency(formData.calculatedEmi) }}</span>
            </div>
            <div class="emi-item">
              <span class="label">Total Interest:</span>
              <span class="value">{{ formatCurrency(formData.totalInterest) }}</span>
            </div>
            <div class="emi-item">
              <span class="label">Total Payable:</span>
              <span class="value">{{ formatCurrency(formData.totalPayable) }}</span>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="closeForm()">Cancel</button>
          <button type="submit" class="btn btn-primary">Apply for Loan</button>
        </div>
      </form>
    </div>
  </div>

  <!-- EMI Preview Modal -->
  <div *ngIf="showEmiPreview" class="modal-overlay">
    <div class="modal-content modal-lg" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>EMI Schedule Preview</h3>
        <button class="close-btn" (click)="closeEmiPreview()">&times;</button>
      </div>
      <div class="emi-summary-header">
        <div class="summary-item">
          <span class="label">Principal:</span>
          <span class="value">{{ formatCurrency(formData.requestedAmount) }}</span>
        </div>
        <div class="summary-item">
          <span class="label">Interest Rate:</span>
          <span class="value">{{ formData.interestRate }}% p.a. ({{ formData.interestType }})</span>
        </div>
        <div class="summary-item">
          <span class="label">Tenure:</span>
          <span class="value">{{ formData.requestedTenureMonths }} months</span>
        </div>
        <div class="summary-item highlight">
          <span class="label">Monthly EMI:</span>
          <span class="value">{{ formatCurrency(formData.calculatedEmi) }}</span>
        </div>
      </div>
      <div class="table-scroll">
        <table class="data-table">
          <thead>
            <tr>
              <th>#</th>
              <th>EMI Amount</th>
              <th>Principal</th>
              <th>Interest</th>
              <th>Outstanding Balance</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of emiSchedule">
              <td>{{ item.installment }}</td>
              <td>{{ formatCurrency(item.emi) }}</td>
              <td>{{ formatCurrency(item.principal) }}</td>
              <td>{{ formatCurrency(item.interest) }}</td>
              <td>{{ formatCurrency(item.outstanding) }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="form-actions">
        <button class="btn btn-secondary" (click)="closeEmiPreview()">Close</button>
      </div>
    </div>
  </div>

  <!-- Approval Modal -->
  <div *ngIf="showApprovalModal" class="modal-overlay">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Approve Loan Application</h3>
        <button class="close-btn">&times;</button>
      </div>
      <div class="approval-details" *ngIf="selectedLoan">
        <p><strong>Employee:</strong> {{ selectedLoan.employee?.firstName }} {{ selectedLoan.employee?.lastName }}</p>
        <p><strong>Loan Type:</strong> {{ selectedLoan.loanType }}</p>
        <p><strong>Requested Amount:</strong> {{ formatCurrency(selectedLoan.requestedAmount) }}</p>
        <p><strong>Requested Tenure:</strong> {{ selectedLoan.requestedTenureMonths }} months</p>
      </div>
      <div class="form-group">
        <label>Approved Amount</label>
        <input type="number" [(ngModel)]="approvalData.approvedAmount" min="0" step="0.01">
      </div>
      <div class="form-group">
        <label>Approved Tenure (months)</label>
        <input type="number" [(ngModel)]="approvalData.approvedTenure" min="1">
      </div>
      <div class="form-group">
        <label>Remarks</label>
        <textarea [(ngModel)]="approvalData.remarks" rows="3" placeholder="Add approval remarks..."></textarea>
      </div>
      <div class="form-actions">
        <button class="btn btn-secondary">Cancel</button>
        <button class="btn btn-success" (click)="approveLoan()">Approve</button>
      </div>
    </div>
  </div>

  <!-- Repayment Schedule Modal -->
  <div *ngIf="selectedLoan && !showApprovalModal && !showLedger" class="modal-overlay">
    <div class="modal-content modal-lg" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Repayment Schedule - {{ selectedLoan.applicationNumber }}</h3>
        <button class="close-btn" (click)="closeRepayments()">&times;</button>
      </div>
      <div class="loan-summary">
        <div class="summary-item">
          <span class="label">Approved Amount:</span>
          <span class="value">{{ formatCurrency(selectedLoan.approvedAmount) }}</span>
        </div>
        <div class="summary-item">
          <span class="label">Outstanding:</span>
          <span class="value">{{ formatCurrency(selectedLoan.outstandingBalance) }}</span>
        </div>
        <div class="summary-item">
          <span class="label">EMI:</span>
          <span class="value">{{ formatCurrency(selectedLoan.emiAmount) }}</span>
        </div>
      </div>
      <div class="table-scroll">
        <table class="data-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Due Date</th>
              <th>EMI</th>
              <th>Principal</th>
              <th>Interest</th>
              <th>Outstanding</th>
              <th>Paid</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let r of repayments" [class.overdue]="r.status === 'OVERDUE'" [class.paid]="r.status === 'PAID'">
              <td>{{ r.installmentNumber }}</td>
              <td>{{ formatDate(r.dueDate) }}</td>
              <td>{{ formatCurrency(r.emiAmount) }}</td>
              <td>{{ formatCurrency(r.principalAmount) }}</td>
              <td>{{ formatCurrency(r.interestAmount) }}</td>
              <td>{{ formatCurrency(r.outstandingAfter) }}</td>
              <td>{{ r.paidAmount ? formatCurrency(r.paidAmount) : '-' }}</td>
              <td><span class="badge" [ngClass]="getStatusClass(r.status)">{{ r.status }}</span></td>
              <td>
                <button *ngIf="r.status === 'PENDING'" class="btn btn-sm btn-success" (click)="recordManualPayment(r)">Record Payment</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="form-actions">
        <button class="btn btn-secondary" (click)="closeRepayments()">Close</button>
      </div>
    </div>
  </div>

  <!-- Loan Ledger Modal -->
  <div *ngIf="showLedger" class="modal-overlay">
    <div class="modal-content modal-lg" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Loan Ledger - {{ ledgerLoan?.applicationNumber }}</h3>
        <button class="close-btn" (click)="closeLedger()">&times;</button>
      </div>
      <div class="ledger-summary">
        <div class="ledger-card">
          <div class="ledger-label">Opening Balance</div>
          <div class="ledger-value">{{ formatCurrency(getLedgerOpeningBalance()) }}</div>
        </div>
        <div class="ledger-card">
          <div class="ledger-label">Principal Paid</div>
          <div class="ledger-value text-success">{{ formatCurrency(getLedgerPaidPrincipal()) }}</div>
        </div>
        <div class="ledger-card">
          <div class="ledger-label">Interest Paid</div>
          <div class="ledger-value text-warning">{{ formatCurrency(getLedgerPaidInterest()) }}</div>
        </div>
        <div class="ledger-card highlight">
          <div class="ledger-label">Closing Balance</div>
          <div class="ledger-value">{{ formatCurrency(getLedgerClosingBalance()) }}</div>
        </div>
      </div>
      <h4>Transaction History</h4>
      <div class="table-scroll">
        <table class="data-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Date</th>
              <th>Type</th>
              <th>Principal</th>
              <th>Interest</th>
              <th>Total</th>
              <th>Balance After</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>0</td>
              <td>{{ formatDate(ledgerLoan?.actualDisbursementDate) }}</td>
              <td><span class="badge bg-primary">Disbursement</span></td>
              <td>{{ formatCurrency(ledgerLoan?.approvedAmount) }}</td>
              <td>-</td>
              <td>{{ formatCurrency(ledgerLoan?.approvedAmount) }}</td>
              <td>{{ formatCurrency(ledgerLoan?.approvedAmount) }}</td>
            </tr>
            <tr *ngFor="let r of repayments" [class.pending]="r.status === 'PENDING'">
              <td>{{ r.installmentNumber }}</td>
              <td>{{ r.paidDate ? formatDate(r.paidDate) : formatDate(r.dueDate) + ' (Due)' }}</td>
              <td>
                <span class="badge" [ngClass]="r.status === 'PAID' ? 'bg-success' : 'bg-warning'">
                  {{ r.status === 'PAID' ? 'EMI Payment' : 'Scheduled' }}
                </span>
              </td>
              <td>{{ formatCurrency(r.principalAmount) }}</td>
              <td>{{ formatCurrency(r.interestAmount) }}</td>
              <td>{{ formatCurrency(r.emiAmount) }}</td>
              <td>{{ formatCurrency(r.outstandingAfter) }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="form-actions">
        <button class="btn btn-secondary" (click)="closeLedger()">Close</button>
      </div>
    </div>
  </div>
</div>
