<div class="payroll-calc-container">
  <div class="page-header">
    <h2>Payroll Calculation</h2>
    <div class="header-actions">
      <button class="btn btn-secondary" (click)="openTimesheetDialog()">
        <i class="fas fa-clock"></i> Generate Timesheets
      </button>
      <button class="btn btn-primary" (click)="openCreateModal()">
        <i class="fas fa-plus"></i> Create Payroll Run
      </button>
    </div>
  </div>

  <div class="info-card">
    <i class="fas fa-info-circle"></i>
    <div>
      <strong>3-Phase Payroll Processing Workflow:</strong>
      <ol>
        <li><strong>Phase 1:</strong> Daily attendance tracking with clock in/out and approval</li>
        <li><strong>Phase 2:</strong> Click "Generate Timesheets" to create attendance or project timesheets from approved records</li>
        <li><strong>Phase 3:</strong> Create payroll run, calculate payroll from approved timesheets, review and process</li>
      </ol>
    </div>
  </div>

  <div class="table-container">
    <table class="data-table">
      <thead>
        <tr>
          <th>Payroll Run #</th>
          <th>Description</th>
          <th>Period</th>
          <th>Pay Date</th>
          <th>Employees</th>
          <th>Gross Pay</th>
          <th>Net Pay</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let run of payrollRuns" (click)="openDetailsModal(run)" class="clickable-row" [ngClass]="{'view-details': run.status !== 'DRAFT'}">
          <td class="run-number">{{ run.payrollRunNumber }}</td>
          <td>{{ run.description }}</td>
          <td>{{ run.periodStartDate | date:'MMM d' }} - {{ run.periodEndDate | date:'MMM d, yyyy' }}</td>
          <td>{{ run.payDate | date:'MMM d, yyyy' }}</td>
          <td>{{ run.totalEmployees || 0 }}</td>
          <td class="amount">${{ run.totalGrossPay | number:'1.2-2' }}</td>
          <td class="amount net">${{ run.totalNetPay | number:'1.2-2' }}</td>
          <td>
            <span class="status-badge" [ngClass]="getStatusClass(run.status)">{{ run.status }}</span>
          </td>
          <td class="actions" (click)="$event.stopPropagation()">
            <button class="btn btn-sm btn-primary" *ngIf="canCalculate(run)" 
                    (click)="calculatePayroll(run)" [disabled]="calculating" title="Calculate Payroll">
              <i class="fas fa-calculator"></i> Calculate
            </button>
            <a [routerLink]="['/app/payroll/process', run.id]" class="btn btn-sm btn-secondary" 
               *ngIf="run.status === 'CALCULATED'" title="Review & Process">
              <i class="fas fa-arrow-right"></i> Review
            </a>
            <span *ngIf="run.status === 'PROCESSED'" class="processed-label">
              <i class="fas fa-check-circle"></i> Completed
            </span>
          </td>
        </tr>
        <tr *ngIf="payrollRuns.length === 0">
          <td colspan="9" class="no-data">No payroll runs found. Create one to get started.</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<div class="modal-overlay" *ngIf="showCreateModal" (click)="closeCreateModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Create Payroll Run</h3>
      <button class="close-btn" (click)="closeCreateModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Payroll Run Number *</label>
        <input type="text" [(ngModel)]="newRun.payrollRunNumber" required>
      </div>
      <div class="form-group">
        <label>Description</label>
        <input type="text" [(ngModel)]="newRun.description">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Period Start Date *</label>
          <input type="date" [(ngModel)]="newRun.periodStartDate" required>
        </div>
        <div class="form-group">
          <label>Period End Date *</label>
          <input type="date" [(ngModel)]="newRun.periodEndDate" required>
        </div>
      </div>
      <div class="form-group">
        <label>Pay Date *</label>
        <input type="date" [(ngModel)]="newRun.payDate" required>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeCreateModal()" [disabled]="creating">Cancel</button>
      <button class="btn btn-primary" (click)="createPayrollRun()" [disabled]="creating">
        {{ creating ? 'Creating...' : 'Create Payroll Run' }}
      </button>
    </div>
  </div>
</div>

<app-timesheet-generation-dialog
  [showDialog]="showTimesheetDialog"
  (closeDialog)="closeTimesheetDialog()"
  (timesheetsGenerated)="onTimesheetsGenerated($event)">
</app-timesheet-generation-dialog>

<!-- Payroll Details Modal -->
<div class="payroll-modal-overlay" *ngIf="showDetailsModal" (click)="closeDetailsModal()">
  <div class="payroll-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><i class="fas fa-receipt"></i> Payroll Run Details</h3>
      <button class="close-btn" (click)="closeDetailsModal()"><i class="fas fa-times"></i></button>
    </div>

    <div class="modal-body">
      <!-- Payroll Run Summary -->
      <div *ngIf="selectedRun" class="run-summary">
        <div class="summary-row">
          <span class="label">Payroll Run:</span>
          <span class="value">{{ selectedRun.payrollRunNumber }}</span>
        </div>
        <div class="summary-row">
          <span class="label">Period:</span>
          <span class="value">{{ selectedRun.periodStartDate | date:'MMM d, yyyy' }} - {{ selectedRun.periodEndDate | date:'MMM d, yyyy' }}</span>
        </div>
        <div class="summary-row">
          <span class="label">Pay Date:</span>
          <span class="value">{{ selectedRun.payDate | date:'MMM d, yyyy' }}</span>
        </div>
        <div class="summary-row">
          <span class="label">Status:</span>
          <span class="value"><span class="status-badge" [ngClass]="getStatusClass(selectedRun.status)">{{ selectedRun.status }}</span></span>
        </div>
      </div>

      <!-- Loading State -->
      <div *ngIf="loadingDetails" class="loading-state">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Loading payroll details...</p>
      </div>

      <!-- Employees List -->
      <div *ngIf="!loadingDetails && selectedRunRecords.length > 0" class="employees-section">
        <h4><i class="fas fa-users"></i> Employees ({{ selectedRunRecords.length }})</h4>
        <div class="employees-list">
          <div *ngFor="let record of selectedRunRecords" (click)="openEmployeeDetails(record)" class="employee-card clickable">
            <div class="employee-header">
              <div class="employee-name">{{ getEmployeeName(record) }}</div>
              <div class="employee-code">{{ getEmployeeCode(record) }}</div>
            </div>
            <div class="employee-body">
              <div class="salary-row">
                <span class="salary-label">Gross Pay:</span>
                <span class="salary-amount gross">{{ formatCurrency(record.grossPay || 0) }}</span>
              </div>
              <div class="salary-row">
                <span class="salary-label">Deductions:</span>
                <span class="salary-amount deduction">{{ formatCurrency(record.totalDeductions || 0) }}</span>
              </div>
              <div class="salary-row">
                <span class="salary-label">Taxes:</span>
                <span class="salary-amount tax">{{ formatCurrency(record.totalTaxes || 0) }}</span>
              </div>
              <div class="salary-row highlight">
                <span class="salary-label">Net Pay:</span>
                <span class="salary-amount net">{{ formatCurrency(record.netPay || 0) }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- No Data State -->
      <div *ngIf="!loadingDetails && selectedRunRecords.length === 0" class="empty-state">
        <i class="fas fa-inbox"></i>
        <p>No payroll records found for this run</p>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-close" (click)="closeDetailsModal()">Close</button>
    </div>
  </div>
</div>

<!-- Employee Details Modal -->
<div class="employee-details-overlay" *ngIf="selectedRecord" (click)="closeEmployeeDetails()">
  <div class="employee-details-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><i class="fas fa-receipt"></i> Employee Payroll Details</h3>
      <button class="close-btn" (click)="closeEmployeeDetails()"><i class="fas fa-times"></i></button>
    </div>

    <div class="modal-body">
      <!-- Employee Information -->
      <div class="details-section">
        <h4>Employee Information</h4>
        <div class="details-grid">
          <div class="detail-row">
            <span class="label">Name:</span>
            <span class="value">{{ getEmployeeName(selectedRecord) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Code:</span>
            <span class="value">{{ getEmployeeCode(selectedRecord) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Department:</span>
            <span class="value">{{ getDepartment(selectedRecord) }}</span>
          </div>
        </div>
      </div>

      <!-- Earnings Section -->
      <div class="details-section earnings">
        <h4><i class="fas fa-plus-circle"></i> Earnings</h4>
        <div class="details-grid">
          <div class="detail-row">
            <span class="label">Base Pay:</span>
            <span class="value">{{ formatCurrency(selectedRecord.basePay || 0) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Regular Hours:</span>
            <span class="value">{{ selectedRecord.regularHours || 0 }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Overtime Pay:</span>
            <span class="value">{{ formatCurrency(selectedRecord.overtimePay || 0) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Bonuses:</span>
            <span class="value">{{ formatCurrency(selectedRecord.bonuses || 0) }}</span>
          </div>
          <div class="detail-row highlight">
            <span class="label">Gross Salary:</span>
            <span class="value">{{ formatCurrency(selectedRecord.grossPay || 0) }}</span>
          </div>
        </div>
      </div>

      <!-- Taxes Section -->
      <div class="details-section taxes">
        <h4><i class="fas fa-percent"></i> Taxes</h4>
        <div class="details-grid">
          <div class="detail-row">
            <span class="label">Federal Tax:</span>
            <span class="value tax">{{ formatCurrency(selectedRecord.federalTax || 0) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">State Tax:</span>
            <span class="value tax">{{ formatCurrency(selectedRecord.stateTax || 0) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Social Security:</span>
            <span class="value tax">{{ formatCurrency(selectedRecord.socialSecurityTax || 0) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Medicare:</span>
            <span class="value tax">{{ formatCurrency(selectedRecord.medicareTax || 0) }}</span>
          </div>
          <div class="detail-row highlight">
            <span class="label">Total Taxes:</span>
            <span class="value tax">{{ formatCurrency(selectedRecord.totalTaxes || 0) }}</span>
          </div>
        </div>
      </div>

      <!-- Deductions Section -->
      <div class="details-section deductions">
        <h4><i class="fas fa-minus-circle"></i> Deductions</h4>
        <div class="details-grid">
          <div class="detail-row">
            <span class="label">Health Insurance:</span>
            <span class="value">{{ formatCurrency(selectedRecord.healthInsurance || 0) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Dental Insurance:</span>
            <span class="value">{{ formatCurrency(selectedRecord.dentalInsurance || 0) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">401(k):</span>
            <span class="value">{{ formatCurrency(selectedRecord.retirement401k || 0) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Pre-Tax Deductions:</span>
            <span class="value">{{ formatCurrency(selectedRecord.preTaxDeductions || 0) }}</span>
          </div>
          <div class="detail-row highlight">
            <span class="label">Total Deductions:</span>
            <span class="value">{{ formatCurrency(selectedRecord.totalDeductions || 0) }}</span>
          </div>
        </div>
      </div>

      <!-- Net Pay Section -->
      <div class="details-section net-pay">
        <h4><i class="fas fa-wallet"></i> Net Pay</h4>
        <div class="net-pay-display">
          <span class="net-pay-amount">{{ formatCurrency(selectedRecord.netPay || 0) }}</span>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-close" (click)="closeEmployeeDetails()">Close</button>
      </div>
    </div>
  </div>
</div>
