<div class="ess-container">
  <div class="page-header">
    <h2>Employee Self-Service Portal</h2>
  </div>

  <div class="tabs">
    <button class="tab" [class.active]="activeTab === 'paystubs'" (click)="activeTab = 'paystubs'">
      <i class="fas fa-file-invoice-dollar"></i> Pay Stubs
    </button>
    <button class="tab" [class.active]="activeTab === 'attendance'" (click)="activeTab = 'attendance'">
      <i class="fas fa-clock"></i> Attendance
    </button>
    <button class="tab" [class.active]="activeTab === 'leave'" (click)="activeTab = 'leave'">
      <i class="fas fa-calendar-alt"></i> Leave
    </button>
    <button class="tab" [class.active]="activeTab === 'loans'" (click)="activeTab = 'loans'">
      <i class="fas fa-money-check-alt"></i> Loans
    </button>
    <button class="tab" [class.active]="activeTab === 'expenses'" (click)="activeTab = 'expenses'">
      <i class="fas fa-receipt"></i> Expenses
    </button>
    <button class="tab" [class.active]="activeTab === 'documents'" (click)="activeTab = 'documents'">
      <i class="fas fa-folder-open"></i> Documents
    </button>
    <button class="tab" [class.active]="activeTab === 'assets'" (click)="activeTab = 'assets'">
      <i class="fas fa-laptop"></i> Assets
    </button>
    <button class="tab" [class.active]="activeTab === 'policies'" (click)="activeTab = 'policies'">
      <i class="fas fa-book"></i> Policies
    </button>
  </div>

  <div class="tab-content" *ngIf="activeTab === 'paystubs'">
    <div class="section-header">
      <h3>My Pay Stubs</h3>
    </div>
    <div class="paystubs-grid">
      <div class="paystub-card" *ngFor="let ps of paystubs" (click)="viewPaystub(ps)">
        <div class="card-header">
          <span class="period">{{ getPayPeriod(ps) }}</span>
          <span class="pay-date">Paid: {{ getPayDate(ps) }}</span>
        </div>
        <div class="card-body">
          <div class="amount-row">
            <span class="label">Gross Pay</span>
            <span class="amount">${{ ps.grossPay | number:'1.2-2' }}</span>
          </div>
          <div class="amount-row">
            <span class="label">Deductions</span>
            <span class="amount deduction">-${{ ps.totalDeductions | number:'1.2-2' }}</span>
          </div>
          <div class="amount-row net">
            <span class="label">Net Pay</span>
            <span class="amount">${{ ps.netPay | number:'1.2-2' }}</span>
          </div>
        </div>
        <div class="card-footer">
          <button class="btn-link" (click)="downloadPaystub(ps); $event.stopPropagation()">
            <i class="fas fa-download"></i> Download
          </button>
        </div>
      </div>
      <div class="no-data" *ngIf="paystubs.length === 0">
        <i class="fas fa-file-invoice"></i>
        <p>No pay stubs available</p>
      </div>
    </div>
  </div>

  <div class="tab-content" *ngIf="activeTab === 'leave'">
    <div class="section-header">
      <h3>Leave Balance</h3>
    </div>
    <div class="leave-balance-grid" *ngIf="leaveBalances.length > 0">
      <div class="leave-card" *ngFor="let balance of leaveBalances" [ngClass]="getLeaveTypeClass(balance.leaveType?.name)">
        <div class="leave-card-header">
          <div class="leave-icon">
            <i [class]="getLeaveTypeIcon(balance.leaveType?.name)"></i>
          </div>
          <div class="leave-type-name">{{ balance.leaveType?.name || 'Leave' }}</div>
        </div>
        <div class="leave-card-body">
          <div class="available-days">
            <span class="days-number">{{ getAvailableBalance(balance) }}</span>
            <span class="days-label">Available</span>
          </div>
          <div class="balance-progress">
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="getBalancePercentage(balance)"></div>
            </div>
            <div class="progress-text">{{ getAvailableBalance(balance) }} of {{ getTotalEntitlement(balance) }} days</div>
          </div>
          <div class="leave-stats">
            <div class="stat">
              <span class="stat-value">{{ balance.used || 0 }}</span>
              <span class="stat-label">Used</span>
            </div>
            <div class="stat pending">
              <span class="stat-value">{{ balance.pending || 0 }}</span>
              <span class="stat-label">Pending</span>
            </div>
            <div class="stat total">
              <span class="stat-value">{{ getTotalEntitlement(balance) }}</span>
              <span class="stat-label">Total</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="no-data small" *ngIf="leaveBalances.length === 0">
      <p>No leave balances available. Please contact HR to set up your leave entitlements.</p>
    </div>

    <div class="section-header">
      <h3>Leave Requests</h3>
      <button class="btn btn-primary" (click)="openLeaveRequestModal()">
        <i class="fas fa-plus"></i> Request Leave
      </button>
    </div>
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>Leave Type</th>
            <th>Start Date</th>
            <th>End Date</th>
            <th>Days</th>
            <th>Status</th>
            <th>Reason</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let req of leaveRequests">
            <td>{{ req.leaveType?.name || 'N/A' }}</td>
            <td>{{ req.startDate | date:'MMM d, yyyy' }}</td>
            <td>{{ req.endDate | date:'MMM d, yyyy' }}</td>
            <td>{{ getLeaveDays(req) }}</td>
            <td>
              <span class="status-badge" [ngClass]="getStatusClass(req.status || 'PENDING')">{{ req.status }}</span>
            </td>
            <td>{{ req.reason }}</td>
          </tr>
          <tr *ngIf="leaveRequests.length === 0">
            <td colspan="6" class="no-data-row">No leave requests found</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="tab-content" *ngIf="activeTab === 'attendance'">
    <div class="section-header">
      <h3>Attendance Summary - {{ attendanceSummary.currentMonth }}</h3>
    </div>
    <div class="summary-cards">
      <div class="summary-card present">
        <div class="card-icon"><i class="fas fa-check-circle"></i></div>
        <div class="card-info">
          <span class="label">Present Days</span>
          <span class="value">{{ attendanceSummary.presentDays }}</span>
        </div>
      </div>
      <div class="summary-card absent">
        <div class="card-icon"><i class="fas fa-times-circle"></i></div>
        <div class="card-info">
          <span class="label">Absent Days</span>
          <span class="value">{{ attendanceSummary.absentDays }}</span>
        </div>
      </div>
      <div class="summary-card late">
        <div class="card-icon"><i class="fas fa-clock"></i></div>
        <div class="card-info">
          <span class="label">Late Arrivals</span>
          <span class="value">{{ attendanceSummary.lateDays }}</span>
        </div>
      </div>
      <div class="summary-card hours">
        <div class="card-icon"><i class="fas fa-business-time"></i></div>
        <div class="card-info">
          <span class="label">Total Hours</span>
          <span class="value">{{ attendanceSummary.totalWorkingHours | number:'1.1-1' }}h</span>
        </div>
      </div>
      <div class="summary-card overtime">
        <div class="card-icon"><i class="fas fa-hourglass-half"></i></div>
        <div class="card-info">
          <span class="label">Overtime Hours</span>
          <span class="value">{{ attendanceSummary.overtimeHours | number:'1.1-1' }}h</span>
        </div>
      </div>
    </div>

    <div class="section-header" style="margin-top: 24px;">
      <h3>Attendance Records</h3>
    </div>
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Clock In</th>
            <th>Clock Out</th>
            <th>Hours</th>
            <th>Status</th>
            <th>Remarks</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let record of attendanceRecords">
            <td>{{ record.attendanceDate | date:'MMM d, yyyy' }}</td>
            <td>{{ record.clockIn || 'N/A' }}</td>
            <td>{{ record.clockOut || 'N/A' }}</td>
            <td>{{ record.regularHours || 0 }}h</td>
            <td>
              <span class="status-badge" [ngClass]="getStatusClass(getAttendanceStatusBadge(record))">
                {{ getAttendanceStatusBadge(record) }}
              </span>
            </td>
            <td>{{ record.remarks || '-' }}</td>
          </tr>
          <tr *ngIf="attendanceRecords.length === 0">
            <td colspan="6" class="no-data-row">No attendance records found</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="tab-content" *ngIf="activeTab === 'loans'">
    <div class="section-header">
      <h3>My Loans & Advances</h3>
      <button class="btn btn-primary" (click)="openLoanRequestModal()">
        <i class="fas fa-plus"></i> Apply for Loan
      </button>
    </div>
    <div class="cards-grid">
      <div class="card" *ngFor="let loan of loans">
        <div class="card-header">
          <span class="label">{{ loan.loanType }}</span>
          <span class="status-badge" [ngClass]="getLoanStatusClass(loan.status)">{{ loan.status }}</span>
        </div>
        <div class="card-body">
          <div class="detail-row">
            <span>Loan Amount</span>
            <span class="amount">${{ loan.loanAmount | number:'1.2-2' }}</span>
          </div>
          <div class="detail-row">
            <span>Approved Amount</span>
            <span class="amount">${{ loan.approvedAmount | number:'1.2-2' }}</span>
          </div>
          <div class="detail-row">
            <span>Outstanding</span>
            <span class="amount">${{ (loan.approvedAmount - (loan.paidAmount || 0)) | number:'1.2-2' }}</span>
          </div>
          <div class="detail-row">
            <span>No. of EMIs</span>
            <span>{{ loan.numberOfEmi }}</span>
          </div>
        </div>
      </div>
      <div class="no-data" *ngIf="loans.length === 0">
        <i class="fas fa-info-circle"></i>
        <p>No loans found</p>
      </div>
    </div>
  </div>

  <div class="tab-content" *ngIf="activeTab === 'expenses'">
    <div class="section-header">
      <h3>My Expense Requests</h3>
      <button class="btn btn-primary" (click)="openExpenseRequestModal()">
        <i class="fas fa-plus"></i> Submit Expense
      </button>
    </div>

    <div class="expense-categories-section" *ngIf="expenseCategories.length > 0">
      <h4 class="subsection-title"><i class="fas fa-tags"></i> Expense Categories</h4>
      <div class="expense-categories-grid">
        <div class="expense-category-card" *ngFor="let category of expenseCategories" [class.inactive]="!category.active">
          <div class="category-icon" [style.background]="getCategoryColor(category.code)">
            <i class="fas" [ngClass]="getCategoryIcon(category.code)"></i>
          </div>
          <div class="category-info">
            <span class="category-name">{{ category.name }}</span>
            <span class="category-desc">{{ category.description || 'No description' }}</span>
            <span class="category-limit" *ngIf="category.maxAmount">Max: ${{ category.maxAmount | number:'1.0-0' }}</span>
          </div>
          <span class="category-status" [class.active]="category.active" [class.inactive]="!category.active">
            {{ category.active ? 'Active' : 'Inactive' }}
          </span>
        </div>
      </div>
    </div>

    <h4 class="subsection-title" style="margin-top: 24px;"><i class="fas fa-file-invoice-dollar"></i> My Expense Requests</h4>
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Category</th>
            <th>Receipt #</th>
            <th>Attachment</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Approved Amount</th>
            <th>Remarks</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let expense of expenses">
            <td>{{ expense.createdAt | date:'MMM d, yyyy' }}</td>
            <td>{{ expense.category?.name || 'N/A' }}</td>
            <td>{{ expense.receiptNumber || '-' }}</td>
            <td>
              <div class="attachment-cell" *ngIf="expense.receiptUrl">
                <img *ngIf="expense.receiptUrl?.startsWith('data:image')" 
                     [src]="expense.receiptUrl" 
                     class="receipt-thumbnail" 
                     alt="Receipt"
                     (click)="openReceiptPreview(expense.receiptUrl)"
                     title="Click to preview">
                <a *ngIf="expense.receiptUrl?.startsWith('data:application/pdf')" 
                   [href]="expense.receiptUrl" 
                   target="_blank"
                   class="pdf-link"
                   title="Click to open PDF">
                  <i class="fas fa-file-pdf"></i>
                </a>
              </div>
              <span *ngIf="!expense.receiptUrl" class="no-attachment">-</span>
            </td>
            <td>${{ expense.totalAmount | number:'1.2-2' }}</td>
            <td>
              <span class="status-badge" [ngClass]="getExpenseStatusClass(expense.status)">
                {{ expense.status }}
              </span>
            </td>
            <td>${{ expense.approvedAmount | number:'1.2-2' }}</td>
            <td>{{ expense.remarks || '-' }}</td>
          </tr>
          <tr *ngIf="expenses.length === 0">
            <td colspan="8" class="no-data-row">No expense requests found</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="tab-content" *ngIf="activeTab === 'documents'">
    <div class="section-header">
      <h3>Document Checklist</h3>
    </div>
    
    <div class="summary-cards" style="margin-bottom: 24px;">
      <div class="summary-card">
        <div class="card-icon" style="background: #008080;"><i class="fas fa-file-alt"></i></div>
        <div class="card-info">
          <span class="label">Total Required</span>
          <span class="value">{{ getTotalDocuments() }}</span>
        </div>
      </div>
      <div class="summary-card">
        <div class="card-icon" style="background: #28a745;"><i class="fas fa-check-circle"></i></div>
        <div class="card-info">
          <span class="label">Uploaded</span>
          <span class="value">{{ getTotalUploaded() }}</span>
        </div>
      </div>
      <div class="summary-card">
        <div class="card-icon" style="background: #ffc107;"><i class="fas fa-clock"></i></div>
        <div class="card-info">
          <span class="label">Pending</span>
          <span class="value">{{ getTotalDocuments() - getTotalUploaded() }}</span>
        </div>
      </div>
      <div class="summary-card">
        <div class="card-icon" style="background: #17a2b8;"><i class="fas fa-percentage"></i></div>
        <div class="card-info">
          <span class="label">Completion</span>
          <span class="value">{{ getTotalDocuments() > 0 ? ((getTotalUploaded() / getTotalDocuments()) * 100 | number:'1.0-0') : 0 }}%</span>
        </div>
      </div>
    </div>

    <div class="info-card" style="margin-bottom: 20px;">
      <i class="fas fa-info-circle"></i>
      <p>Upload your required documents. Documents marked with * are mandatory. Contact HR if you need assistance.</p>
    </div>

    <div class="document-checklist">
      <div class="category-section" *ngFor="let category of documentChecklist" [ngClass]="getCategoryColorClass(category.code)">
        <div class="category-header">
          <div class="category-title">
            <span class="category-icon" [ngSwitch]="category.code">
              <i *ngSwitchCase="'ID_WORK_AUTH'" class="fas fa-id-card"></i>
              <i *ngSwitchCase="'TAX_PAYROLL'" class="fas fa-file-invoice-dollar"></i>
              <i *ngSwitchCase="'EMPLOYMENT_HR'" class="fas fa-file-contract"></i>
              <i *ngSwitchCase="'FEDERAL_COMPLIANCE'" class="fas fa-flag-usa"></i>
              <i *ngSwitchCase="'CERTIFICATIONS'" class="fas fa-certificate"></i>
              <i *ngSwitchCase="'OTHER_DOCS'" class="fas fa-folder"></i>
              <i *ngSwitchDefault class="fas fa-file"></i>
            </span>
            <h4>{{ category.name }}</h4>
          </div>
          <div class="category-progress">
            <span class="progress-text">{{ category.uploadedDocuments }}/{{ category.totalDocuments }}</span>
            <div class="progress-bar-small">
              <div class="progress-fill" [style.width.%]="category.totalDocuments > 0 ? (category.uploadedDocuments / category.totalDocuments) * 100 : 0"></div>
            </div>
          </div>
        </div>
        <div class="category-documents">
          <div class="document-item" *ngFor="let doc of category.documentTypes" [class.uploaded]="doc.status === 'UPLOADED'" [class.pending]="doc.status === 'PENDING'">
            <div class="document-checkbox">
              <i *ngIf="doc.status === 'UPLOADED'" class="fas fa-check-circle text-success"></i>
              <i *ngIf="doc.status === 'PENDING'" class="far fa-circle text-muted"></i>
            </div>
            <div class="document-info">
              <span class="document-name">
                {{ doc.name }}
                <span class="mandatory-mark" *ngIf="doc.isMandatory">*</span>
              </span>
              <span class="document-description" *ngIf="doc.description">{{ doc.description }}</span>
              <span class="document-meta" *ngIf="doc.status === 'UPLOADED'">
                <span *ngIf="doc.uploadedAt">Uploaded: {{ doc.uploadedAt | date:'MMM d, yyyy' }}</span>
                <span *ngIf="doc.expiryDate"> | Expires: {{ doc.expiryDate | date:'MMM d, yyyy' }}</span>
                <span class="verification-status" [ngClass]="getDocumentStatusClass(doc.verificationStatus || 'PENDING')">
                  {{ doc.verificationStatus || 'PENDING' }}
                </span>
              </span>
            </div>
            <div class="document-action">
              <button *ngIf="doc.status === 'UPLOADED' && doc.fileUrl" class="btn btn-sm btn-success" (click)="downloadDocument(doc)">
                <i class="fas fa-download"></i> Download
              </button>
              <span *ngIf="doc.status === 'PENDING'" class="status-badge pending">
                <i class="fas fa-clock"></i> Pending
              </span>
            </div>
          </div>
        </div>
      </div>

      <div class="no-data" *ngIf="documentChecklist.length === 0">
        <i class="fas fa-file-alt"></i>
        <p>No document types configured. Please contact HR to set up the document requirements.</p>
      </div>
    </div>
  </div>

  <div class="tab-content" *ngIf="activeTab === 'assets'">
    <div class="section-header">
      <h3>My Assigned Assets</h3>
    </div>
    <div class="cards-grid">
      <div class="card asset-card" *ngFor="let asset of assets">
        <div class="card-header">
          <span class="asset-type">{{ asset.assetType }}</span>
          <span class="status-badge" [ngClass]="getAssetStatusClass(asset.approvalStatus)">
            {{ asset.approvalStatus }}
          </span>
        </div>
        <div class="card-body">
          <h4 class="asset-name">{{ asset.assetName }}</h4>
          <div class="detail-row" *ngIf="asset.assetCode">
            <span>Asset Code</span>
            <span>{{ asset.assetCode }}</span>
          </div>
          <div class="detail-row" *ngIf="asset.serialNumber">
            <span>Serial Number</span>
            <span>{{ asset.serialNumber }}</span>
          </div>
          <div class="detail-row" *ngIf="asset.issueDate">
            <span>Issue Date</span>
            <span>{{ asset.issueDate | date:'MMM d, yyyy' }}</span>
          </div>
          <div class="detail-row" *ngIf="asset.condition">
            <span>Condition</span>
            <span>{{ asset.condition }}</span>
          </div>
          <div class="detail-row" *ngIf="asset.remarks">
            <span>Remarks</span>
            <span>{{ asset.remarks }}</span>
          </div>
        </div>
      </div>
      <div class="no-data" *ngIf="assets.length === 0">
        <i class="fas fa-laptop"></i>
        <p>No assets assigned to you</p>
      </div>
    </div>
  </div>

  <div class="tab-content" *ngIf="activeTab === 'policies'">
    <div class="section-header">
      <h3>HR Policies & Documents</h3>
    </div>
    <div class="info-card" style="margin-bottom: 20px;">
      <i class="fas fa-info-circle"></i>
      <p>Review company policies and HR documents. Contact HR for any clarifications or questions.</p>
    </div>
    <div class="policies-grid">
      <div class="policy-card" *ngFor="let policy of policies">
        <div class="policy-icon">
          <i class="fas" [ngClass]="{
            'fa-calendar-alt': policy.category === 'HR',
            'fa-dollar-sign': policy.category === 'Finance',
            'fa-shield-alt': policy.category === 'IT'
          }"></i>
        </div>
        <div class="policy-info">
          <h4>{{ policy.title }}</h4>
          <p class="description">{{ policy.description }}</p>
          <div class="policy-meta">
            <span class="category-badge" [ngClass]="policy.category.toLowerCase()">{{ policy.category }}</span>
            <span class="updated">Updated: {{ policy.updatedAt | date:'MMM d, yyyy' }}</span>
          </div>
        </div>
        <button class="btn btn-outline-primary btn-sm">
          <i class="fas fa-eye"></i> View
        </button>
      </div>
      <div class="no-data" *ngIf="policies.length === 0">
        <i class="fas fa-book"></i>
        <p>No policies available</p>
      </div>
    </div>
  </div>
</div>

<app-payslip
  [showModal]="showPaystubModal"
  [payslipData]="payslipData"
  [companyName]="companyName"
  [companyAddress]="companyAddress"
  (closeModal)="closePaystubModal()"
  (downloadPayslip)="downloadPaystub(selectedPaystub!)"
  (printPayslip)="printPaystub(selectedPaystub!)">
</app-payslip>

<div class="modal-overlay" *ngIf="showLeaveRequestModal" (click)="closeLeaveRequestModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Submit Leave Request</h3>
      <button class="close-btn" (click)="closeLeaveRequestModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Leave Type *</label>
        <select [(ngModel)]="newLeaveRequest.leaveTypeId">
          <option *ngFor="let type of leaveTypes" [value]="type.id">{{ type.name }}</option>
        </select>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Start Date *</label>
          <input type="date" [(ngModel)]="newLeaveRequest.startDate" required>
        </div>
        <div class="form-group">
          <label>End Date *</label>
          <input type="date" [(ngModel)]="newLeaveRequest.endDate" required>
        </div>
      </div>
      <div class="form-group">
        <label>Reason</label>
        <textarea [(ngModel)]="newLeaveRequest.reason" rows="3"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeLeaveRequestModal()" [disabled]="submittingLeave">Cancel</button>
      <button class="btn btn-primary" (click)="submitLeaveRequest()" [disabled]="submittingLeave">
        <span *ngIf="!submittingLeave">Submit Request</span>
        <span *ngIf="submittingLeave">Submitting...</span>
      </button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showExpenseRequestModal" (click)="closeExpenseRequestModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Submit Expense Request</h3>
      <button class="close-btn" (click)="closeExpenseRequestModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Expense Category *</label>
        <select [(ngModel)]="newExpenseRequest.categoryId">
          <option *ngFor="let cat of expenseCategories" [value]="cat.id">{{ cat.name }}</option>
        </select>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Expense Date *</label>
          <input type="date" [(ngModel)]="newExpenseRequest.expenseDate" required>
        </div>
        <div class="form-group">
          <label>Amount ($) *</label>
          <input type="number" [(ngModel)]="newExpenseRequest.amount" min="0" step="0.01" required>
        </div>
      </div>
      <div class="form-group">
        <label>Receipt Number</label>
        <input type="text" [(ngModel)]="newExpenseRequest.receiptNumber" placeholder="Optional">
      </div>
      <div class="form-group">
        <label>Attach Receipt</label>
        <div class="file-upload-container">
          <input type="file" 
                 id="receiptFile" 
                 (change)="onReceiptFileSelected($event)" 
                 accept="image/*,.pdf"
                 style="display: none;">
          <label for="receiptFile" class="file-upload-btn" *ngIf="!newExpenseRequest.receiptFile">
            <i class="fas fa-cloud-upload-alt"></i> Choose File
          </label>
          <div class="file-selected" *ngIf="newExpenseRequest.receiptFile">
            <span class="file-name">{{ newExpenseRequest.receiptFile.name }}</span>
            <button type="button" class="remove-file-btn" (click)="removeReceiptFile()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        <div class="receipt-preview" *ngIf="newExpenseRequest.receiptPreview">
          <img *ngIf="newExpenseRequest.receiptPreview.startsWith('data:image')" 
               [src]="newExpenseRequest.receiptPreview" 
               alt="Receipt preview">
          <div *ngIf="newExpenseRequest.receiptPreview.startsWith('data:application/pdf')" class="pdf-preview">
            <i class="fas fa-file-pdf"></i>
            <span>PDF Ready</span>
          </div>
        </div>
        <small class="help-text">Max 500KB. Supported: JPEG, PNG, GIF, PDF</small>
      </div>
      <div class="form-group">
        <label>Description *</label>
        <textarea [(ngModel)]="newExpenseRequest.description" rows="3" placeholder="Describe the expense..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeExpenseRequestModal()" [disabled]="submittingExpense">Cancel</button>
      <button class="btn btn-primary" (click)="submitExpenseRequest()" [disabled]="submittingExpense">
        <span *ngIf="!submittingExpense">Submit Expense</span>
        <span *ngIf="submittingExpense">Submitting...</span>
      </button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showReceiptPreviewModal" (click)="closeReceiptPreview()">
  <div class="modal receipt-preview-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Receipt Preview</h3>
      <button class="close-btn" (click)="closeReceiptPreview()">&times;</button>
    </div>
    <div class="modal-body">
      <img [src]="selectedReceiptUrl" alt="Receipt" class="full-receipt-image">
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showLoanRequestModal" (click)="closeLoanRequestModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Apply for Loan/Advance</h3>
      <button class="close-btn" (click)="closeLoanRequestModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Loan Type *</label>
        <select [(ngModel)]="newLoanRequest.loanType">
          <option *ngFor="let type of loanTypes" [value]="type">{{ type.replace('_', ' ') }}</option>
        </select>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Loan Amount ($) *</label>
          <input type="number" [(ngModel)]="newLoanRequest.amount" min="0" step="100" required>
        </div>
        <div class="form-group">
          <label>Number of EMIs *</label>
          <select [(ngModel)]="newLoanRequest.numberOfEmi">
            <option [value]="3">3 Months</option>
            <option [value]="6">6 Months</option>
            <option [value]="12">12 Months</option>
            <option [value]="18">18 Months</option>
            <option [value]="24">24 Months</option>
          </select>
        </div>
      </div>
      <div class="emi-preview" *ngIf="newLoanRequest.amount > 0">
        <span class="label">Estimated Monthly EMI:</span>
        <span class="amount">${{ getEmiAmount() | number:'1.2-2' }}</span>
      </div>
      <div class="form-group">
        <label>Reason for Loan *</label>
        <textarea [(ngModel)]="newLoanRequest.reason" rows="3" placeholder="Explain why you need this loan..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeLoanRequestModal()" [disabled]="submittingLoan">Cancel</button>
      <button class="btn btn-primary" (click)="submitLoanRequest()" [disabled]="submittingLoan">
        <span *ngIf="!submittingLoan">Submit Application</span>
        <span *ngIf="submittingLoan">Submitting...</span>
      </button>
    </div>
  </div>
</div>
