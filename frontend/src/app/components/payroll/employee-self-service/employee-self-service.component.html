<div class="ess-container">
  <div class="page-header">
    <h2>Employee Self-Service Portal</h2>
  </div>

  <div class="tabs">
    <button class="tab" [class.active]="activeTab === 'paystubs'" (click)="activeTab = 'paystubs'">
      <i class="fas fa-file-invoice-dollar"></i> Pay Stubs
    </button>
    <button class="tab" [class.active]="activeTab === 'attendance'" (click)="activeTab = 'attendance'">
      <i class="fas fa-clock"></i> Attendance
    </button>
    <button class="tab" [class.active]="activeTab === 'leave'" (click)="activeTab = 'leave'">
      <i class="fas fa-calendar-alt"></i> Leave
    </button>
    <button class="tab" [class.active]="activeTab === 'loans'" (click)="activeTab = 'loans'">
      <i class="fas fa-money-check-alt"></i> Loans
    </button>
    <button class="tab" [class.active]="activeTab === 'expenses'" (click)="activeTab = 'expenses'">
      <i class="fas fa-receipt"></i> Expenses
    </button>
    <button class="tab" [class.active]="activeTab === 'documents'" (click)="activeTab = 'documents'">
      <i class="fas fa-folder-open"></i> Documents
    </button>
    <button class="tab" [class.active]="activeTab === 'assets'" (click)="activeTab = 'assets'">
      <i class="fas fa-laptop"></i> Assets
    </button>
    <button class="tab" [class.active]="activeTab === 'policies'" (click)="activeTab = 'policies'">
      <i class="fas fa-book"></i> Policies
    </button>
  </div>

  <div class="tab-content" *ngIf="activeTab === 'paystubs'">
    <div class="section-header">
      <h3>My Pay Stubs</h3>
    </div>
    <div class="paystubs-grid">
      <div class="paystub-card" *ngFor="let ps of paystubs" (click)="viewPaystub(ps)">
        <div class="card-header">
          <span class="period">{{ getPayPeriod(ps) }}</span>
          <span class="pay-date">Paid: {{ getPayDate(ps) }}</span>
        </div>
        <div class="card-body">
          <div class="amount-row">
            <span class="label">Gross Pay</span>
            <span class="amount">${{ ps.grossPay | number:'1.2-2' }}</span>
          </div>
          <div class="amount-row">
            <span class="label">Deductions</span>
            <span class="amount deduction">-${{ ps.totalDeductions | number:'1.2-2' }}</span>
          </div>
          <div class="amount-row net">
            <span class="label">Net Pay</span>
            <span class="amount">${{ ps.netPay | number:'1.2-2' }}</span>
          </div>
        </div>
        <div class="card-footer">
          <button class="btn-link" (click)="downloadPaystub(ps); $event.stopPropagation()">
            <i class="fas fa-download"></i> Download
          </button>
        </div>
      </div>
      <div class="no-data" *ngIf="paystubs.length === 0">
        <i class="fas fa-file-invoice"></i>
        <p>No pay stubs available</p>
      </div>
    </div>
  </div>

  <div class="tab-content" *ngIf="activeTab === 'leave'">
    <div class="section-header">
      <h3>Leave Balance</h3>
    </div>
    <div class="balance-cards">
      <div class="balance-card" *ngFor="let balance of leaveBalances">
        <div class="balance-type">{{ balance.leaveType?.name || 'Leave' }}</div>
        <div class="balance-value">
          <span class="available">{{ balance.availableBalance || 0 }}</span>
          <span class="total">/ {{ getTotalEntitlement(balance) }} days</span>
        </div>
        <div class="balance-bar">
          <div class="bar-fill" [style.width.%]="getBalancePercentage(balance)"></div>
        </div>
      </div>
      <div class="no-data small" *ngIf="leaveBalances.length === 0">
        <p>No leave balances available</p>
      </div>
    </div>

    <div class="section-header">
      <h3>Leave Requests</h3>
      <button class="btn btn-primary" (click)="openLeaveRequestModal()">
        <i class="fas fa-plus"></i> Request Leave
      </button>
    </div>
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>Leave Type</th>
            <th>Start Date</th>
            <th>End Date</th>
            <th>Days</th>
            <th>Status</th>
            <th>Reason</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let req of leaveRequests">
            <td>{{ req.leaveType?.name || 'N/A' }}</td>
            <td>{{ req.startDate | date:'MMM d, yyyy' }}</td>
            <td>{{ req.endDate | date:'MMM d, yyyy' }}</td>
            <td>{{ getLeaveDays(req) }}</td>
            <td>
              <span class="status-badge" [ngClass]="getStatusClass(req.status || 'PENDING')">{{ req.status }}</span>
            </td>
            <td>{{ req.reason }}</td>
          </tr>
          <tr *ngIf="leaveRequests.length === 0">
            <td colspan="6" class="no-data-row">No leave requests found</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="tab-content" *ngIf="activeTab === 'attendance'">
    <div class="section-header">
      <h3>Attendance Summary - {{ attendanceSummary.currentMonth }}</h3>
    </div>
    <div class="summary-cards">
      <div class="summary-card present">
        <div class="card-icon"><i class="fas fa-check-circle"></i></div>
        <div class="card-info">
          <span class="label">Present Days</span>
          <span class="value">{{ attendanceSummary.presentDays }}</span>
        </div>
      </div>
      <div class="summary-card absent">
        <div class="card-icon"><i class="fas fa-times-circle"></i></div>
        <div class="card-info">
          <span class="label">Absent Days</span>
          <span class="value">{{ attendanceSummary.absentDays }}</span>
        </div>
      </div>
      <div class="summary-card late">
        <div class="card-icon"><i class="fas fa-clock"></i></div>
        <div class="card-info">
          <span class="label">Late Arrivals</span>
          <span class="value">{{ attendanceSummary.lateDays }}</span>
        </div>
      </div>
      <div class="summary-card hours">
        <div class="card-icon"><i class="fas fa-business-time"></i></div>
        <div class="card-info">
          <span class="label">Total Hours</span>
          <span class="value">{{ attendanceSummary.totalWorkingHours | number:'1.1-1' }}h</span>
        </div>
      </div>
      <div class="summary-card overtime">
        <div class="card-icon"><i class="fas fa-hourglass-half"></i></div>
        <div class="card-info">
          <span class="label">Overtime Hours</span>
          <span class="value">{{ attendanceSummary.overtimeHours | number:'1.1-1' }}h</span>
        </div>
      </div>
    </div>

    <div class="section-header" style="margin-top: 24px;">
      <h3>Attendance Records</h3>
    </div>
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Clock In</th>
            <th>Clock Out</th>
            <th>Hours</th>
            <th>Status</th>
            <th>Remarks</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let record of attendanceRecords">
            <td>{{ record.attendanceDate | date:'MMM d, yyyy' }}</td>
            <td>{{ record.clockIn || 'N/A' }}</td>
            <td>{{ record.clockOut || 'N/A' }}</td>
            <td>{{ record.regularHours || 0 }}h</td>
            <td>
              <span class="status-badge" [ngClass]="getStatusClass(getAttendanceStatusBadge(record))">
                {{ getAttendanceStatusBadge(record) }}
              </span>
            </td>
            <td>{{ record.remarks || '-' }}</td>
          </tr>
          <tr *ngIf="attendanceRecords.length === 0">
            <td colspan="6" class="no-data-row">No attendance records found</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="tab-content" *ngIf="activeTab === 'loans'">
    <div class="section-header">
      <h3>My Loans & Advances</h3>
      <button class="btn btn-primary" (click)="openLoanRequestModal()">
        <i class="fas fa-plus"></i> Apply for Loan
      </button>
    </div>
    <div class="cards-grid">
      <div class="card" *ngFor="let loan of loans">
        <div class="card-header">
          <span class="label">{{ loan.loanType }}</span>
          <span class="status-badge" [ngClass]="getLoanStatusClass(loan.status)">{{ loan.status }}</span>
        </div>
        <div class="card-body">
          <div class="detail-row">
            <span>Loan Amount</span>
            <span class="amount">${{ loan.loanAmount | number:'1.2-2' }}</span>
          </div>
          <div class="detail-row">
            <span>Approved Amount</span>
            <span class="amount">${{ loan.approvedAmount | number:'1.2-2' }}</span>
          </div>
          <div class="detail-row">
            <span>Outstanding</span>
            <span class="amount">${{ (loan.approvedAmount - (loan.paidAmount || 0)) | number:'1.2-2' }}</span>
          </div>
          <div class="detail-row">
            <span>No. of EMIs</span>
            <span>{{ loan.numberOfEmi }}</span>
          </div>
        </div>
      </div>
      <div class="no-data" *ngIf="loans.length === 0">
        <i class="fas fa-info-circle"></i>
        <p>No loans found</p>
      </div>
    </div>
  </div>

  <div class="tab-content" *ngIf="activeTab === 'expenses'">
    <div class="section-header">
      <h3>My Expense Requests</h3>
      <button class="btn btn-primary" (click)="openExpenseRequestModal()">
        <i class="fas fa-plus"></i> Submit Expense
      </button>
    </div>
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Category</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Approved Amount</th>
            <th>Remarks</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let expense of expenses">
            <td>{{ expense.createdAt | date:'MMM d, yyyy' }}</td>
            <td>{{ expense.category?.name || 'N/A' }}</td>
            <td>${{ expense.totalAmount | number:'1.2-2' }}</td>
            <td>
              <span class="status-badge" [ngClass]="getExpenseStatusClass(expense.status)">
                {{ expense.status }}
              </span>
            </td>
            <td>${{ expense.approvedAmount | number:'1.2-2' }}</td>
            <td>{{ expense.remarks || '-' }}</td>
          </tr>
          <tr *ngIf="expenses.length === 0">
            <td colspan="6" class="no-data-row">No expense requests found</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="tab-content" *ngIf="activeTab === 'documents'">
    <div class="section-header">
      <h3>My Documents</h3>
    </div>
    <div class="info-card" style="margin-bottom: 20px;">
      <i class="fas fa-info-circle"></i>
      <p>View your uploaded documents and their verification status. Contact HR to upload new documents or request updates.</p>
    </div>
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>Document Type</th>
            <th>Document Number</th>
            <th>Issue Date</th>
            <th>Expiry Date</th>
            <th>Status</th>
            <th>Uploaded</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let doc of documents" [class.expiring]="isDocumentExpiring(doc)" [class.expired]="isDocumentExpired(doc)">
            <td>{{ doc.documentType?.name || 'N/A' }}</td>
            <td>{{ doc.documentNumber || '-' }}</td>
            <td>{{ doc.issueDate | date:'MMM d, yyyy' }}</td>
            <td>
              <span [class.text-warning]="isDocumentExpiring(doc)" [class.text-danger]="isDocumentExpired(doc)">
                {{ doc.expiryDate ? (doc.expiryDate | date:'MMM d, yyyy') : 'No Expiry' }}
              </span>
              <i *ngIf="isDocumentExpiring(doc)" class="fas fa-exclamation-triangle text-warning" title="Expiring soon"></i>
              <i *ngIf="isDocumentExpired(doc)" class="fas fa-times-circle text-danger" title="Expired"></i>
            </td>
            <td>
              <span class="status-badge" [ngClass]="getDocumentStatusClass(doc.verificationStatus)">
                {{ doc.verificationStatus }}
              </span>
            </td>
            <td>{{ doc.uploadedAt | date:'MMM d, yyyy' }}</td>
          </tr>
          <tr *ngIf="documents.length === 0">
            <td colspan="6" class="no-data-row">No documents uploaded yet</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="tab-content" *ngIf="activeTab === 'assets'">
    <div class="section-header">
      <h3>My Assigned Assets</h3>
    </div>
    <div class="cards-grid">
      <div class="card asset-card" *ngFor="let asset of assets">
        <div class="card-header">
          <span class="asset-type">{{ asset.assetType }}</span>
          <span class="status-badge" [ngClass]="getAssetStatusClass(asset.approvalStatus)">
            {{ asset.approvalStatus }}
          </span>
        </div>
        <div class="card-body">
          <h4 class="asset-name">{{ asset.assetName }}</h4>
          <div class="detail-row" *ngIf="asset.assetTag">
            <span>Asset Tag</span>
            <span>{{ asset.assetTag }}</span>
          </div>
          <div class="detail-row" *ngIf="asset.serialNumber">
            <span>Serial Number</span>
            <span>{{ asset.serialNumber }}</span>
          </div>
          <div class="detail-row" *ngIf="asset.issuedDate">
            <span>Issued Date</span>
            <span>{{ asset.issuedDate | date:'MMM d, yyyy' }}</span>
          </div>
          <div class="detail-row" *ngIf="asset.condition">
            <span>Condition</span>
            <span>{{ asset.condition }}</span>
          </div>
          <div class="detail-row" *ngIf="asset.remarks">
            <span>Remarks</span>
            <span>{{ asset.remarks }}</span>
          </div>
        </div>
      </div>
      <div class="no-data" *ngIf="assets.length === 0">
        <i class="fas fa-laptop"></i>
        <p>No assets assigned to you</p>
      </div>
    </div>
  </div>

  <div class="tab-content" *ngIf="activeTab === 'policies'">
    <div class="section-header">
      <h3>HR Policies & Documents</h3>
    </div>
    <div class="info-card" style="margin-bottom: 20px;">
      <i class="fas fa-info-circle"></i>
      <p>Review company policies and HR documents. Contact HR for any clarifications or questions.</p>
    </div>
    <div class="policies-grid">
      <div class="policy-card" *ngFor="let policy of policies">
        <div class="policy-icon">
          <i class="fas" [ngClass]="{
            'fa-calendar-alt': policy.category === 'HR',
            'fa-dollar-sign': policy.category === 'Finance',
            'fa-shield-alt': policy.category === 'IT'
          }"></i>
        </div>
        <div class="policy-info">
          <h4>{{ policy.title }}</h4>
          <p class="description">{{ policy.description }}</p>
          <div class="policy-meta">
            <span class="category-badge" [ngClass]="policy.category.toLowerCase()">{{ policy.category }}</span>
            <span class="updated">Updated: {{ policy.updatedAt | date:'MMM d, yyyy' }}</span>
          </div>
        </div>
        <button class="btn btn-outline-primary btn-sm">
          <i class="fas fa-eye"></i> View
        </button>
      </div>
      <div class="no-data" *ngIf="policies.length === 0">
        <i class="fas fa-book"></i>
        <p>No policies available</p>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showPaystubModal" (click)="closePaystubModal()">
  <div class="modal paystub-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Pay Stub Details</h3>
      <button class="close-btn" (click)="closePaystubModal()">&times;</button>
    </div>
    <div class="modal-body" *ngIf="selectedPaystub">
      <div class="paystub-section">
        <h4>Pay Period</h4>
        <p>{{ getPayPeriod(selectedPaystub) }} | Paid: {{ getPayDate(selectedPaystub) }}</p>
      </div>

      <div class="paystub-section">
        <h4>Earnings</h4>
        <div class="detail-row">
          <span>Base Pay</span>
          <span>${{ selectedPaystub.basePay | number:'1.2-2' }}</span>
        </div>
        <div class="detail-row" *ngIf="selectedPaystub.overtimePay">
          <span>Overtime Pay</span>
          <span>${{ selectedPaystub.overtimePay | number:'1.2-2' }}</span>
        </div>
        <div class="detail-row total">
          <span>Gross Pay</span>
          <span>${{ selectedPaystub.grossPay | number:'1.2-2' }}</span>
        </div>
      </div>

      <div class="paystub-section">
        <h4>Deductions</h4>
        <div class="detail-row" *ngIf="selectedPaystub.healthInsurance">
          <span>Health Insurance</span>
          <span>${{ selectedPaystub.healthInsurance | number:'1.2-2' }}</span>
        </div>
        <div class="detail-row" *ngIf="selectedPaystub.retirement401k">
          <span>401(k)</span>
          <span>${{ selectedPaystub.retirement401k | number:'1.2-2' }}</span>
        </div>
        <div class="detail-row" *ngIf="selectedPaystub.federalTax">
          <span>Federal Tax</span>
          <span>${{ selectedPaystub.federalTax | number:'1.2-2' }}</span>
        </div>
        <div class="detail-row" *ngIf="selectedPaystub.stateTax">
          <span>State Tax</span>
          <span>${{ selectedPaystub.stateTax | number:'1.2-2' }}</span>
        </div>
        <div class="detail-row" *ngIf="selectedPaystub.socialSecurityTax">
          <span>Social Security</span>
          <span>${{ selectedPaystub.socialSecurityTax | number:'1.2-2' }}</span>
        </div>
        <div class="detail-row" *ngIf="selectedPaystub.medicareTax">
          <span>Medicare</span>
          <span>${{ selectedPaystub.medicareTax | number:'1.2-2' }}</span>
        </div>
        <div class="detail-row total">
          <span>Total Deductions</span>
          <span>${{ selectedPaystub.totalDeductions | number:'1.2-2' }}</span>
        </div>
      </div>

      <div class="paystub-section net-section">
        <div class="detail-row net-pay">
          <span>Net Pay</span>
          <span>${{ selectedPaystub.netPay | number:'1.2-2' }}</span>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closePaystubModal()">Close</button>
      <button class="btn btn-outline-primary" (click)="printPaystub(selectedPaystub!)">
        <i class="fas fa-print"></i> Print
      </button>
      <button class="btn btn-primary" (click)="downloadPaystub(selectedPaystub!)">
        <i class="fas fa-download"></i> Download
      </button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showLeaveRequestModal" (click)="closeLeaveRequestModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Submit Leave Request</h3>
      <button class="close-btn" (click)="closeLeaveRequestModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Leave Type *</label>
        <select [(ngModel)]="newLeaveRequest.leaveTypeId">
          <option *ngFor="let type of leaveTypes" [value]="type.id">{{ type.name }}</option>
        </select>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Start Date *</label>
          <input type="date" [(ngModel)]="newLeaveRequest.startDate" required>
        </div>
        <div class="form-group">
          <label>End Date *</label>
          <input type="date" [(ngModel)]="newLeaveRequest.endDate" required>
        </div>
      </div>
      <div class="form-group">
        <label>Reason</label>
        <textarea [(ngModel)]="newLeaveRequest.reason" rows="3"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeLeaveRequestModal()">Cancel</button>
      <button class="btn btn-primary" (click)="submitLeaveRequest()">Submit Request</button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showExpenseRequestModal" (click)="closeExpenseRequestModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Submit Expense Request</h3>
      <button class="close-btn" (click)="closeExpenseRequestModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Expense Category *</label>
        <select [(ngModel)]="newExpenseRequest.categoryId">
          <option *ngFor="let cat of expenseCategories" [value]="cat.id">{{ cat.name }}</option>
        </select>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Expense Date *</label>
          <input type="date" [(ngModel)]="newExpenseRequest.expenseDate" required>
        </div>
        <div class="form-group">
          <label>Amount ($) *</label>
          <input type="number" [(ngModel)]="newExpenseRequest.amount" min="0" step="0.01" required>
        </div>
      </div>
      <div class="form-group">
        <label>Receipt Number</label>
        <input type="text" [(ngModel)]="newExpenseRequest.receiptNumber" placeholder="Optional">
      </div>
      <div class="form-group">
        <label>Description *</label>
        <textarea [(ngModel)]="newExpenseRequest.description" rows="3" placeholder="Describe the expense..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeExpenseRequestModal()">Cancel</button>
      <button class="btn btn-primary" (click)="submitExpenseRequest()">Submit Expense</button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showLoanRequestModal" (click)="closeLoanRequestModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Apply for Loan/Advance</h3>
      <button class="close-btn" (click)="closeLoanRequestModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Loan Type *</label>
        <select [(ngModel)]="newLoanRequest.loanType">
          <option *ngFor="let type of loanTypes" [value]="type">{{ type.replace('_', ' ') }}</option>
        </select>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Loan Amount ($) *</label>
          <input type="number" [(ngModel)]="newLoanRequest.amount" min="0" step="100" required>
        </div>
        <div class="form-group">
          <label>Number of EMIs *</label>
          <select [(ngModel)]="newLoanRequest.numberOfEmi">
            <option [value]="3">3 Months</option>
            <option [value]="6">6 Months</option>
            <option [value]="12">12 Months</option>
            <option [value]="18">18 Months</option>
            <option [value]="24">24 Months</option>
          </select>
        </div>
      </div>
      <div class="emi-preview" *ngIf="newLoanRequest.amount > 0">
        <span class="label">Estimated Monthly EMI:</span>
        <span class="amount">${{ getEmiAmount() | number:'1.2-2' }}</span>
      </div>
      <div class="form-group">
        <label>Reason for Loan *</label>
        <textarea [(ngModel)]="newLoanRequest.reason" rows="3" placeholder="Explain why you need this loan..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeLoanRequestModal()">Cancel</button>
      <button class="btn btn-primary" (click)="submitLoanRequest()">Submit Application</button>
    </div>
  </div>
</div>
