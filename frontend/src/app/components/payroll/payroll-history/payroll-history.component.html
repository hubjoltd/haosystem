<div class="payroll-history">
  <div class="page-header">
    <div class="header-left">
      <button class="back-btn" routerLink="/app/payroll/timesheets">
        <i class="fas fa-arrow-left"></i>
      </button>
      <div class="title-section">
        <h1>Complete Payroll History</h1>
        <p class="subtitle">Track all payroll transactions and payments</p>
      </div>
    </div>
    <div class="header-actions">
      <div class="view-toggle">
        <button class="toggle-btn" [class.active]="activeView === 'runs'" (click)="switchView('runs')">
          Payroll Runs
        </button>
        <button class="toggle-btn" [class.active]="activeView === 'detail'" (click)="switchView('detail')">
          Detailed View
        </button>
      </div>
    </div>
  </div>

  <!-- PAYROLL RUNS VIEW -->
  <div class="runs-view" *ngIf="activeView === 'runs'">
    <h3 class="section-title">Payroll Runs Summary</h3>
    
    <div class="period-type-cards">
      <div class="period-card weekly">
        <span class="period-count">{{ weeklyRunsCount }}</span>
        <span class="period-label">Weekly</span>
      </div>
      <div class="period-card biweekly">
        <span class="period-count">{{ biWeeklyRunsCount }}</span>
        <span class="period-label">Bi-Weekly</span>
      </div>
      <div class="period-card semimonthly">
        <span class="period-count">{{ semiMonthlyRunsCount }}</span>
        <span class="period-label">Semi-Monthly</span>
      </div>
      <div class="period-card monthly">
        <span class="period-count">{{ monthlyRunsCount }}</span>
        <span class="period-label">Monthly</span>
      </div>
    </div>

    <div class="summary-stats-row">
      <div class="stat-box">
        <span class="stat-label">Total Runs</span>
        <span class="stat-value">{{ completedRuns }}</span>
      </div>
      <div class="stat-box">
        <span class="stat-label">Total Employees</span>
        <span class="stat-value">{{ totalEmployeesCount }}</span>
      </div>
      <div class="stat-box">
        <span class="stat-label">Total Gross</span>
        <span class="stat-value blue">{{ formatCurrency(totalGross) }}</span>
      </div>
      <div class="stat-box">
        <span class="stat-label">Total Taxes</span>
        <span class="stat-value red">{{ formatCurrency(totalTaxes) }}</span>
      </div>
      <div class="stat-box">
        <span class="stat-label">Total Net Pay</span>
        <span class="stat-value green">{{ formatCurrency(totalNet) }}</span>
      </div>
    </div>

    <div class="runs-list">
      <div class="run-item" *ngFor="let run of payrollRunsList">
        <div class="run-field">
          <span class="field-label">Pay Period Type</span>
          <span class="field-value">{{ run.periodType }}</span>
        </div>
        <div class="run-field">
          <span class="field-label">Pay Period</span>
          <span class="field-value">{{ run.periodRange }}</span>
        </div>
        <div class="run-field">
          <span class="field-label">Pay Date</span>
          <span class="field-value">{{ run.payDate }}</span>
        </div>
        <div class="run-field">
          <span class="field-label">Gross</span>
          <span class="field-value green">{{ formatCurrency(run.gross) }}</span>
        </div>
        <div class="run-field">
          <span class="field-label">Net Pay</span>
          <span class="field-value green">{{ formatCurrency(run.netPay) }}</span>
        </div>
        <div class="run-field">
          <span class="field-label">Status</span>
          <span class="status-badge paid">{{ run.status }}</span>
        </div>
      </div>
      <div class="no-runs" *ngIf="payrollRunsList.length === 0">
        <i class="fas fa-inbox"></i>
        <p>No payroll runs found</p>
      </div>
    </div>
  </div>

  <!-- DETAILED VIEW -->
  <div class="detail-view" *ngIf="activeView === 'detail'">
    <div class="filter-section">
      <h4><i class="fas fa-filter"></i> Filter Payroll History</h4>
      <div class="filter-row">
        <div class="filter-group">
          <label>Project</label>
          <select [(ngModel)]="selectedProject">
            <option value="">All Projects</option>
            <option *ngFor="let p of projects" [value]="p">{{ p }}</option>
          </select>
        </div>
        <div class="filter-group">
          <label>From Date</label>
          <input type="date" [(ngModel)]="dateFrom" placeholder="mm/dd/yyyy">
        </div>
        <div class="filter-group">
          <label>To Date</label>
          <input type="date" [(ngModel)]="dateTo" placeholder="mm/dd/yyyy">
        </div>
        <div class="filter-group btn-group">
          <button class="btn btn-clear" (click)="clearFilters()">Clear</button>
        </div>
      </div>
    </div>

    <div class="detail-summary-cards">
      <div class="summary-card total-records">
        <i class="fas fa-file-alt card-icon"></i>
        <span class="card-label">Total Records</span>
        <span class="card-value">{{ filteredRecords.length }}</span>
      </div>
      <div class="summary-card total-paid">
        <i class="fas fa-check-circle card-icon"></i>
        <span class="card-label">Total Paid</span>
        <span class="card-value">{{ formatCurrency(totalNetFiltered) }}</span>
      </div>
      <div class="summary-card pending">
        <i class="fas fa-clock card-icon"></i>
        <span class="card-label">Pending Payment</span>
        <span class="card-value">{{ formatCurrency(pendingAmount) }}</span>
      </div>
      <div class="summary-card on-hold">
        <i class="fas fa-pause-circle card-icon"></i>
        <span class="card-label">On Hold</span>
        <span class="card-value">{{ formatCurrency(onHoldAmount) }}</span>
      </div>
    </div>

    <div class="records-section">
      <div class="records-header">
        <div class="header-info">
          <h4>All Payroll Records</h4>
          <span class="record-summary">{{ filteredRecords.length }} Payroll Records - {{ totalHoursFiltered.toFixed(2) }} Total Hours - {{ formatCurrency(totalNetFiltered) }} Total Paid</span>
        </div>
        <div class="export-buttons">
          <button class="btn btn-export-excel" (click)="exportToCSV()">
            <i class="fas fa-file-excel"></i> Export Excel
          </button>
          <button class="btn btn-export-pdf" (click)="exportToPDF()">
            <i class="fas fa-file-pdf"></i> Export PDF
          </button>
        </div>
      </div>

      <div class="table-container">
        <table class="data-table detail-table">
          <thead>
            <tr>
              <th>S.NO</th>
              <th>EMP ID</th>
              <th>NAME</th>
              <th>TYPE</th>
              <th>PROJECT</th>
              <th>SUBCONTRACTOR</th>
              <th>PAY PERIOD</th>
              <th>PERIOD FROM</th>
              <th>PERIOD TO</th>
              <th>HOURS</th>
              <th>GROSS</th>
              <th>FEDERAL</th>
              <th>STATE</th>
              <th>SOC.SEC</th>
              <th>MEDICARE</th>
              <th>EXPENSES</th>
              <th>TOTAL TAX</th>
              <th>NET PAY</th>
              <th>PAYMENT DATE</th>
              <th>STATUS</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let record of filteredRecords; let i = index">
              <td>{{ i + 1 }}</td>
              <td class="emp-id"><a class="employee-code-link" [routerLink]="['/app/hr/employees', getEmployeeIdByCode(record.empId)]">{{ record.empId }}</a></td>
              <td class="emp-name">{{ record.name }}</td>
              <td>{{ record.employeeType }}</td>
              <td>{{ record.project || '-' }}</td>
              <td>{{ record.subcontractor || '-' }}</td>
              <td>{{ record.payRatePeriod }}</td>
              <td>{{ formatDate(record.periodFrom) }}</td>
              <td>{{ formatDate(record.periodTo) }}</td>
              <td class="hours">{{ record.hours }}h</td>
              <td class="gross">{{ formatCurrency(record.gross) }}</td>
              <td class="tax">{{ formatCurrency(record.fedTax) }}</td>
              <td class="tax">{{ formatCurrency(record.stateTax) }}</td>
              <td class="tax">{{ formatCurrency(record.socSecTax) }}</td>
              <td class="tax">{{ formatCurrency(record.medicareTax) }}</td>
              <td class="expense">{{ formatCurrency(record.expenses || 0) }}</td>
              <td class="total-tax">{{ formatCurrency(record.totalTax) }}</td>
              <td class="net">{{ formatCurrency(record.netPay) }}</td>
              <td>{{ formatDate(record.paymentDate) }}</td>
              <td>
                <span class="status-badge" [ngClass]="getStatusClass(record.payStatus)">{{ record.payStatus }}</span>
              </td>
            </tr>
            <tr *ngIf="filteredRecords.length === 0">
              <td colspan="20" class="no-data">
                <i class="fas fa-inbox"></i>
                No payroll records found
              </td>
            </tr>
          </tbody>
          <tfoot *ngIf="filteredRecords.length > 0">
            <tr class="totals-row">
              <td colspan="9"><strong>TOTAL</strong></td>
              <td class="hours"><strong>{{ totalHoursFiltered.toFixed(2) }}h</strong></td>
              <td class="gross"><strong>{{ formatCurrency(totalGrossFiltered) }}</strong></td>
              <td class="tax"><strong>{{ formatCurrency(totalFedTax) }}</strong></td>
              <td class="tax"><strong>{{ formatCurrency(totalStateTax) }}</strong></td>
              <td class="tax"><strong>{{ formatCurrency(totalSocSecTax) }}</strong></td>
              <td class="tax"><strong>{{ formatCurrency(totalMedicareTax) }}</strong></td>
              <td class="expense"><strong>{{ formatCurrency(totalExpenses) }}</strong></td>
              <td class="total-tax"><strong>{{ formatCurrency(totalTaxFiltered) }}</strong></td>
              <td class="net"><strong>{{ formatCurrency(totalNetFiltered) }}</strong></td>
              <td colspan="2"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
</div>
