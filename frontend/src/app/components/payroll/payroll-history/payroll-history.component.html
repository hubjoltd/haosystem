<div class="payroll-history">
  <div class="page-header">
    <div>
      <h1>Payroll History</h1>
      <p class="subtitle">All processed payroll runs</p>
    </div>
  </div>

  <div class="runs-section">
    <div class="section-header">
      <h3>Processed Payroll Runs</h3>
      <div class="filters">
        <div class="filter-item">
          <label>From Date</label>
          <input type="date" [(ngModel)]="dateFrom">
        </div>
        <div class="filter-item">
          <label>To Date</label>
          <input type="date" [(ngModel)]="dateTo">
        </div>
        <div class="filter-item">
          <label>Project</label>
          <select [(ngModel)]="selectedProject">
            <option value="">All Projects</option>
            <option *ngFor="let p of projects" [value]="p">{{ p }}</option>
          </select>
        </div>
        <button class="btn-clear" (click)="clearFilters()">Clear</button>
      </div>
    </div>

    <div class="table-container" *ngIf="!loading">
      <table class="runs-table">
        <thead>
          <tr>
            <th>Num</th>
            <th>Pay Period</th>
            <th>Paydate</th>
            <th>Type</th>
            <th>Employees</th>
            <th>Gross</th>
            <th>Taxes</th>
            <th>Net Payment</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let run of filteredRuns; let i = index">
            <td>{{ i + 1 }}</td>
            <td>{{ formatDate(run.periodStartDate) }} to {{ formatDate(run.periodEndDate) }}</td>
            <td>{{ formatDate(run.payDate) }}</td>
            <td>
              <span class="type-badge" [ngClass]="getPeriodTypeBadgeClass(run)">{{ getPeriodTypeLabel(run) }}</span>
            </td>
            <td>{{ getRunTotalEmployees(run) }}</td>
            <td class="amount green">{{ formatCurrency(run.totalGrossPay || 0) }}</td>
            <td class="amount">{{ formatCurrency(run.totalTaxes || 0) }}</td>
            <td class="amount green">{{ formatCurrency(run.totalNetPay || 0) }}</td>
            <td>
              <button class="btn-view" (click)="viewRunDetails(run)">
                <i class="fas fa-eye"></i> View
              </button>
            </td>
          </tr>
          <tr *ngIf="filteredRuns.length === 0">
            <td colspan="9" class="no-data">
              <i class="fas fa-inbox"></i>
              <span>No payroll runs found</span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="loading-state" *ngIf="loading">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Loading payroll history...</p>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showDetailsModal" (click)="closeDetailsModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Payroll Run Details - {{ selectedRun?.payrollRunNumber }}</h2>
      <button class="close-btn" (click)="closeDetailsModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="summary-cards">
      <div class="summary-card card-employees">
        <span class="card-label">Total Employees</span>
        <span class="card-value">{{ detailSummary.totalEmployees }}</span>
      </div>
      <div class="summary-card card-gross">
        <span class="card-label">Gross Pay</span>
        <span class="card-value">{{ formatCurrency(detailSummary.grossPay) }}</span>
      </div>
      <div class="summary-card card-tax">
        <span class="card-label">Total Tax</span>
        <span class="card-value">{{ formatCurrency(detailSummary.totalTax) }}</span>
      </div>
      <div class="summary-card card-net">
        <span class="card-label">Net Pay</span>
        <span class="card-value">{{ formatCurrency(detailSummary.netPay) }}</span>
      </div>
    </div>

    <h4 class="detail-subtitle">Employee Details</h4>

    <div class="detail-table-container">
      <table class="detail-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Employee ID</th>
            <th>Name</th>
            <th>Type</th>
            <th>Hours</th>
            <th>Gross</th>
            <th>Federal Tax</th>
            <th>State Tax</th>
            <th>Soc. Sec</th>
            <th>Medicare</th>
            <th>Total Tax</th>
            <th>Net Pay</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let record of selectedRunRecords; let i = index">
            <td>{{ i + 1 }}</td>
            <td class="emp-code">{{ getEmployeeCode(record) }}</td>
            <td class="emp-name">{{ getEmployeeName(record) }}</td>
            <td>
              <span class="emp-type-badge" [ngClass]="getEmployeeType(record) === 'Full-Time' ? 'type-fulltime' : 'type-sub'">{{ getEmployeeType(record) }}</span>
            </td>
            <td>{{ getTotalHours(record) }}h</td>
            <td class="amount green">{{ formatCurrency(record.grossPay || 0) }}</td>
            <td class="amount">{{ formatCurrency(record.federalTax || 0) }}</td>
            <td class="amount">{{ formatCurrency(record.stateTax || 0) }}</td>
            <td class="amount">{{ formatCurrency(record.socialSecurityTax || 0) }}</td>
            <td class="amount">{{ formatCurrency(record.medicareTax || 0) }}</td>
            <td class="amount green">{{ formatCurrency(record.totalTaxes || 0) }}</td>
            <td class="amount green">{{ formatCurrency(record.netPay || 0) }}</td>
          </tr>
          <tr *ngIf="selectedRunRecords.length === 0">
            <td colspan="12" class="no-data">No employee records found</td>
          </tr>
        </tbody>
        <tfoot *ngIf="selectedRunRecords.length > 0">
          <tr class="totals-row">
            <td colspan="4"><strong>TOTAL</strong></td>
            <td><strong>{{ getDetailRecordTotals().hours }}h</strong></td>
            <td class="amount green"><strong>{{ formatCurrency(getDetailRecordTotals().gross) }}</strong></td>
            <td class="amount"><strong>{{ formatCurrency(getDetailRecordTotals().federal) }}</strong></td>
            <td class="amount"><strong>{{ formatCurrency(getDetailRecordTotals().state) }}</strong></td>
            <td class="amount"><strong>{{ formatCurrency(getDetailRecordTotals().socSec) }}</strong></td>
            <td class="amount"><strong>{{ formatCurrency(getDetailRecordTotals().medicare) }}</strong></td>
            <td class="amount green"><strong>{{ formatCurrency(getDetailRecordTotals().totalTax) }}</strong></td>
            <td class="amount green"><strong>{{ formatCurrency(getDetailRecordTotals().netPay) }}</strong></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="modal-footer">
      <button class="btn-close-modal" (click)="closeDetailsModal()">Close</button>
    </div>
  </div>
</div>
