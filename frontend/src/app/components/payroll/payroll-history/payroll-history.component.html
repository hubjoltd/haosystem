<div class="payroll-history">
  <div class="page-header">
    <div class="header-left">
      <h1><i class="fas fa-history"></i> Complete Payroll History</h1>
      <p class="subtitle">View and export detailed payroll history for all employees</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-primary" (click)="openGenerateTimesheetModal()">
        <i class="fas fa-clock"></i> Generate Timesheet
      </button>
      <button class="btn btn-secondary" (click)="exportToCSV()">
        <i class="fas fa-file-csv"></i> Export to CSV/PDF/Excel
      </button>
      <button class="btn btn-info">
        <i class="fas fa-chart-bar"></i> Run a Difference
      </button>
      <div class="view-toggle">
        <button class="toggle-btn" [class.active]="activeView === 'list'" (click)="switchView('list')">
          <i class="fas fa-list"></i> List View
        </button>
        <button class="toggle-btn" [class.active]="activeView === 'detail'" (click)="switchView('detail')">
          <i class="fas fa-th-large"></i> Detail View
        </button>
      </div>
    </div>
  </div>

  <div class="summary-section">
    <h3><i class="fas fa-chart-line"></i> Payroll Runs Summary</h3>
    <div class="summary-cards">
      <div class="summary-card runs">
        <div class="card-icon"><i class="fas fa-check-circle"></i></div>
        <div class="card-content">
          <span class="card-value">{{ completedRuns }}</span>
          <span class="card-label">Completed Runs</span>
        </div>
      </div>
      <div class="summary-card gross">
        <div class="card-content">
          <span class="card-value">{{ formatCurrency(totalGross) }}</span>
          <span class="card-label">Total Gross</span>
        </div>
      </div>
      <div class="summary-card net">
        <div class="card-content">
          <span class="card-value">{{ formatCurrency(totalNet) }}</span>
          <span class="card-label">Total Net</span>
        </div>
      </div>
      <div class="summary-card avg">
        <div class="card-content">
          <span class="card-value">{{ formatCurrency(avgNetPerRun) }}</span>
          <span class="card-label">Avg Net Pay/Run</span>
        </div>
      </div>
    </div>
  </div>

  <div class="filters-section">
    <div class="filter-group">
      <label>Search</label>
      <input type="text" [(ngModel)]="searchTerm" placeholder="Search by name or ID..." class="search-input">
    </div>
    <div class="filter-group">
      <label>Status</label>
      <select [(ngModel)]="selectedStatus">
        <option value="ALL">All Status</option>
        <option value="Paid">Paid</option>
        <option value="Pending">Pending</option>
        <option value="Processing">Processing</option>
      </select>
    </div>
    <div class="filter-group">
      <label>From</label>
      <input type="date" [(ngModel)]="dateFrom">
    </div>
    <div class="filter-group">
      <label>To</label>
      <input type="date" [(ngModel)]="dateTo">
    </div>
  </div>

  <!-- LIST VIEW -->
  <div class="table-section" *ngIf="activeView === 'list'">
    <div class="all-records-header">
      <h3>All Payroll Records</h3>
      <span class="record-count">{{ filteredRecords.length }} Payroll Records - {{ totalHoursFiltered.toFixed(2) }} Total Hours - {{ formatCurrency(totalNetFiltered) }} Total Paid</span>
      <div class="export-buttons">
        <button class="btn btn-success btn-sm" (click)="exportToCSV()">
          <i class="fas fa-file-excel"></i> Export Excel
        </button>
        <button class="btn btn-danger btn-sm" (click)="exportToPDF()">
          <i class="fas fa-file-pdf"></i>
        </button>
      </div>
    </div>
    <div class="table-container">
      <table class="data-table history-table">
        <thead>
          <tr>
            <th>S.NO</th>
            <th (click)="sortBy('empId')" class="sortable">
              EMP ID <i class="fas" [ngClass]="getSortIcon('empId')"></i>
            </th>
            <th (click)="sortBy('name')" class="sortable">
              NAME <i class="fas" [ngClass]="getSortIcon('name')"></i>
            </th>
            <th>TYPE</th>
            <th>PROJECT</th>
            <th>PAY PERIOD</th>
            <th>PERIOD FROM</th>
            <th>PERIOD TO</th>
            <th class="number-col">HOURS</th>
            <th class="number-col gross-col">GROSS</th>
            <th class="number-col tax-col">FEDERAL</th>
            <th class="number-col tax-col">STATE</th>
            <th class="number-col tax-col">SOC.SEC</th>
            <th class="number-col tax-col">MEDICARE</th>
            <th class="number-col tax-col">TOTAL TAX</th>
            <th class="number-col net-col">NET PAY</th>
            <th>PAYM DATE</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let record of filteredRecords; let i = index" [class.alt-row]="i % 2 === 1">
            <td>{{ i + 1 }}</td>
            <td class="emp-id">{{ record.empId }}</td>
            <td class="emp-name">{{ record.name }}</td>
            <td>{{ record.employeeType || 'Salaried' }}</td>
            <td>{{ record.project || '-' }}</td>
            <td>{{ record.payRatePeriod || '-' }}</td>
            <td>{{ record.periodFrom ? formatDate(record.periodFrom) : '-' }}</td>
            <td>{{ record.periodTo ? formatDate(record.periodTo) : '-' }}</td>
            <td class="number-col">{{ ((record.hours || 0)).toFixed(2) }}h</td>
            <td class="number-col gross-col">{{ formatCurrency(record.gross || 0) }}</td>
            <td class="number-col tax-col">{{ formatCurrency(record.fedTax || 0) }}</td>
            <td class="number-col tax-col">{{ formatCurrency(record.stateTax || 0) }}</td>
            <td class="number-col tax-col">{{ formatCurrency(record.socSecTax || 0) }}</td>
            <td class="number-col tax-col">{{ formatCurrency(record.medicareTax || 0) }}</td>
            <td class="number-col tax-col">{{ formatCurrency(record.totalTax || 0) }}</td>
            <td class="number-col net-col">{{ formatCurrency(record.netPay || 0) }}</td>
            <td>{{ record.paymentDate ? formatDate(record.paymentDate) : '-' }}</td>
          </tr>
          <tr *ngIf="filteredRecords.length === 0">
            <td colspan="17" class="no-data">
              <i class="fas fa-inbox"></i>
              No payroll history records found
            </td>
          </tr>
        </tbody>
        <tfoot *ngIf="filteredRecords.length > 0">
          <tr class="totals-row">
            <td colspan="8" class="total-label">TOTAL</td>
            <td class="number-col">{{ totalHoursFiltered.toFixed(2) }}h</td>
            <td class="number-col gross-col"><strong>{{ formatCurrency(totalGrossFiltered) }}</strong></td>
            <td class="number-col tax-col">{{ formatCurrency(totalFedTax) }}</td>
            <td class="number-col tax-col">{{ formatCurrency(totalStateTax) }}</td>
            <td class="number-col tax-col">{{ formatCurrency(totalSocSecTax) }}</td>
            <td class="number-col tax-col">{{ formatCurrency(totalMedicareTax) }}</td>
            <td class="number-col tax-col">{{ formatCurrency(totalTaxFiltered) }}</td>
            <td class="number-col net-col"><strong>{{ formatCurrency(totalNetFiltered) }}</strong></td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- DETAIL VIEW -->
  <div class="detail-view-section" *ngIf="activeView === 'detail'">
    <div class="payroll-summary-header">
      <div class="success-banner">
        <i class="fas fa-check-circle"></i>
        <div class="banner-content">
          <strong>Payroll Processed Successfully</strong>
          <span>{{ completedRuns }} payroll run(s) in the selected period</span>
        </div>
      </div>
      <div class="summary-totals">
        <div class="total-item">
          <span class="label">Total Gross</span>
          <span class="value">{{ formatCurrency(totalGross) }}</span>
        </div>
        <div class="total-item">
          <span class="label">Total Employees</span>
          <span class="value">{{ filteredRecords.length }}</span>
        </div>
        <div class="total-item highlight">
          <span class="label">Total Net</span>
          <span class="value">{{ formatCurrency(totalNet) }}</span>
        </div>
      </div>
    </div>

    <!-- Salaried Employees Section -->
    <div class="employee-type-section">
      <h4 class="section-title salaried"><i class="fas fa-user-tie"></i> Salaried Employees ({{ salariedEmployees.length }})</h4>
      <div class="detail-table-container">
        <table class="detail-table">
          <thead>
            <tr>
              <th>EMP ID</th>
              <th>NAME</th>
              <th>PERIOD</th>
              <th class="number-col">SALARY</th>
              <th class="number-col">GROSS</th>
              <th class="number-col">TAXES</th>
              <th class="number-col highlight">NET AMOUNT</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let record of salariedEmployees">
              <td class="emp-id">{{ record.empId }}</td>
              <td class="emp-name">{{ record.name }}</td>
              <td>{{ record.payRatePeriod }}</td>
              <td class="number-col">{{ formatCurrency(record.regular) }}</td>
              <td class="number-col">{{ formatCurrency(record.gross) }}</td>
              <td class="number-col tax">{{ formatCurrency(record.fedTax + record.stateTax) }}</td>
              <td class="number-col net highlight">{{ formatCurrency(record.netPay) }}</td>
            </tr>
            <tr *ngIf="salariedEmployees.length === 0">
              <td colspan="7" class="no-data">No salaried employees</td>
            </tr>
          </tbody>
          <tfoot *ngIf="salariedEmployees.length > 0">
            <tr class="subtotal-row">
              <td colspan="6" class="text-right"><strong>Subtotal:</strong></td>
              <td class="number-col net"><strong>{{ formatCurrency(getSalariedTotal()) }}</strong></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- Hourly Employees Section -->
    <div class="employee-type-section">
      <h4 class="section-title hourly"><i class="fas fa-clock"></i> Hourly Employees ({{ hourlyEmployees.length }})</h4>
      <div class="detail-table-container">
        <table class="detail-table">
          <thead>
            <tr>
              <th>EMP ID</th>
              <th>NAME</th>
              <th>PERIOD</th>
              <th class="number-col">RATE</th>
              <th class="number-col">HOURS</th>
              <th class="number-col">GROSS</th>
              <th class="number-col">TAXES</th>
              <th class="number-col highlight">NET AMOUNT</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let record of hourlyEmployees">
              <td class="emp-id">{{ record.empId }}</td>
              <td class="emp-name">{{ record.name }}</td>
              <td>{{ record.payRatePeriod }}</td>
              <td class="number-col">{{ formatCurrency(record.regular / 160) }}/hr</td>
              <td class="number-col">160</td>
              <td class="number-col">{{ formatCurrency(record.gross) }}</td>
              <td class="number-col tax">{{ formatCurrency(record.fedTax + record.stateTax) }}</td>
              <td class="number-col net highlight">{{ formatCurrency(record.netPay) }}</td>
            </tr>
            <tr *ngIf="hourlyEmployees.length === 0">
              <td colspan="8" class="no-data">No hourly employees</td>
            </tr>
          </tbody>
          <tfoot *ngIf="hourlyEmployees.length > 0">
            <tr class="subtotal-row">
              <td colspan="7" class="text-right"><strong>Subtotal:</strong></td>
              <td class="number-col net"><strong>{{ formatCurrency(getHourlyTotal()) }}</strong></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- Contractors Section -->
    <div class="employee-type-section" *ngIf="contractorEmployees.length > 0">
      <h4 class="section-title contractor"><i class="fas fa-file-contract"></i> Contractors ({{ contractorEmployees.length }})</h4>
      <div class="detail-table-container">
        <table class="detail-table">
          <thead>
            <tr>
              <th>EMP ID</th>
              <th>NAME</th>
              <th>PERIOD</th>
              <th class="number-col">RATE</th>
              <th class="number-col">GROSS</th>
              <th class="number-col">TAXES</th>
              <th class="number-col highlight">NET AMOUNT</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let record of contractorEmployees">
              <td class="emp-id">{{ record.empId }}</td>
              <td class="emp-name">{{ record.name }}</td>
              <td>{{ record.payRatePeriod }}</td>
              <td class="number-col">{{ formatCurrency(record.regular) }}</td>
              <td class="number-col">{{ formatCurrency(record.gross) }}</td>
              <td class="number-col tax">{{ formatCurrency(record.fedTax + record.stateTax) }}</td>
              <td class="number-col net highlight">{{ formatCurrency(record.netPay) }}</td>
            </tr>
          </tbody>
          <tfoot>
            <tr class="subtotal-row">
              <td colspan="6" class="text-right"><strong>Subtotal:</strong></td>
              <td class="number-col net"><strong>{{ formatCurrency(getContractorTotal()) }}</strong></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <div class="grand-total-section">
      <div class="grand-total-bar detail">
        <span>Grand Total Net Amount:</span>
        <span class="total-value">{{ formatCurrency(totalNet) }}</span>
      </div>
    </div>
  </div>

  <!-- LIST VIEW breakdown sections -->
  <div class="breakdown-sections" *ngIf="activeView === 'list'">
    <div class="section-box breakdown-box">
      <h4><i class="fas fa-users"></i> Salaried Employees</h4>
      <div class="mini-table-container">
        <table class="mini-table">
          <thead>
            <tr>
              <th>EMP ID</th>
              <th>NAME</th>
              <th>Basic</th>
              <th>Gross</th>
              <th>Taxes</th>
              <th>Net Amount</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let record of salariedEmployees.slice(0, 5)">
              <td class="emp-id">{{ record.empId }}</td>
              <td class="emp-name">{{ record.name }}</td>
              <td>{{ formatCurrency(record.regular) }}</td>
              <td>{{ formatCurrency(record.gross) }}</td>
              <td class="tax">{{ formatCurrency(record.fedTax + record.stateTax) }}</td>
              <td class="net">{{ formatCurrency(record.netPay) }}</td>
            </tr>
            <tr *ngIf="salariedEmployees.length === 0">
              <td colspan="6" class="no-data">No salaried employees in this period</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="section-box breakdown-box">
      <h4><i class="fas fa-clock"></i> Hourly / Contract Employees</h4>
      <div class="mini-table-container">
        <table class="mini-table">
          <thead>
            <tr>
              <th>EMP ID</th>
              <th>NAME</th>
              <th>Hours</th>
              <th>Gross</th>
              <th>Taxes</th>
              <th>Net Amount</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let record of hourlyEmployees.slice(0, 5)">
              <td class="emp-id">{{ record.empId }}</td>
              <td class="emp-name">{{ record.name }}</td>
              <td>160h</td>
              <td>{{ formatCurrency(record.gross) }}</td>
              <td class="tax">{{ formatCurrency(record.fedTax + record.stateTax) }}</td>
              <td class="net">{{ formatCurrency(record.netPay) }}</td>
            </tr>
            <tr *ngIf="hourlyEmployees.length === 0">
              <td colspan="6" class="no-data">No hourly employees in this period</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="grand-total-bar" *ngIf="activeView === 'list'">
    <span>Grand Total Net Amount:</span>
    <span class="total-value">{{ formatCurrency(totalNet) }}</span>
  </div>
</div>

<!-- Generate Timesheet Modal -->
<div class="modal-overlay" *ngIf="showGenerateTimesheetModal" (click)="closeGenerateTimesheetModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><i class="fas fa-clock"></i> Generate Timesheet</h3>
      <button class="close-btn" (click)="closeGenerateTimesheetModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Start Date</label>
        <input type="date" [(ngModel)]="timesheetStartDate" class="form-control">
      </div>
      <div class="form-group">
        <label>End Date</label>
        <input type="date" [(ngModel)]="timesheetEndDate" class="form-control">
      </div>
      <div class="form-group">
        <label>Pay Frequency</label>
        <select [(ngModel)]="selectedPayFrequency" class="form-control">
          <option value="MONTHLY">Monthly</option>
          <option value="BIWEEKLY">Bi-Weekly</option>
          <option value="WEEKLY">Weekly</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeGenerateTimesheetModal()">Cancel</button>
      <button class="btn btn-primary" (click)="generateTimesheet()" [disabled]="generatingTimesheet">
        <i class="fas fa-spinner fa-spin" *ngIf="generatingTimesheet"></i>
        {{ generatingTimesheet ? 'Generating...' : 'Generate Timesheet' }}
      </button>
    </div>
  </div>
</div>
