<div class="process-payroll-container">
  <div class="page-header">
    <div class="header-left">
      <h2>Process Payroll</h2>
      <p class="subtitle">Calculate payroll based on approved timesheets</p>
    </div>
  </div>

  <div class="payroll-calc-section">
    <div class="section-header">
      <h3><i class="fas fa-calculator section-icon"></i> Payroll Calculation</h3>
      <button class="btn-new-calc" (click)="openNewCalcModal()">
        <i class="fas fa-plus"></i> New Payroll Calculation
      </button>
    </div>
  </div>

  <div class="calculated-review-section" *ngIf="showCalculatedReview && calculatedRecords.length > 0">
    <div class="section-header">
      <h3><i class="fas fa-clipboard-check section-icon"></i> Calculated Payroll - Review Before Saving</h3>
      <div class="section-actions">
        <button class="btn-cancel" (click)="cancelCalculatedReview()">Cancel</button>
        <button class="btn-save" (click)="saveCalculatedPayroll()">
          <i class="fas fa-save"></i> Save Payroll
        </button>
      </div>
    </div>
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Employee ID</th>
            <th>Name</th>
            <th class="number-col">Hourly Rate</th>
            <th class="number-col">Hours</th>
            <th class="number-col">Gross Pay</th>
            <th class="number-col">Reimb.</th>
            <th class="number-col">Deductions</th>
            <th class="number-col">Total Tax</th>
            <th class="number-col">Net Pay</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let record of calculatedRecords; let i = index">
            <td>{{ i + 1 }}</td>
            <td>{{ getEmployeeCode(record) }}</td>
            <td class="employee-name">{{ getEmployeeName(record) }}</td>
            <td class="number-col">${{ record.hourlyRate?.toFixed(2) || '0.00' }}</td>
            <td class="number-col">{{ getRecordHours(record) | number:'1.2-2' }}</td>
            <td class="number-col">${{ record.grossPay?.toFixed(2) || '0.00' }}</td>
            <td class="number-col">${{ record.reimbursements?.toFixed(2) || '0.00' }}</td>
            <td class="number-col">${{ record.totalDeductions?.toFixed(2) || '0.00' }}</td>
            <td class="number-col">${{ getRecordTotalTax(record) | number:'1.2-2' }}</td>
            <td class="number-col amount-green">${{ record.netPay?.toFixed(2) || '0.00' }}</td>
          </tr>
          <tr *ngIf="calculatedRecords.length === 0">
            <td colspan="10" class="no-data">No payroll records found</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="saved-runs-section">
    <div class="section-header">
      <h3><i class="fas fa-list-alt section-icon"></i> Saved Payroll Runs</h3>
    </div>

    <div class="loading-state" *ngIf="loading">
      <i class="fas fa-spinner fa-spin"></i> Loading...
    </div>

    <div class="table-container" *ngIf="!loading">
      <table class="data-table runs-table">
        <thead>
          <tr>
            <th>Num</th>
            <th>Pay Period</th>
            <th>Paydate</th>
            <th>Type</th>
            <th class="number-col">Employees</th>
            <th>Processed</th>
            <th class="number-col">Gross</th>
            <th class="number-col">Taxes</th>
            <th class="number-col">Net Payment</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let run of allPayrollRuns; let i = index">
            <td>{{ run.payrollRunNumber || (i + 1) }}</td>
            <td>{{ run.periodStartDate }} - {{ run.periodEndDate }}</td>
            <td>{{ run.payDate || '-' }}</td>
            <td>
              <span class="type-badge" [ngClass]="getPeriodTypeBadgeClass(run.payFrequency)">
                {{ getPeriodTypeLabel(run.payFrequency) }}
              </span>
            </td>
            <td class="number-col">{{ run.totalEmployees || 0 }}</td>
            <td>
              <span class="processed-fraction" [class.fraction-red]="!isProcessedFractionGreen(run)" [class.fraction-green]="isProcessedFractionGreen(run)">
                {{ getProcessedFraction(run) }}
              </span>
            </td>
            <td class="number-col amount-green">${{ (run.totalGrossPay || 0) | number:'1.2-2' }}</td>
            <td class="number-col">${{ (run.totalTaxes || 0) | number:'1.2-2' }}</td>
            <td class="number-col amount-green">${{ (run.totalNetPay || 0) | number:'1.2-2' }}</td>
            <td>
              <a class="view-link" (click)="viewRunDetails(run)">View</a>
            </td>
          </tr>
          <tr *ngIf="allPayrollRuns.length === 0">
            <td colspan="10" class="no-data">No payroll runs found. Create a new payroll calculation above.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="summary-cards">
    <div class="summary-card blue">
      <span class="card-label">Pending Employees</span>
      <span class="card-value">{{ summary.pendingEmployees }}</span>
    </div>
    <div class="summary-card yellow">
      <span class="card-label">Total Gross</span>
      <span class="card-value">${{ summary.grossPay | number:'1.2-2' }}</span>
    </div>
    <div class="summary-card red">
      <span class="card-label">Total Tax</span>
      <span class="card-value">${{ summary.netTax | number:'1.2-2' }}</span>
    </div>
    <div class="summary-card purple">
      <span class="card-label">Total Net Pay</span>
      <span class="card-value">${{ summary.netPay | number:'1.2-2' }}</span>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showNewCalcModal" (click)="closeNewCalcModal()">
  <div class="modal new-calc-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><i class="fas fa-calculator modal-icon"></i> New Payroll Calculation</h3>
      <button class="close-btn" (click)="closeNewCalcModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label><i class="fas fa-users field-icon blue-icon"></i> Pay Group</label>
          <select [(ngModel)]="selectedProject" class="form-control">
            <option value="">All Projects (Company Level)</option>
            <option *ngFor="let proj of projectList" [value]="proj.name">{{ proj.name }}</option>
          </select>
        </div>
        <div class="form-group">
          <label><i class="fas fa-tag field-icon green-icon"></i> Run Type</label>
          <select class="form-control">
            <option value="REGULAR">Regular</option>
            <option value="BONUS">Bonus</option>
            <option value="SPECIAL">Special</option>
          </select>
        </div>
      </div>

      <div class="section-label">PAY PERIOD</div>

      <div class="form-row">
        <div class="form-group">
          <label><i class="fas fa-calendar field-icon"></i> Pay Period Start</label>
          <input type="date" [(ngModel)]="filterStartDate" class="form-control" />
        </div>
        <div class="form-group">
          <label><i class="fas fa-calendar field-icon"></i> Pay Period End</label>
          <input type="date" [(ngModel)]="filterEndDate" class="form-control" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label><i class="fas fa-sync-alt field-icon green-icon"></i> Period Type</label>
          <select [(ngModel)]="periodType" class="form-control">
            <option value="BI_WEEKLY">Bi-Weekly</option>
            <option value="WEEKLY">Weekly</option>
            <option value="MONTHLY">Monthly</option>
            <option value="SEMI_MONTHLY">Semi-Monthly</option>
          </select>
        </div>
        <div class="form-group">
          <label><i class="fas fa-dollar-sign field-icon"></i> Pay Date</label>
          <input type="date" [(ngModel)]="payDate" class="form-control" />
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeNewCalcModal()">Cancel</button>
      <button class="btn btn-primary" (click)="submitNewCalc()" [disabled]="calculating">
        <i class="fas fa-calculator"></i> {{ calculating ? 'Calculating...' : 'Calculate Payroll' }}
      </button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showRunDetailsModal && selectedViewRun" (click)="closeRunDetailsModal()">
  <div class="modal run-details-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Payroll Run Details - {{ selectedViewRun.payrollRunNumber }}</h3>
      <button class="close-btn" (click)="closeRunDetailsModal()">&times;</button>
    </div>
    <div class="modal-body">
      <p class="records-subtitle">Payroll Records</p>
      <div class="table-container">
        <table class="data-table details-table">
          <thead>
            <tr>
              <th class="checkbox-col">
                <input type="checkbox" [checked]="isViewAllSelected()" (change)="toggleViewSelectAll($event)">
              </th>
              <th>#</th>
              <th>Employee ID</th>
              <th>Name</th>
              <th>Type</th>
              <th class="number-col">Hours</th>
              <th class="number-col">Gross</th>
              <th class="number-col">Reimb.</th>
              <th class="number-col">Federal Tax</th>
              <th class="number-col">State Tax</th>
              <th class="number-col">Soc. Sec</th>
              <th class="number-col">Medicare</th>
              <th class="number-col">Total Tax</th>
              <th class="number-col">Net Pay</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let record of viewRunRecords; let i = index"
                [class.selected]="isViewSelected(record)">
              <td class="checkbox-col">
                <input type="checkbox"
                       [checked]="isViewSelected(record)"
                       [disabled]="record.status === 'PROCESSED'"
                       (change)="toggleViewRecord(record)">
              </td>
              <td>{{ i + 1 }}</td>
              <td>{{ getEmployeeCode(record) }}</td>
              <td class="employee-name">{{ getEmployeeName(record) }}</td>
              <td>
                <span class="emp-type">{{ record.employeeType || 'Full-Time' }}</span>
              </td>
              <td class="number-col">{{ getRecordHours(record) | number:'1.1-1' }}h</td>
              <td class="number-col amount-green">${{ record.grossPay?.toFixed(2) || '0.00' }}</td>
              <td class="number-col">${{ record.reimbursements?.toFixed(2) || '0.00' }}</td>
              <td class="number-col">${{ record.federalTax?.toFixed(2) || '0.00' }}</td>
              <td class="number-col">${{ record.stateTax?.toFixed(2) || '0.00' }}</td>
              <td class="number-col">${{ record.socialSecurityTax?.toFixed(2) || '0.00' }}</td>
              <td class="number-col">${{ record.medicareTax?.toFixed(2) || '0.00' }}</td>
              <td class="number-col amount-green">${{ getRecordTotalTax(record) | number:'1.2-2' }}</td>
              <td class="number-col amount-green">${{ record.netPay?.toFixed(2) || '0.00' }}</td>
              <td>
                <span class="status-badge" [ngClass]="getStatusClass(record.status || 'CALCULATED')">
                  {{ record.status === 'PROCESSED' ? 'processed' : 'calculated' }}
                </span>
              </td>
              <td>
                <a class="select-link" (click)="toggleViewRecord(record)" *ngIf="record.status !== 'PROCESSED'">Select</a>
              </td>
            </tr>
            <tr *ngIf="viewRunRecords.length === 0">
              <td colspan="16" class="no-data">No records found</td>
            </tr>
          </tbody>
          <tfoot *ngIf="viewRunRecords.length > 0">
            <tr class="totals-row">
              <td colspan="6"><strong>TOTAL</strong></td>
              <td class="number-col amount-green"><strong>${{ getViewRecordTotalGross() | number:'1.2-2' }}</strong></td>
              <td class="number-col"><strong>${{ getViewRecordTotalReimbursements() | number:'1.2-2' }}</strong></td>
              <td class="number-col"><strong>${{ getViewRecordTotalFederal() | number:'1.2-2' }}</strong></td>
              <td class="number-col"><strong>${{ getViewRecordTotalState() | number:'1.2-2' }}</strong></td>
              <td class="number-col"><strong>${{ getViewRecordTotalSocSec() | number:'1.2-2' }}</strong></td>
              <td class="number-col"><strong>${{ getViewRecordTotalMedicare() | number:'1.2-2' }}</strong></td>
              <td class="number-col amount-green"><strong>${{ getViewRecordTotalTax() | number:'1.2-2' }}</strong></td>
              <td class="number-col amount-green"><strong>${{ getViewRecordTotalNet() | number:'1.2-2' }}</strong></td>
              <td colspan="2"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
    <div class="modal-footer details-footer">
      <div class="footer-left">
        <span class="selected-count" *ngIf="viewSelectedIds.size > 0">{{ viewSelectedIds.size }} selected</span>
        <button class="btn btn-process-selected" *ngIf="viewSelectedIds.size > 0" (click)="openProcessConfirmModal()">
          <i class="fas fa-dollar-sign"></i> Process Selected
        </button>
      </div>
      <div class="footer-right">
        <button class="btn btn-secondary" (click)="closeRunDetailsModal()">Close</button>
        <button class="btn btn-primary" *ngIf="viewSelectedIds.size === 0 && getViewUnprocessedCount() > 0" (click)="openProcessConfirmModal()">
          <i class="fas fa-dollar-sign"></i> Process ({{ getViewUnprocessedCount() }})
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showProcessConfirmModal" (click)="closeProcessConfirmModal()">
  <div class="modal process-confirm-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><i class="fas fa-money-check-alt modal-icon"></i> Process Payroll</h3>
      <button class="close-btn" (click)="closeProcessConfirmModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Payment Date</label>
        <input type="date" [(ngModel)]="payDate" class="form-control" />
      </div>
      <div class="form-group">
        <label>Bank Account</label>
        <select [(ngModel)]="bankAccount" class="form-control">
          <option value="">Select bank account</option>
          <option value="main">Main Operating Account</option>
          <option value="payroll">Payroll Account</option>
        </select>
      </div>
      <div class="info-box">
        <i class="fas fa-info-circle"></i>
        <span>{{ viewSelectedIds.size > 0 ? viewSelectedIds.size : getViewUnprocessedCount() }} employee(s) will be processed with status 'Paid'</span>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeProcessConfirmModal()">Cancel</button>
      <button class="btn btn-primary" (click)="confirmAndProcess()" [disabled]="!payDate || processing">
        <i class="fas fa-dollar-sign"></i> {{ processing ? 'Processing...' : 'Confirm & Process' }}
      </button>
    </div>
  </div>
</div>
