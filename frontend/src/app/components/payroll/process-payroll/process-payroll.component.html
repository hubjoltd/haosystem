<div class="process-payroll-container">
  <div class="page-header">
    <div class="header-left">
      <h2>Process Payroll</h2>
      <p class="subtitle">Calculate payroll based on approved timesheets</p>
    </div>
  </div>

  <!-- Filter Section -->
  <div class="select-period-section">
    <div class="period-form">
      <div class="form-group">
        <label>Period Type</label>
        <select [(ngModel)]="periodType" class="form-control">
          <option value="BI_WEEKLY">Bi-Weekly</option>
          <option value="WEEKLY">Weekly</option>
          <option value="MONTHLY">Monthly</option>
          <option value="SEMI_MONTHLY">Semi-Monthly</option>
        </select>
      </div>
      <div class="form-group">
        <label>Project / Site</label>
        <select [(ngModel)]="selectedProject" class="form-control">
          <option value="">All Projects (Company Level)</option>
        </select>
      </div>
      <div class="form-group">
        <label>Start Date</label>
        <input type="date" [(ngModel)]="filterStartDate" class="form-control" />
      </div>
      <div class="form-group">
        <label>End Date</label>
        <input type="date" [(ngModel)]="filterEndDate" class="form-control" />
      </div>
      <div class="form-group btn-group">
        <button class="btn-calculate" (click)="calculatePayroll()" [disabled]="calculating">
          <i class="fas fa-calculator"></i> 
          {{ calculating ? 'Calculating...' : 'Calculate Payroll' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Current Run Bar -->
  <div class="current-run-bar" *ngIf="currentRun">
    <div class="run-info">
      <span class="run-label">{{ selectedProject || 'Company Level' }} - {{ getPeriodLabel() }}</span>
      <span class="run-period">{{ currentRun.periodStartDate }} to {{ currentRun.periodEndDate }}</span>
    </div>
    <button class="btn-clear" (click)="clearCurrentRun()">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <!-- Summary Cards -->
  <div class="summary-cards" *ngIf="currentRun">
    <div class="summary-card blue">
      <span class="card-label">Pending Employees</span>
      <span class="card-value">{{ summary.pendingEmployees }}</span>
    </div>
    <div class="summary-card yellow">
      <span class="card-label">Gross Pay</span>
      <span class="card-value">${{ summary.grossPay.toFixed(2) }}</span>
    </div>
    <div class="summary-card orange">
      <span class="card-label">Net Tax</span>
      <span class="card-value">${{ summary.netTax.toFixed(2) }}</span>
    </div>
    <div class="summary-card green">
      <span class="card-label">Net Pay</span>
      <span class="card-value">${{ summary.netPay.toFixed(2) }}</span>
    </div>
  </div>

  <!-- Payroll Table -->
  <div class="pending-payroll-section" *ngIf="currentRun">
    <div class="section-header">
      <h3>Pending Payroll - Select & Process</h3>
      <button class="btn btn-process" (click)="openProcessModal()" [disabled]="getUnprocessedCount() === 0">
        <i class="fas fa-play"></i> Process
        {{ selectedRecordIds.size > 0 ? '(' + selectedRecordIds.size + ')' : '(' + getUnprocessedCount() + ')' }}
      </button>
    </div>

    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th class="checkbox-col">
              <input type="checkbox" [checked]="isAllSelected()" (change)="toggleSelectAll($event)">
            </th>
            <th>EMP ID</th>
            <th>NAME</th>
            <th>PROJECT</th>
            <th class="number-col">HOURS</th>
            <th class="number-col">RATE</th>
            <th class="number-col">GROSS</th>
            <th class="number-col">SOC.SEC</th>
            <th class="number-col">MEDICARE</th>
            <th class="number-col">FED TAX</th>
            <th class="number-col">STATE TAX</th>
            <th class="number-col">NET PAY</th>
            <th>STATUS</th>
            <th>ACTION</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let record of payrollRecords; let i = index" 
              [class.selected]="isSelected(record)"
              [class.processed]="record.status === 'PROCESSED'">
            <td class="checkbox-col">
              <input type="checkbox" 
                     [checked]="isSelected(record)" 
                     [disabled]="record.status === 'PROCESSED'"
                     (change)="toggleRecord(record)">
            </td>
            <td>{{ getEmployeeCode(record) }}</td>
            <td class="employee-name">{{ getEmployeeName(record) }}</td>
            <td>{{ record.projectCode || 'Company Level' }}</td>
            <td class="number-col">{{ (record.regularHours || 0) + (record.overtimeHours || 0) | number:'1.2-2' }}</td>
            <td class="number-col">${{ record.hourlyRate?.toFixed(2) || '0.00' }}</td>
            <td class="number-col">${{ record.grossPay?.toFixed(2) || '0.00' }}</td>
            <td class="number-col">${{ record.socialSecurityTax?.toFixed(2) || '0.00' }}</td>
            <td class="number-col">${{ record.medicareTax?.toFixed(2) || '0.00' }}</td>
            <td class="number-col">${{ record.federalTax?.toFixed(2) || '0.00' }}</td>
            <td class="number-col">${{ record.stateTax?.toFixed(2) || '0.00' }}</td>
            <td class="number-col amount-net">${{ record.netPay?.toFixed(2) || '0.00' }}</td>
            <td>
              <span class="status-badge" [ngClass]="getStatusClass(record.status || 'PENDING')">
                {{ record.status === 'PROCESSED' ? 'Processed' : 'Pending Payment' }}
              </span>
            </td>
            <td class="actions-col">
              <button class="btn-icon" (click)="viewPayStub(record)" title="View Pay Stub">
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn-icon download" *ngIf="record.status === 'PROCESSED'" (click)="downloadPayslip(record)" title="Download">
                <i class="fas fa-download"></i>
              </button>
            </td>
          </tr>
          <tr *ngIf="payrollRecords.length === 0">
            <td colspan="14" class="no-data">No payroll records found. Calculate payroll to generate records from approved timesheets.</td>
          </tr>
        </tbody>
        <tfoot *ngIf="payrollRecords.length > 0">
          <tr class="totals-row">
            <td colspan="6"><strong>TOTAL</strong></td>
            <td class="number-col"><strong>${{ summary.grossPay.toFixed(2) }}</strong></td>
            <td colspan="4"></td>
            <td class="number-col"><strong>${{ summary.netPay.toFixed(2) }}</strong></td>
            <td colspan="2"></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- Empty State when no current run -->
  <div class="empty-state-section" *ngIf="!currentRun && !loading">
    <div class="empty-icon">
      <i class="fas fa-calculator"></i>
    </div>
    <p>Select a pay period and click "Calculate Payroll" to generate payroll from approved timesheets.</p>
  </div>

  <div class="loading-state" *ngIf="loading">
    <i class="fas fa-spinner fa-spin"></i> Loading...
  </div>
</div>

<!-- Process Payroll Modal -->
<div class="modal-overlay" *ngIf="showProcessModal" (click)="closeProcessModal()">
  <div class="modal process-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Process Payroll</h3>
      <button class="close-btn" (click)="closeProcessModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="process-info">
        <p><strong>Employees to process:</strong> {{ selectedRecordIds.size > 0 ? selectedRecordIds.size : getUnprocessedCount() }}</p>
      </div>
      
      <div class="form-group">
        <label>Pay Date <span class="required">*</span></label>
        <input type="date" [(ngModel)]="payDate" class="form-control" required />
      </div>

      <p class="warning-text">
        <i class="fas fa-exclamation-triangle"></i>
        Once processed, records will be marked as "Paid"
      </p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeProcessModal()">Cancel</button>
      <button class="btn btn-primary" (click)="processPayroll()" [disabled]="!payDate || processing">
        <i class="fas fa-check"></i> {{ processing ? 'Processing...' : 'Process Payroll' }}
      </button>
    </div>
  </div>
</div>

<!-- Pay Stub Modal -->
<div class="modal-overlay" *ngIf="showPayStubModal && selectedRecord" (click)="closePayStubModal()">
  <div class="modal paystub-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Pay Stub - {{ getEmployeeName(selectedRecord) }}</h3>
      <button class="close-btn" (click)="closePayStubModal()">&times;</button>
    </div>
    <div class="modal-body" *ngIf="selectedRecord">
      <div class="paystub-header">
        <h4>PAY STUB</h4>
        <p>Pay Period: {{ currentRun?.periodStartDate }} to {{ currentRun?.periodEndDate }}</p>
      </div>

      <div class="paystub-section">
        <div class="info-row">
          <span class="label">EMPLOYEE INFORMATION</span>
        </div>
        <div class="detail-row">
          <span>Employee ID</span>
          <span>{{ getEmployeeCode(selectedRecord) }}</span>
        </div>
        <div class="detail-row">
          <span>Name</span>
          <span>{{ getEmployeeName(selectedRecord) }}</span>
        </div>
        <div class="detail-row">
          <span>Department</span>
          <span>{{ selectedRecord.employee?.department?.name || 'N/A' }}</span>
        </div>
      </div>

      <div class="paystub-section">
        <div class="info-row">
          <span class="label">EARNINGS</span>
        </div>
        <div class="detail-row">
          <span>Regular Hours ({{ selectedRecord.regularHours?.toFixed(1) || '0.0' }} hrs)</span>
          <span>${{ selectedRecord.basePay?.toFixed(2) || '0.00' }}</span>
        </div>
        <div class="detail-row" *ngIf="selectedRecord.overtimeHours && selectedRecord.overtimeHours > 0">
          <span>Overtime ({{ selectedRecord.overtimeHours.toFixed(1) }} hrs Ã— 1.5)</span>
          <span>${{ selectedRecord.overtimePay?.toFixed(2) || '0.00' }}</span>
        </div>
        <div class="detail-row total">
          <span>Gross Pay</span>
          <span>${{ selectedRecord.grossPay?.toFixed(2) || '0.00' }}</span>
        </div>
      </div>

      <div class="paystub-section">
        <div class="info-row">
          <span class="label">DEDUCTIONS</span>
        </div>
        <div class="detail-row">
          <span>Federal Tax</span>
          <span>-${{ selectedRecord.federalTax?.toFixed(2) || '0.00' }}</span>
        </div>
        <div class="detail-row">
          <span>State Tax</span>
          <span>-${{ selectedRecord.stateTax?.toFixed(2) || '0.00' }}</span>
        </div>
        <div class="detail-row">
          <span>Social Security (6.2%)</span>
          <span>-${{ selectedRecord.socialSecurityTax?.toFixed(2) || '0.00' }}</span>
        </div>
        <div class="detail-row">
          <span>Medicare (1.45%)</span>
          <span>-${{ selectedRecord.medicareTax?.toFixed(2) || '0.00' }}</span>
        </div>
        <div class="detail-row total">
          <span>Total Deductions</span>
          <span>-${{ selectedRecord.totalDeductions?.toFixed(2) || '0.00' }}</span>
        </div>
      </div>

      <div class="paystub-section net-section">
        <div class="net-pay-row">
          <span>NET PAY</span>
          <span>${{ selectedRecord.netPay?.toFixed(2) || '0.00' }}</span>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closePayStubModal()">Close</button>
      <button class="btn btn-primary" (click)="downloadPayslip(selectedRecord!)" *ngIf="selectedRecord">
        <i class="fas fa-download"></i> Print
      </button>
    </div>
  </div>
</div>
