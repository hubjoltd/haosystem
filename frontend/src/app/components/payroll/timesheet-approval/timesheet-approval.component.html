<div class="attendance-payroll-approval">
  <div class="page-header">
    <div class="header-left">
      <h1>Attendance & Payroll Approval</h1>
      <p class="subtitle">Approved attendance data and payroll processing</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-outline-primary" (click)="goToStep(5)">
        <i class="fas fa-history"></i> View Payroll History
      </button>
    </div>
  </div>

  <div class="message-bar" *ngIf="message" [ngClass]="messageType">
    {{ message }}
  </div>

  <div class="step-wizard-new">
    <div class="step-item" [class.active]="currentStep === 0" [class.completed]="currentStep > 0" (click)="goToStep(0)">
      <div class="step-circle">
        <i class="fas" [ngClass]="currentStep > 0 ? 'fa-check' : 'fa-clipboard-check'"></i>
      </div>
      <div class="step-line" [class.completed]="currentStep > 0"></div>
      <div class="step-text">
        <span class="step-number">Step 1:</span>
        <span class="step-title">Approved Attendance</span>
      </div>
    </div>

    <div class="step-item" [class.active]="currentStep === 1" [class.completed]="currentStep > 1" (click)="goToStep(1)">
      <div class="step-circle">
        <i class="fas" [ngClass]="currentStep > 1 ? 'fa-check' : 'fa-file-alt'"></i>
      </div>
      <div class="step-line" [class.completed]="currentStep > 1"></div>
      <div class="step-text">
        <span class="step-number">Step 2:</span>
        <span class="step-title">Generate Timesheets</span>
      </div>
    </div>

    <div class="step-item" [class.active]="currentStep === 2" [class.completed]="currentStep > 2" (click)="goToStep(2)">
      <div class="step-circle">
        <i class="fas" [ngClass]="currentStep > 2 ? 'fa-check' : 'fa-dollar-sign'"></i>
      </div>
      <div class="step-line" [class.completed]="currentStep > 2"></div>
      <div class="step-text">
        <span class="step-number">Step 3:</span>
        <span class="step-title">Calculate Payroll</span>
      </div>
    </div>

    <div class="step-item" [class.active]="currentStep === 3" [class.completed]="currentStep > 3" (click)="goToStep(3)">
      <div class="step-circle">
        <i class="fas" [ngClass]="currentStep > 3 ? 'fa-check' : 'fa-cog'"></i>
      </div>
      <div class="step-line" [class.completed]="currentStep > 3"></div>
      <div class="step-text">
        <span class="step-number">Step 4:</span>
        <span class="step-title">Process Payroll</span>
      </div>
    </div>

    <div class="step-item" [class.active]="currentStep === 4" (click)="goToStep(5)">
      <div class="step-circle">
        <i class="fas fa-history"></i>
      </div>
      <div class="step-text">
        <span class="step-number">Step 5:</span>
        <span class="step-title">Payroll History</span>
      </div>
    </div>
  </div>

  <!-- Step 1: Approved Attendance (Auto-Load) -->
  <div class="step-content" *ngIf="currentStep === 0">
    <div class="section-box">
      <div class="step-header">
        <h3>Step 1: Approved Attendance Data</h3>
        <p class="period-info">Showing approved attendance records</p>
      </div>

      <div class="form-grid compact">
        <div class="form-group">
          <label>Start Date</label>
          <input type="date" [(ngModel)]="approvedStartDate" (change)="onApprovedDateChange()" />
        </div>
        <div class="form-group">
          <label>End Date</label>
          <input type="date" [(ngModel)]="approvedEndDate" (change)="onApprovedDateChange()" />
        </div>
      </div>

      <div class="summary-stats-row">
        <div class="stat-box blue">
          <div class="stat-icon"><i class="fas fa-users"></i></div>
          <div class="stat-info">
            <span class="stat-label">Employees</span>
            <span class="stat-value">{{ totalApprovedEmployees }}</span>
          </div>
        </div>
        <div class="stat-box green">
          <div class="stat-icon"><i class="fas fa-calendar-check"></i></div>
          <div class="stat-info">
            <span class="stat-label">Records</span>
            <span class="stat-value">{{ totalApprovedRecords }}</span>
          </div>
        </div>
        <div class="stat-box purple">
          <div class="stat-icon"><i class="fas fa-clock"></i></div>
          <div class="stat-info">
            <span class="stat-label">Total Hours</span>
            <span class="stat-value">{{ totalApprovedHours.toFixed(1) }}h</span>
          </div>
        </div>
        <div class="stat-box orange">
          <div class="stat-icon"><i class="fas fa-hourglass-half"></i></div>
          <div class="stat-info">
            <span class="stat-label">Overtime</span>
            <span class="stat-value">{{ totalApprovedOT.toFixed(1) }}h</span>
          </div>
        </div>
      </div>

      <div class="sub-section">
        <h4><i class="fas fa-check-circle"></i> Approved Attendance Records</h4>
      </div>

      <div class="loading-indicator" *ngIf="loading">
        <i class="fas fa-spinner fa-spin"></i> Loading approved attendance...
      </div>

      <div class="table-container" *ngIf="!loading">
        <table class="data-table">
          <thead>
            <tr>
              <th>#</th>
              <th>EMP ID</th>
              <th>NAME</th>
              <th>DEPARTMENT</th>
              <th>DATE</th>
              <th>CLOCK IN</th>
              <th>CLOCK OUT</th>
              <th>HOURS</th>
              <th>OT</th>
              <th>STATUS</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let record of approvedAttendanceRecords; let i = index">
              <td>{{ i + 1 }}</td>
              <td class="emp-id">{{ record.employeeCode }}</td>
              <td class="emp-name">{{ record.employeeName }}</td>
              <td>{{ record.department }}</td>
              <td>{{ formatDateDisplay(record.attendanceDate) }}</td>
              <td>{{ record.clockIn }}</td>
              <td>{{ record.clockOut }}</td>
              <td class="hours">{{ record.regularHours.toFixed(1) }}</td>
              <td class="hours">{{ record.overtimeHours.toFixed(1) }}</td>
              <td>
                <span class="status-badge approved">{{ record.status }}</span>
              </td>
            </tr>
            <tr *ngIf="approvedAttendanceRecords.length === 0 && !loading">
              <td colspan="10" class="no-data">
                <i class="fas fa-calendar-times"></i>
                No approved attendance records found for this period
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="step-actions-bar">
        <div class="left-actions">
          <span class="selected-info">{{ approvedAttendanceRecords.length }} approved records</span>
        </div>
        <div class="right-actions">
          <button class="btn btn-primary" (click)="goToStep(1)">
            Next: Generate Timesheets <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Step 2: Generate Timesheet -->
  <div class="step-content" *ngIf="currentStep === 1">
    <div class="section-box">
      <div class="step-header">
        <h3>Step 2: Generate Timesheet Summary</h3>
        <p class="period-info">Period: {{ generateStartDate }} - {{ generateEndDate }} ({{ getPayPeriodTypeLabel() }})</p>
      </div>

      <div class="form-grid compact">
        <div class="form-group">
          <label>Pay Period Type</label>
          <select [(ngModel)]="selectedPayPeriodType" (change)="onPayPeriodTypeChange()">
            <option value="MONTHLY">Monthly</option>
            <option value="WEEKLY">Weekly</option>
            <option value="BI_WEEKLY">Bi-Weekly</option>
            <option value="SEMI_MONTHLY">Semi-Monthly</option>
          </select>
        </div>
        <div class="form-group">
          <label>Period Start</label>
          <input type="date" [(ngModel)]="generateStartDate" />
        </div>
        <div class="form-group">
          <label>Period End</label>
          <input type="date" [(ngModel)]="generateEndDate" />
        </div>
        <div class="form-group" style="display: flex; align-items: flex-end;">
          <button class="btn btn-success" [disabled]="generating" (click)="generateTimesheetsForPeriod()">
            <i class="fas fa-sync" [class.fa-spin]="generating"></i>
            {{ generating ? 'Generating...' : 'Generate Timesheets' }}
          </button>
        </div>
      </div>

      <div class="sub-section">
        <h4><i class="fas fa-file-alt"></i> Generated Timesheets</h4>
      </div>

      <div class="loading-indicator" *ngIf="generating">
        <i class="fas fa-spinner fa-spin"></i> Generating timesheets from approved attendance...
      </div>

      <div class="table-container" *ngIf="!generating">
        <table class="data-table generated-timesheet-table">
          <thead>
            <tr>
              <th>#</th>
              <th>EMP ID</th>
              <th>FIRST NAME</th>
              <th>LAST NAME</th>
              <th>DEPARTMENT</th>
              <th>REG HOURS</th>
              <th>OT HOURS</th>
              <th>TOTAL HOURS</th>
              <th>STATUS</th>
              <th>ACTION</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let ts of generatedTimesheets; let i = index">
              <td>{{ i + 1 }}</td>
              <td class="emp-id">{{ ts.employeeCode }}</td>
              <td class="emp-name">{{ ts.firstName }}</td>
              <td class="emp-name">{{ ts.lastName }}</td>
              <td>{{ ts.department }}</td>
              <td class="hours">{{ ts.totalRegularHours.toFixed(1) }}</td>
              <td class="hours">{{ ts.totalOvertimeHours.toFixed(1) }}</td>
              <td class="hours total">{{ ts.totalHours.toFixed(1) }}</td>
              <td>
                <span class="status-badge approved">{{ ts.status }}</span>
              </td>
              <td class="action-col">
                <button class="btn btn-sm btn-info" (click)="viewTimesheet(ts)" title="View Timesheet">
                  <i class="fas fa-eye"></i> View
                </button>
                <button class="btn btn-sm btn-primary" (click)="downloadTimesheetPDF(ts)" title="Download PDF">
                  <i class="fas fa-file-pdf"></i> PDF
                </button>
              </td>
            </tr>
            <tr *ngIf="generatedTimesheets.length === 0 && !generating">
              <td colspan="10" class="no-data">
                <i class="fas fa-file-alt"></i>
                No timesheets generated yet. Click "Generate Timesheets" to create from approved attendance.
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="step-actions-bar">
        <div class="left-actions">
          <span class="selected-info">{{ generatedTimesheets.length }} timesheets generated</span>
        </div>
        <div class="right-actions">
          <button class="btn btn-outline-secondary" (click)="goToStep(0)">
            <i class="fas fa-arrow-left"></i> Back
          </button>
          <button class="btn btn-primary" (click)="goToStep(2)">
            Next: Calculate Payroll <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Individual Timesheet Modal -->
  <div class="modal-overlay" *ngIf="showTimesheetModal" (click)="closeTimesheetModal()">
    <div class="modal-content timesheet-modal" (click)="$event.stopPropagation()">
      <div class="modal-header blue-header">
        <h3>Individual Timesheet</h3>
        <button class="close-btn" (click)="closeTimesheetModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="employee-info-bar" *ngIf="selectedTimesheetEmployee">
          <div class="info-item">
            <span class="label">Employee ID:</span>
            <span class="value">{{ selectedTimesheetEmployee.employeeCode }}</span>
          </div>
          <div class="info-item">
            <span class="label">Name:</span>
            <span class="value">{{ selectedTimesheetEmployee.firstName }} {{ selectedTimesheetEmployee.lastName }}</span>
          </div>
          <div class="info-item">
            <span class="label">Department:</span>
            <span class="value">{{ selectedTimesheetEmployee.department }}</span>
          </div>
          <div class="info-item">
            <span class="label">Period:</span>
            <span class="value">{{ generateStartDate }} - {{ generateEndDate }}</span>
          </div>
        </div>
        
        <table class="data-table individual-timesheet-table">
          <thead>
            <tr>
              <th>S.No</th>
              <th>Date</th>
              <th>Day</th>
              <th>Clock In</th>
              <th>Clock Out</th>
              <th>Lunch Hour</th>
              <th>Reg Hours</th>
              <th>OT Hours</th>
              <th>Total Hours</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of individualTimesheetRows">
              <td>{{ row.sno }}</td>
              <td>{{ row.date }}</td>
              <td>{{ row.day }}</td>
              <td>{{ row.clockIn }}</td>
              <td>{{ row.clockOut }}</td>
              <td>1:00</td>
              <td class="hours">{{ row.regHours.toFixed(1) }}</td>
              <td class="hours">{{ row.otHours.toFixed(1) }}</td>
              <td class="hours total">{{ row.totalHours.toFixed(1) }}</td>
              <td>
                <span class="status-badge approved">{{ row.status }}</span>
              </td>
            </tr>
          </tbody>
          <tfoot *ngIf="selectedTimesheetEmployee">
            <tr class="summary-row">
              <td colspan="6" class="text-right"><strong>TOTALS:</strong></td>
              <td class="hours"><strong>{{ selectedTimesheetEmployee.totalRegularHours.toFixed(1) }}</strong></td>
              <td class="hours"><strong>{{ selectedTimesheetEmployee.totalOvertimeHours.toFixed(1) }}</strong></td>
              <td class="hours total"><strong>{{ selectedTimesheetEmployee.totalHours.toFixed(1) }}</strong></td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" (click)="closeTimesheetModal()">Close</button>
        <button class="btn btn-primary" (click)="downloadTimesheetPDF(selectedTimesheetEmployee!)" *ngIf="selectedTimesheetEmployee">
          <i class="fas fa-file-pdf"></i> Download PDF
        </button>
      </div>
    </div>
  </div>

  <!-- Step 3: Calculate Payroll -->
  <div class="step-content" *ngIf="currentStep === 2">
    <div class="section-box">
      <div class="payroll-summary-cards">
        <div class="payroll-card green">
          <span class="card-label">Total Gross Pay</span>
          <span class="card-value">{{ formatCurrency(totalGrossPay) }}</span>
        </div>
        <div class="payroll-card red">
          <span class="card-label">Total Taxes</span>
          <span class="card-value">{{ formatCurrency(totalGrossPay * 0.22) }}</span>
        </div>
        <div class="payroll-card blue">
          <span class="card-label">Total Net Pay</span>
          <span class="card-value">{{ formatCurrency(totalNetPay) }}</span>
        </div>
        <div class="payroll-card purple">
          <span class="card-label">Employees</span>
          <span class="card-value">{{ selectedCalcEmployeeIds.length }}</span>
        </div>
      </div>

      <div class="step-header">
        <h3>Step 3: Select Employees to Calculate Payroll</h3>
        <p class="period-info">Period: {{ generateStartDate }} - {{ generateEndDate }}</p>
      </div>

      <div class="sub-section">
        <h4><i class="fas fa-calculator"></i> Employee Payroll Calculation</h4>
      </div>

      <div class="loading-indicator" *ngIf="payablesLoading">
        <i class="fas fa-spinner fa-spin"></i> Loading payroll data...
      </div>

      <div class="table-container" *ngIf="!payablesLoading">
        <table class="data-table payroll-calc-table">
          <thead>
            <tr>
              <th class="checkbox-col">
                <input type="checkbox" [checked]="allCalcEmployeesSelected" (change)="toggleAllCalcEmployees()" />
              </th>
              <th>#</th>
              <th>EMP ID</th>
              <th>NAME</th>
              <th>HOURS</th>
              <th>HOURLY RATE</th>
              <th>GROSS PAY</th>
              <th>TOTAL TAX</th>
              <th>NET PAY</th>
              <th>STATUS</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let emp of payableEmployees; let i = index">
              <td class="checkbox-col">
                <input type="checkbox" [checked]="isCalcEmployeeSelected(emp.employeeId)" (change)="toggleCalcEmployeeSelection(emp.employeeId)" />
              </td>
              <td>{{ i + 1 }}</td>
              <td class="emp-id">{{ emp.empId }}</td>
              <td class="emp-name">{{ emp.name }}</td>
              <td>{{ emp.hours.toFixed(2) }} hrs</td>
              <td>{{ formatCurrency(emp.hourlyRate) }}/hr</td>
              <td class="green-text">{{ formatCurrency(emp.hours * emp.hourlyRate) }}</td>
              <td class="red-text">{{ formatCurrency(emp.taxes) }}</td>
              <td class="green-text">{{ formatCurrency(emp.netAmount) }}</td>
              <td>
                <span class="status-badge" [ngClass]="emp.status === 'Ready' ? 'approved' : 'pending'">
                  {{ emp.status }}
                </span>
              </td>
            </tr>
            <tr *ngIf="payableEmployees.length === 0">
              <td colspan="10" class="no-data">
                <i class="fas fa-calculator"></i>
                No payroll data. Generate timesheets first.
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="step-actions-bar">
        <div class="left-actions">
          <span class="selected-info">{{ selectedCalcEmployeeIds.length }} employees selected</span>
        </div>
        <div class="right-actions">
          <button class="btn btn-outline-secondary" (click)="goToStep(1)">
            <i class="fas fa-arrow-left"></i> Back
          </button>
          <button class="btn btn-success" [disabled]="selectedCalcEmployeeIds.length === 0" (click)="calculateSelectedPayroll()">
            <i class="fas fa-calculator"></i> Calculate Payroll
          </button>
          <button class="btn btn-primary" (click)="goToStep(3)">
            Next: Process Payroll <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Step 4: Process Payroll -->
  <div class="step-content" *ngIf="currentStep === 3">
    <div class="section-box">
      <div class="step-header">
        <h3>Step 4: Process Payroll</h3>
        <p class="period-info">Review and finalize payroll for processing</p>
      </div>

      <div class="payroll-summary-cards">
        <div class="payroll-card green">
          <span class="card-label">Total Gross Pay</span>
          <span class="card-value">{{ formatCurrency(totalGrossPay) }}</span>
        </div>
        <div class="payroll-card red">
          <span class="card-label">Total Taxes</span>
          <span class="card-value">{{ formatCurrency(totalGrossPay * 0.22) }}</span>
        </div>
        <div class="payroll-card blue">
          <span class="card-label">Total Net Pay</span>
          <span class="card-value">{{ formatCurrency(totalNetPay) }}</span>
        </div>
        <div class="payroll-card purple">
          <span class="card-label">Employees</span>
          <span class="card-value">{{ employeesToProcess }}</span>
        </div>
      </div>

      <div class="sub-section">
        <h4><i class="fas fa-cog"></i> Select Employees for Final Processing</h4>
      </div>

      <div class="table-container">
        <table class="data-table process-table">
          <thead>
            <tr>
              <th class="checkbox-col">
                <input type="checkbox" [checked]="areAllPayablesSelected()" (change)="selectAllPayables()" />
              </th>
              <th>#</th>
              <th>EMP ID</th>
              <th>NAME</th>
              <th>HOURS</th>
              <th>HOURLY RATE</th>
              <th>GROSS PAY</th>
              <th>TAXES</th>
              <th>NET PAY</th>
              <th>STATUS</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let emp of payableEmployees; let i = index" [class.selected]="emp.selected">
              <td class="checkbox-col">
                <input type="checkbox" [checked]="emp.selected" (change)="togglePayableSelection(emp)" />
              </td>
              <td>{{ i + 1 }}</td>
              <td class="emp-id">{{ emp.empId }}</td>
              <td class="emp-name">{{ emp.name }}</td>
              <td>{{ emp.hours.toFixed(2) }} hrs</td>
              <td>{{ formatCurrency(emp.hourlyRate) }}/hr</td>
              <td class="green-text">{{ formatCurrency(emp.hours * emp.hourlyRate) }}</td>
              <td class="red-text">{{ formatCurrency(emp.taxes) }}</td>
              <td class="green-text">{{ formatCurrency(emp.netAmount) }}</td>
              <td>
                <span class="status-badge" [ngClass]="emp.status === 'Processed' ? 'approved' : 'pending'">
                  {{ emp.status }}
                </span>
              </td>
            </tr>
            <tr *ngIf="payableEmployees.length === 0">
              <td colspan="10" class="no-data">
                <i class="fas fa-users"></i>
                No employees ready for processing
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="step-actions-bar">
        <div class="left-actions">
          <span class="selected-info">{{ employeesToProcess }} employees selected</span>
        </div>
        <div class="right-actions">
          <button class="btn btn-outline-secondary" (click)="goToStep(2)">
            <i class="fas fa-arrow-left"></i> Back
          </button>
          <button class="btn btn-success" [disabled]="employeesToProcess === 0" (click)="processPayables()">
            <i class="fas fa-check-circle"></i> Process Payroll
          </button>
          <button class="btn btn-primary" (click)="goToStep(5)">
            View Payroll History <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Payroll Summary Section after processing -->
  <div class="payroll-summary-section" *ngIf="showPayrollSummary && currentStep === 3">
    <div class="section-box summary-box">
      <div class="summary-header">
        <h3><i class="fas fa-check-circle text-success"></i> Payroll Processed Successfully</h3>
        <button class="btn btn-sm btn-outline" (click)="closeSummary()">
          <i class="fas fa-times"></i> Close
        </button>
      </div>

      <div class="summary-stats">
        <div class="stat-item">
          <span class="stat-value">{{ processedSalariedEmployees.length + processedHourlyEmployees.length }}</span>
          <span class="stat-label">Employees Processed</span>
        </div>
        <div class="stat-item">
          <span class="stat-value">{{ formatCurrency(processedNetTotal) }}</span>
          <span class="stat-label">Net Total Amount</span>
        </div>
      </div>

      <div class="category-section" *ngIf="processedSalariedEmployees.length > 0">
        <h4><i class="fas fa-users"></i> Salaried Employees ({{ processedSalariedEmployees.length }})</h4>
        <table class="data-table summary-table">
          <thead>
            <tr>
              <th>EMP ID</th>
              <th>NAME</th>
              <th>Basic</th>
              <th>Gross</th>
              <th>Taxes</th>
              <th>Net Amount</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let emp of processedSalariedEmployees">
              <td class="emp-id">{{ emp.empId }}</td>
              <td class="emp-name">{{ emp.name }}</td>
              <td>{{ formatCurrency(emp.basic) }}</td>
              <td>{{ formatCurrency(emp.gross) }}</td>
              <td class="tax-col">{{ formatCurrency(emp.taxes) }}</td>
              <td class="net-amount">{{ formatCurrency(emp.netAmount) }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="category-section" *ngIf="processedHourlyEmployees.length > 0">
        <h4><i class="fas fa-clock"></i> Hourly Employees ({{ processedHourlyEmployees.length }})</h4>
        <table class="data-table summary-table">
          <thead>
            <tr>
              <th>EMP ID</th>
              <th>NAME</th>
              <th>Basic</th>
              <th>Gross</th>
              <th>Taxes</th>
              <th>Net Amount</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let emp of processedHourlyEmployees">
              <td class="emp-id">{{ emp.empId }}</td>
              <td class="emp-name">{{ emp.name }}</td>
              <td>{{ formatCurrency(emp.basic) }}</td>
              <td>{{ formatCurrency(emp.gross) }}</td>
              <td class="tax-col">{{ formatCurrency(emp.taxes) }}</td>
              <td class="net-amount">{{ formatCurrency(emp.netAmount) }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="grand-total">
        <span>Grand Total Net Amount:</span>
        <span class="total-value">{{ formatCurrency(processedNetTotal) }}</span>
      </div>
    </div>
  </div>
</div>
