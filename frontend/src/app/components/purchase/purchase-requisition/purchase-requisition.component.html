<div class="page-container">
  <div class="page-header">
    <h1>Purchase Requisition</h1>
    <button class="btn-primary" (click)="openNewModal()">
      <i class="fa fa-plus"></i> New Requisition
    </button>
  </div>

  <div class="toolbar">
    <div class="search-box">
      <i class="fa fa-search"></i>
      <input type="text" placeholder="Search Requisitions" [(ngModel)]="searchTerm" />
    </div>
    <div class="toolbar-right">
      <div class="view-toggle">
        <button class="toggle-btn" [class.active]="viewMode === 'kanban'" (click)="viewMode = 'kanban'" title="Kanban View">
          <i class="fa fa-columns"></i>
        </button>
        <button class="toggle-btn" [class.active]="viewMode === 'table'" (click)="viewMode = 'table'" title="Table View">
          <i class="fa fa-table"></i>
        </button>
      </div>
      <div class="sort-options" *ngIf="viewMode === 'kanban'">
        <span>Sort By:</span>
        <span *ngFor="let opt of sortOptions" 
              class="sort-link" 
              [class.active]="currentSort === opt.value"
              (click)="currentSort = opt.value">
          {{ opt.label }}
        </span>
      </div>
    </div>
  </div>

  <div class="kanban-board" *ngIf="viewMode === 'kanban'">
    <div class="kanban-column draft">
      <div class="column-header">
        <span class="column-title">Draft</span>
        <span class="column-count">{{ getFilteredPRs(draftPRs).length }} Requisitions</span>
      </div>
      <div class="column-body">
        <div class="pr-card" *ngFor="let pr of getFilteredPRs(draftPRs)" (click)="viewPR(pr)">
          <div class="card-header">
            <span class="pr-number">{{ pr.prNumber }}</span>
            <span class="priority-badge" [ngClass]="getPriorityClass(pr.priority)">{{ pr.priority }}</span>
          </div>
          <div class="card-department">{{ pr.department }}</div>
          <div class="card-details">
            <div class="detail-row">
              <span class="label">Date:</span>
              <span class="value">{{ formatDate(pr.prDate) }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Required:</span>
              <span class="value">{{ formatDate(pr.requiredDate) }}</span>
            </div>
          </div>
          <div class="card-footer">
            <span class="comments"><i class="fa fa-comments"></i> Comments: {{ pr.commentsCount || 0 }}</span>
            <div class="card-actions">
              <button class="btn-icon print" (click)="printPR(pr); $event.stopPropagation()" title="Print">
                <i class="fa fa-print"></i>
              </button>
              <button class="btn-icon" (click)="openEditModal(pr); $event.stopPropagation()" title="Edit">
                <i class="fa fa-edit"></i>
              </button>
              <button class="btn-icon delete" (click)="deletePR(pr); $event.stopPropagation()" title="Delete">
                <i class="fa fa-trash"></i>
              </button>
            </div>
          </div>
        </div>
        <div class="empty-column" *ngIf="getFilteredPRs(draftPRs).length === 0">
          <i class="fa fa-file-alt"></i>
          <span>No Draft Requisitions</span>
        </div>
      </div>
    </div>

    <div class="kanban-column submitted">
      <div class="column-header">
        <span class="column-title">Submitted</span>
        <span class="column-count">{{ getFilteredPRs(submittedPRs).length }} Requisitions</span>
      </div>
      <div class="column-body">
        <div class="pr-card" *ngFor="let pr of getFilteredPRs(submittedPRs)" (click)="viewPR(pr)">
          <div class="card-header">
            <span class="pr-number">{{ pr.prNumber }}</span>
            <span class="priority-badge" [ngClass]="getPriorityClass(pr.priority)">{{ pr.priority }}</span>
          </div>
          <div class="card-department">{{ pr.department }}</div>
          <div class="card-details">
            <div class="detail-row">
              <span class="label">Date:</span>
              <span class="value">{{ formatDate(pr.prDate) }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Required:</span>
              <span class="value">{{ formatDate(pr.requiredDate) }}</span>
            </div>
          </div>
          <div class="card-actions-row" *ngIf="canApproveReject(pr)">
            <button class="btn-action approve" (click)="approvePR(pr, $event)" title="Approve">
              <i class="fa fa-check"></i> Approve
            </button>
            <button class="btn-action reject" (click)="rejectPR(pr, $event)" title="Reject">
              <i class="fa fa-times"></i> Reject
            </button>
          </div>
          <div class="card-footer">
            <span class="comments"><i class="fa fa-comments"></i> Comments: {{ pr.commentsCount || 0 }}</span>
          </div>
        </div>
        <div class="empty-column" *ngIf="getFilteredPRs(submittedPRs).length === 0">
          <i class="fa fa-paper-plane"></i>
          <span>No Submitted Requisitions</span>
        </div>
      </div>
    </div>

    <div class="kanban-column approved">
      <div class="column-header">
        <span class="column-title">Approved</span>
        <span class="column-count">{{ getFilteredPRs(approvedPRs).length }} Requisitions</span>
      </div>
      <div class="column-body">
        <div class="pr-card-wrapper" *ngFor="let pr of getFilteredPRs(approvedPRs)">
          <div class="pr-card" [class.expanded]="expandedPRId === pr.id">
            <div class="card-header">
              <span class="pr-number">{{ pr.prNumber }}</span>
              <div class="header-right">
                <span class="priority-badge" [ngClass]="getPriorityClass(pr.priority)">{{ pr.priority }}</span>
                <button class="expand-btn" (click)="togglePRExpand(pr, $event)" [title]="expandedPRId === pr.id ? 'Collapse' : 'Expand'">
                  <i class="fa" [class.fa-chevron-down]="expandedPRId !== pr.id" [class.fa-chevron-up]="expandedPRId === pr.id"></i>
                </button>
              </div>
            </div>
            <div class="card-department">{{ pr.department }}</div>
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="calculateFulfillmentProgress(pr)"></div>
              <span class="progress-text">{{ calculateFulfillmentProgress(pr) }}% Fulfilled</span>
            </div>
            <div class="card-actions-row">
              <button class="btn-action view" (click)="viewPR(pr); $event.stopPropagation()" title="View Details">
                <i class="fa fa-eye"></i>
              </button>
              <button class="btn-action convert" (click)="convertToPO(pr, $event)" title="Convert to PO">
                <i class="fa fa-file-invoice"></i>
              </button>
            </div>
            <div class="card-footer">
              <span class="comments"><i class="fa fa-comments"></i> Comments: {{ pr.commentsCount || 0 }}</span>
            </div>
          </div>
          
          <div class="inline-expand-section" *ngIf="expandedPRId === pr.id">
            <div class="inline-items-section">
              <div class="inline-section-header">
                <h4>Select Items for Fulfillment</h4>
                <span class="selected-count" *ngIf="getSelectedItemsCount() > 0">{{ getSelectedItemsCount() }} selected</span>
              </div>
              <table class="inline-items-table">
                <thead>
                  <tr>
                    <th style="width: 40px;"><input type="checkbox" (change)="toggleAllInlineItems($event)" /></th>
                    <th>Item</th>
                    <th style="width: 80px;">Required</th>
                    <th style="width: 80px;">Fulfilled</th>
                    <th style="width: 80px;">Remaining</th>
                    <th style="width: 90px;">Qty to Fulfill</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of inlineSelectableItems">
                    <td><input type="checkbox" [(ngModel)]="item.selected" /></td>
                    <td>{{ item.itemName }}</td>
                    <td>{{ item.quantity }}</td>
                    <td>{{ item.fulfilledQuantity || 0 }}</td>
                    <td>{{ getRemainingQty(item) }}</td>
                    <td><input type="number" class="inline-qty-input" [(ngModel)]="item.fulfillQty" [max]="getRemainingQty(item)" min="1" [disabled]="!item.selected" /></td>
                  </tr>
                  <tr *ngIf="inlineSelectableItems.length === 0">
                    <td colspan="6" class="no-items">All items have been fulfilled</td>
                  </tr>
                </tbody>
              </table>
              <div class="inline-action-buttons" *ngIf="inlineSelectableItems.length > 0">
                <button class="btn-action stock" (click)="openInlineStockFulfillment(pr, $event)">
                  <i class="fa fa-box"></i> Fulfill from Stock
                </button>
                <button class="btn-action transfer" (click)="openInlineMaterialTransfer(pr, $event)">
                  <i class="fa fa-exchange-alt"></i> Material Transfer
                </button>
              </div>
            </div>
            
            <div class="inline-tabs">
              <div class="tab-headers">
                <button class="tab-header" [class.active]="inlineTabActive === 'purchaseOrders'" (click)="inlineTabActive = 'purchaseOrders'">
                  <i class="fa fa-file-invoice"></i> Purchase Orders ({{ inlinePurchaseOrders.length }})
                </button>
                <button class="tab-header" [class.active]="inlineTabActive === 'stockFulfillments'" (click)="inlineTabActive = 'stockFulfillments'">
                  <i class="fa fa-box"></i> Fulfilled Stocks ({{ inlineStockFulfillments.length }})
                </button>
                <button class="tab-header" [class.active]="inlineTabActive === 'materialTransfers'" (click)="inlineTabActive = 'materialTransfers'">
                  <i class="fa fa-exchange-alt"></i> Material Transfers ({{ inlineMaterialTransfers.length }})
                </button>
              </div>
              
              <div class="tab-content" *ngIf="inlineTabActive === 'purchaseOrders'">
                <table class="inline-data-table" *ngIf="inlinePurchaseOrders.length > 0">
                  <thead>
                    <tr>
                      <th>PO Number</th>
                      <th>Supplier</th>
                      <th>Date</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let po of inlinePurchaseOrders">
                      <td>{{ po.poNumber }}</td>
                      <td>{{ po.supplierName }}</td>
                      <td>{{ formatDate(po.poDate) }}</td>
                      <td><span class="status-badge" [ngClass]="getStatusClass(po.status)">{{ po.status }}</span></td>
                    </tr>
                  </tbody>
                </table>
                <div class="empty-tab" *ngIf="inlinePurchaseOrders.length === 0">No purchase orders created yet</div>
              </div>
              
              <div class="tab-content" *ngIf="inlineTabActive === 'stockFulfillments'">
                <table class="inline-data-table" *ngIf="inlineStockFulfillments.length > 0">
                  <thead>
                    <tr>
                      <th>From Warehouse</th>
                      <th>Supplier</th>
                      <th>Items</th>
                      <th>Date</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let sf of inlineStockFulfillments">
                      <td>{{ sf.warehouseName || '-' }}</td>
                      <td>{{ sf.supplierName || '-' }}</td>
                      <td>{{ sf.items?.length || 0 }} items</td>
                      <td>{{ formatDate(sf.createdAt) }}</td>
                      <td><span class="status-badge status-approved">Fulfilled</span></td>
                    </tr>
                  </tbody>
                </table>
                <div class="empty-tab" *ngIf="inlineStockFulfillments.length === 0">No stock fulfillments yet</div>
              </div>
              
              <div class="tab-content" *ngIf="inlineTabActive === 'materialTransfers'">
                <table class="inline-data-table" *ngIf="inlineMaterialTransfers.length > 0">
                  <thead>
                    <tr>
                      <th>From Project</th>
                      <th>Supplier</th>
                      <th>Items</th>
                      <th>Date</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let mt of inlineMaterialTransfers">
                      <td>{{ mt.projectName || '-' }}</td>
                      <td>{{ mt.supplierName || '-' }}</td>
                      <td>{{ mt.items?.length || 0 }} items</td>
                      <td>{{ formatDate(mt.createdAt) }}</td>
                      <td><span class="status-badge status-approved">Transferred</span></td>
                    </tr>
                  </tbody>
                </table>
                <div class="empty-tab" *ngIf="inlineMaterialTransfers.length === 0">No material transfers yet</div>
              </div>
            </div>
          </div>
        </div>
        <div class="empty-column" *ngIf="getFilteredPRs(approvedPRs).length === 0">
          <i class="fa fa-check-circle"></i>
          <span>No Approved Requisitions</span>
        </div>
      </div>
    </div>

    <div class="kanban-column partial">
      <div class="column-header">
        <span class="column-title">Partially Fulfilled</span>
        <span class="column-count">{{ getFilteredPRs(partiallyFulfilledPRs).length }} Requisitions</span>
      </div>
      <div class="column-body">
        <div class="pr-card-wrapper" *ngFor="let pr of getFilteredPRs(partiallyFulfilledPRs)">
          <div class="pr-card" [class.expanded]="expandedPRId === pr.id">
            <div class="card-header">
              <span class="pr-number">{{ pr.prNumber }}</span>
              <div class="header-right">
                <span class="priority-badge" [ngClass]="getPriorityClass(pr.priority)">{{ pr.priority }}</span>
                <button class="expand-btn" (click)="togglePRExpand(pr, $event)" [title]="expandedPRId === pr.id ? 'Collapse' : 'Expand'">
                  <i class="fa" [class.fa-chevron-down]="expandedPRId !== pr.id" [class.fa-chevron-up]="expandedPRId === pr.id"></i>
                </button>
              </div>
            </div>
            <div class="card-department">{{ pr.department }}</div>
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="calculateFulfillmentProgress(pr)"></div>
              <span class="progress-text">{{ calculateFulfillmentProgress(pr) }}% Fulfilled</span>
            </div>
            <div class="card-actions-row">
              <button class="btn-action view" (click)="viewPR(pr); $event.stopPropagation()" title="View Details">
                <i class="fa fa-eye"></i>
              </button>
              <button class="btn-action convert" (click)="convertToPO(pr, $event)" title="Convert to PO">
                <i class="fa fa-file-invoice"></i>
              </button>
            </div>
            <div class="card-footer">
              <span class="comments"><i class="fa fa-comments"></i> Comments: {{ pr.commentsCount || 0 }}</span>
            </div>
          </div>
          
          <div class="inline-expand-section" *ngIf="expandedPRId === pr.id">
            <div class="inline-items-section">
              <div class="inline-section-header">
                <h4>Select Items for Fulfillment</h4>
                <span class="selected-count" *ngIf="getSelectedItemsCount() > 0">{{ getSelectedItemsCount() }} selected</span>
              </div>
              <table class="inline-items-table">
                <thead>
                  <tr>
                    <th style="width: 40px;"><input type="checkbox" (change)="toggleAllInlineItems($event)" /></th>
                    <th>Item</th>
                    <th style="width: 80px;">Required</th>
                    <th style="width: 80px;">Fulfilled</th>
                    <th style="width: 80px;">Remaining</th>
                    <th style="width: 90px;">Qty to Fulfill</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of inlineSelectableItems">
                    <td><input type="checkbox" [(ngModel)]="item.selected" /></td>
                    <td>{{ item.itemName }}</td>
                    <td>{{ item.quantity }}</td>
                    <td>{{ item.fulfilledQuantity || 0 }}</td>
                    <td>{{ getRemainingQty(item) }}</td>
                    <td><input type="number" class="inline-qty-input" [(ngModel)]="item.fulfillQty" [max]="getRemainingQty(item)" min="1" [disabled]="!item.selected" /></td>
                  </tr>
                  <tr *ngIf="inlineSelectableItems.length === 0">
                    <td colspan="6" class="no-items">All items have been fulfilled</td>
                  </tr>
                </tbody>
              </table>
              <div class="inline-action-buttons" *ngIf="inlineSelectableItems.length > 0">
                <button class="btn-action stock" (click)="openInlineStockFulfillment(pr, $event)">
                  <i class="fa fa-box"></i> Fulfill from Stock
                </button>
                <button class="btn-action transfer" (click)="openInlineMaterialTransfer(pr, $event)">
                  <i class="fa fa-exchange-alt"></i> Material Transfer
                </button>
              </div>
            </div>
            
            <div class="inline-tabs">
              <div class="tab-headers">
                <button class="tab-header" [class.active]="inlineTabActive === 'purchaseOrders'" (click)="inlineTabActive = 'purchaseOrders'">
                  <i class="fa fa-file-invoice"></i> Purchase Orders ({{ inlinePurchaseOrders.length }})
                </button>
                <button class="tab-header" [class.active]="inlineTabActive === 'stockFulfillments'" (click)="inlineTabActive = 'stockFulfillments'">
                  <i class="fa fa-box"></i> Fulfilled Stocks ({{ inlineStockFulfillments.length }})
                </button>
                <button class="tab-header" [class.active]="inlineTabActive === 'materialTransfers'" (click)="inlineTabActive = 'materialTransfers'">
                  <i class="fa fa-exchange-alt"></i> Material Transfers ({{ inlineMaterialTransfers.length }})
                </button>
              </div>
              
              <div class="tab-content" *ngIf="inlineTabActive === 'purchaseOrders'">
                <table class="inline-data-table" *ngIf="inlinePurchaseOrders.length > 0">
                  <thead>
                    <tr>
                      <th>PO Number</th>
                      <th>Supplier</th>
                      <th>Date</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let po of inlinePurchaseOrders">
                      <td>{{ po.poNumber }}</td>
                      <td>{{ po.supplierName }}</td>
                      <td>{{ formatDate(po.poDate) }}</td>
                      <td><span class="status-badge" [ngClass]="getStatusClass(po.status)">{{ po.status }}</span></td>
                    </tr>
                  </tbody>
                </table>
                <div class="empty-tab" *ngIf="inlinePurchaseOrders.length === 0">No purchase orders created yet</div>
              </div>
              
              <div class="tab-content" *ngIf="inlineTabActive === 'stockFulfillments'">
                <table class="inline-data-table" *ngIf="inlineStockFulfillments.length > 0">
                  <thead>
                    <tr>
                      <th>From Warehouse</th>
                      <th>Supplier</th>
                      <th>Items</th>
                      <th>Date</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let sf of inlineStockFulfillments">
                      <td>{{ sf.warehouseName || '-' }}</td>
                      <td>{{ sf.supplierName || '-' }}</td>
                      <td>{{ sf.items?.length || 0 }} items</td>
                      <td>{{ formatDate(sf.createdAt) }}</td>
                      <td><span class="status-badge status-approved">Fulfilled</span></td>
                    </tr>
                  </tbody>
                </table>
                <div class="empty-tab" *ngIf="inlineStockFulfillments.length === 0">No stock fulfillments yet</div>
              </div>
              
              <div class="tab-content" *ngIf="inlineTabActive === 'materialTransfers'">
                <table class="inline-data-table" *ngIf="inlineMaterialTransfers.length > 0">
                  <thead>
                    <tr>
                      <th>From Project</th>
                      <th>Supplier</th>
                      <th>Items</th>
                      <th>Date</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let mt of inlineMaterialTransfers">
                      <td>{{ mt.projectName || '-' }}</td>
                      <td>{{ mt.supplierName || '-' }}</td>
                      <td>{{ mt.items?.length || 0 }} items</td>
                      <td>{{ formatDate(mt.createdAt) }}</td>
                      <td><span class="status-badge status-approved">Transferred</span></td>
                    </tr>
                  </tbody>
                </table>
                <div class="empty-tab" *ngIf="inlineMaterialTransfers.length === 0">No material transfers yet</div>
              </div>
            </div>
          </div>
        </div>
        <div class="empty-column" *ngIf="getFilteredPRs(partiallyFulfilledPRs).length === 0">
          <i class="fa fa-tasks"></i>
          <span>No Partially Fulfilled</span>
        </div>
      </div>
    </div>

    <div class="kanban-column fulfilled">
      <div class="column-header">
        <span class="column-title">Fully Fulfilled</span>
        <span class="column-count">{{ getFilteredPRs(fullyFulfilledPRs).length }} Requisitions</span>
      </div>
      <div class="column-body">
        <div class="pr-card completed" *ngFor="let pr of getFilteredPRs(fullyFulfilledPRs)" (click)="viewPR(pr)">
          <div class="card-header">
            <span class="pr-number">{{ pr.prNumber }}</span>
            <span class="completed-badge"><i class="fa fa-check-circle"></i> Completed</span>
          </div>
          <div class="card-department">{{ pr.department }}</div>
          <div class="card-details">
            <div class="detail-row">
              <span class="label">Date:</span>
              <span class="value">{{ formatDate(pr.prDate) }}</span>
            </div>
          </div>
          <div class="card-footer">
            <span class="comments"><i class="fa fa-comments"></i> Comments: {{ pr.commentsCount || 0 }}</span>
          </div>
        </div>
        <div class="empty-column" *ngIf="getFilteredPRs(fullyFulfilledPRs).length === 0">
          <i class="fa fa-check-double"></i>
          <span>No Fulfilled Requisitions</span>
        </div>
      </div>
    </div>

    <div class="kanban-column rejected">
      <div class="column-header">
        <span class="column-title">Rejected</span>
        <span class="column-count">{{ getFilteredPRs(rejectedPRs).length }} Requisitions</span>
      </div>
      <div class="column-body">
        <div class="pr-card rejected-card" *ngFor="let pr of getFilteredPRs(rejectedPRs)" (click)="viewPR(pr)">
          <div class="card-header">
            <span class="pr-number">{{ pr.prNumber }}</span>
            <span class="rejected-badge"><i class="fa fa-times-circle"></i> Rejected</span>
          </div>
          <div class="card-department">{{ pr.department }}</div>
          <div class="card-details">
            <div class="detail-row" *ngIf="pr.rejectionReason">
              <span class="label">Reason:</span>
              <span class="value rejection-reason">{{ pr.rejectionReason }}</span>
            </div>
          </div>
          <div class="card-footer">
            <span class="rejected-by" *ngIf="pr.rejectedBy">By: {{ pr.rejectedBy }}</span>
          </div>
        </div>
        <div class="empty-column" *ngIf="getFilteredPRs(rejectedPRs).length === 0">
          <i class="fa fa-ban"></i>
          <span>No Rejected Requisitions</span>
        </div>
      </div>
    </div>
  </div>

  <div class="table-view" *ngIf="viewMode === 'table'">
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>PR Number</th>
            <th>PR Date</th>
            <th>Required Date</th>
            <th>Department</th>
            <th>Requested By</th>
            <th>Priority</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="getAllFilteredPRs().length === 0">
            <td colspan="8" class="empty-state">
              <i class="fa fa-file-alt"></i>
              <p>No requisitions found</p>
            </td>
          </tr>
          <tr *ngFor="let pr of getAllFilteredPRs()" (click)="viewPR(pr)" class="clickable-row">
            <td><strong class="pr-link">{{ pr.prNumber }}</strong></td>
            <td>{{ formatDate(pr.prDate) }}</td>
            <td>{{ formatDate(pr.requiredDate) }}</td>
            <td>{{ pr.department }}</td>
            <td>{{ pr.requestedBy }}</td>
            <td>
              <span class="priority-badge" [ngClass]="getPriorityClass(pr.priority)">{{ pr.priority }}</span>
            </td>
            <td>
              <span class="status-badge" [ngClass]="getStatusClass(pr.status)">{{ pr.status }}</span>
            </td>
            <td>
              <div class="action-buttons">
                <button class="btn-icon print" (click)="printPR(pr); $event.stopPropagation()" title="Print">
                  <i class="fa fa-print"></i>
                </button>
                <button class="btn-icon" (click)="openEditModal(pr); $event.stopPropagation()" title="Edit" *ngIf="canEdit(pr)">
                  <i class="fa fa-edit"></i>
                </button>
                <button class="btn-icon" (click)="viewPR(pr); $event.stopPropagation()" title="View" *ngIf="!canEdit(pr)">
                  <i class="fa fa-eye"></i>
                </button>
                <button class="btn-icon delete" (click)="deletePR(pr); $event.stopPropagation()" title="Delete" *ngIf="canDelete(pr)">
                  <i class="fa fa-trash"></i>
                </button>
                <button class="btn-icon approve" (click)="approvePR(pr, $event)" title="Approve" *ngIf="canApproveReject(pr)">
                  <i class="fa fa-check"></i>
                </button>
                <button class="btn-icon reject" (click)="rejectPR(pr, $event)" title="Reject" *ngIf="canApproveReject(pr)">
                  <i class="fa fa-times"></i>
                </button>
                <button class="btn-icon view" (click)="openViewModal(pr); $event.stopPropagation()" title="View History" *ngIf="canConvertToPO(pr)">
                  <i class="fa fa-eye"></i>
                </button>
                <button class="btn-icon convert" (click)="convertToPO(pr, $event)" title="Convert to PO" *ngIf="canConvertToPO(pr)">
                  <i class="fa fa-file-invoice"></i>
                </button>
                <button class="btn-icon stock" (click)="openStockFulfillmentModal(pr, $event)" title="Fulfill from Stock" *ngIf="canFulfillFromStock(pr)">
                  <i class="fa fa-box"></i>
                </button>
                <button class="btn-icon transfer" (click)="openMaterialTransferModal(pr, $event)" title="Material Transfer" *ngIf="canMaterialTransfer(pr)">
                  <i class="fa fa-exchange-alt"></i>
                </button>
                <span class="completed-label" *ngIf="isCompleted(pr)">
                  <i class="fa fa-check-circle"></i> Completed
                </span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showModal">
  <div class="modal-content large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ isEditing ? 'Edit Requisition' : 'New Purchase Requisition' }}</h2>
      <button class="close-btn" (click)="showModal = false">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group">
          <label>PR Number</label>
          <input type="text" class="form-control" [(ngModel)]="selectedPR.prNumber" readonly />
        </div>
        <div class="form-group">
          <label>PR Date *</label>
          <input type="date" class="form-control" [(ngModel)]="selectedPR.prDate" required />
        </div>
        <div class="form-group">
          <label>Required Date *</label>
          <input type="date" class="form-control" [(ngModel)]="selectedPR.requiredDate" required />
        </div>
        <div class="form-group">
          <label>Requested By</label>
          <input type="text" class="form-control" [(ngModel)]="selectedPR.requestedBy" readonly />
        </div>
        <div class="form-group">
          <label>Department / Project *</label>
          <input type="text" class="form-control" [(ngModel)]="selectedPR.department" placeholder="Enter department or project" required />
        </div>
        <div class="form-group">
          <label>Delivery Location</label>
          <input type="text" class="form-control" [(ngModel)]="selectedPR.deliveryLocation" placeholder="Enter delivery location" />
        </div>
        <div class="form-group full-width">
          <label>Purpose</label>
          <textarea class="form-control" [(ngModel)]="selectedPR.purpose" placeholder="Enter purpose of requisition" rows="2"></textarea>
        </div>
        <div class="form-group">
          <label>Priority *</label>
          <select class="form-control" [(ngModel)]="selectedPR.priority" required>
            <option value="Normal">Normal</option>
            <option value="Urgent">Urgent</option>
            <option value="Critical">Critical</option>
          </select>
        </div>
        <div class="form-group">
          <label>Status</label>
          <input type="text" class="form-control" [value]="selectedPR.status" readonly />
        </div>
      </div>

      <div class="items-section">
        <div class="section-header">
          <h3>Material List</h3>
          <div class="section-header-right">
            <div class="fulfillment-progress" *ngIf="selectedPR.status !== 'Draft' && selectedPR.status !== 'Submitted' && selectedPR.status !== 'Rejected'">
              <span class="progress-label">Fulfillment Progress:</span>
              <div class="progress-bar-inline">
                <div class="progress-fill" [style.width.%]="calculateFulfillmentProgress(selectedPR)"></div>
              </div>
              <span class="progress-percent">{{ calculateFulfillmentProgress(selectedPR) }}%</span>
            </div>
            <button class="btn-secondary" (click)="addItem()" *ngIf="canSubmit(selectedPR) || !isEditing">
              <i class="fa fa-plus"></i> Add Item
            </button>
          </div>
        </div>
        <div class="items-table-container">
          <table class="items-table">
            <thead>
              <tr>
                <th style="width: 30px;">#</th>
                <th style="width: 180px;">Item Name *</th>
                <th>Item Description</th>
                <th style="width: 80px;">Qty *</th>
                <th style="width: 80px;" *ngIf="selectedPR.status !== 'Draft'">Fulfilled</th>
                <th style="width: 100px;">UOM</th>
                <th style="width: 100px;" *ngIf="selectedPR.status !== 'Draft'">Status</th>
                <th>Remarks</th>
                <th style="width: 50px;" *ngIf="canSubmit(selectedPR)">Action</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of selectedPR.items; let i = index">
                <td>{{ i + 1 }}</td>
                <td>
                  <select class="form-control" [(ngModel)]="item.itemName" (change)="onItemSelect(i)" [disabled]="!canSubmit(selectedPR) && isEditing">
                    <option value="">Select Item</option>
                    <option *ngFor="let it of items" [value]="it.name">{{ it.name }}</option>
                  </select>
                </td>
                <td>
                  <input type="text" class="form-control" [(ngModel)]="item.itemDescription" placeholder="Description" [readonly]="!canSubmit(selectedPR) && isEditing" />
                </td>
                <td>
                  <input type="number" class="form-control" [(ngModel)]="item.quantity" min="0" [readonly]="!canSubmit(selectedPR) && isEditing" />
                </td>
                <td *ngIf="selectedPR.status !== 'Draft'">
                  <span class="fulfilled-qty">{{ item.fulfilledQuantity || 0 }} / {{ item.quantity }}</span>
                </td>
                <td>
                  <select class="form-control" [(ngModel)]="item.uom" [disabled]="!canSubmit(selectedPR) && isEditing">
                    <option value="">Select UOM</option>
                    <option *ngFor="let unit of units" [value]="unit.symbol || unit.code">{{ unit.name }} ({{ unit.symbol || unit.code }})</option>
                  </select>
                </td>
                <td *ngIf="selectedPR.status !== 'Draft'">
                  <span class="item-status-badge" [ngClass]="getItemStatusClass(item.status)">
                    {{ item.status || 'Pending' }}
                  </span>
                </td>
                <td>
                  <input type="text" class="form-control" [(ngModel)]="item.remarks" placeholder="Remarks" [readonly]="!canSubmit(selectedPR) && isEditing" />
                </td>
                <td *ngIf="canSubmit(selectedPR)">
                  <button class="btn-icon delete" (click)="removeItem(i)" [disabled]="selectedPR.items.length <= 1" title="Remove">
                    <i class="fa fa-trash"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="view-tabs-section" *ngIf="isEditing && (selectedPR.status === 'Approved' || selectedPR.status === 'Partially Fulfilled' || selectedPR.status === 'Fully Fulfilled')">
        <div class="tabs">
          <button class="tab-btn" [class.active]="viewTabActive === 'purchaseOrders'" (click)="viewTabActive = 'purchaseOrders'">
            <i class="fa fa-file-invoice"></i> Purchase Orders ({{ purchaseOrders.length }})
          </button>
          <button class="tab-btn" [class.active]="viewTabActive === 'stockFulfillments'" (click)="viewTabActive = 'stockFulfillments'">
            <i class="fa fa-box"></i> Stock Fulfillments ({{ stockFulfillments.length }})
          </button>
          <button class="tab-btn" [class.active]="viewTabActive === 'materialTransfers'" (click)="viewTabActive = 'materialTransfers'">
            <i class="fa fa-exchange-alt"></i> Material Transfers ({{ materialTransfers.length }})
          </button>
        </div>

        <div class="tab-content" *ngIf="viewTabActive === 'purchaseOrders'">
          <div class="empty-tab" *ngIf="purchaseOrders.length === 0">
            <i class="fa fa-file-invoice"></i>
            <p>No purchase orders created for this PR yet.</p>
          </div>
          <table class="data-table" *ngIf="purchaseOrders.length > 0">
            <thead>
              <tr>
                <th>PO Number</th>
                <th>Date</th>
                <th>Supplier</th>
                <th>Items</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let po of purchaseOrders">
                <td>{{ po.poNumber }}</td>
                <td>{{ formatDate(po.poDate) }}</td>
                <td>{{ po.supplierName }}</td>
                <td>{{ po.itemCount || po.items?.length || 0 }}</td>
                <td><span class="status-badge" [ngClass]="getStatusClass(po.status)">{{ po.status }}</span></td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="tab-content" *ngIf="viewTabActive === 'stockFulfillments'">
          <div class="empty-tab" *ngIf="stockFulfillments.length === 0">
            <i class="fa fa-box"></i>
            <p>No stock fulfillments for this PR yet.</p>
          </div>
          <table class="data-table" *ngIf="stockFulfillments.length > 0">
            <thead>
              <tr>
                <th>Fulfillment #</th>
                <th>Date</th>
                <th>Warehouse</th>
                <th>Supplier</th>
                <th>Items</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let sf of stockFulfillments">
                <td>{{ sf.fulfillmentNumber }}</td>
                <td>{{ formatDate(sf.fulfillmentDate) }}</td>
                <td>{{ sf.warehouseName || '-' }}</td>
                <td>{{ sf.supplierName || '-' }}</td>
                <td>{{ sf.items?.length || 0 }}</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="tab-content" *ngIf="viewTabActive === 'materialTransfers'">
          <div class="empty-tab" *ngIf="materialTransfers.length === 0">
            <i class="fa fa-exchange-alt"></i>
            <p>No material transfers for this PR yet.</p>
          </div>
          <table class="data-table" *ngIf="materialTransfers.length > 0">
            <thead>
              <tr>
                <th>Transfer #</th>
                <th>Date</th>
                <th>Project</th>
                <th>Supplier</th>
                <th>Items</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let mt of materialTransfers">
                <td>{{ mt.transferNumber }}</td>
                <td>{{ formatDate(mt.transferDate) }}</td>
                <td>{{ mt.projectName || '-' }}</td>
                <td>{{ mt.supplierName || '-' }}</td>
                <td>{{ mt.items?.length || 0 }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary">Cancel</button>
      
      <button class="btn-primary" (click)="saveDraft()" *ngIf="canSubmit(selectedPR) || !isEditing">
        <i class="fa fa-save"></i> Save as Draft
      </button>
      <button class="btn-success" (click)="submitPR()" *ngIf="canSubmit(selectedPR) || !isEditing">
        <i class="fa fa-paper-plane"></i> Submit
      </button>
      
      <button class="btn-approve" (click)="approvePR(selectedPR)" *ngIf="canApproveReject(selectedPR)">
        <i class="fa fa-check"></i> Approve
      </button>
      <button class="btn-reject" (click)="rejectPR(selectedPR)" *ngIf="canApproveReject(selectedPR)">
        <i class="fa fa-times"></i> Reject
      </button>
      
      <button class="btn-secondary" (click)="openViewModal(selectedPR)" *ngIf="canConvertToPO(selectedPR)">
        <i class="fa fa-eye"></i> View History
      </button>
      <button class="btn-primary" (click)="convertToPO(selectedPR)" *ngIf="canConvertToPO(selectedPR)">
        <i class="fa fa-file-invoice"></i> Convert to PO
      </button>
      <button class="btn-secondary" (click)="openStockFulfillmentModal(selectedPR)" *ngIf="canFulfillFromStock(selectedPR)">
        <i class="fa fa-box"></i> Fulfill from Stock
      </button>
      <button class="btn-secondary" (click)="openMaterialTransferModal(selectedPR)" *ngIf="canMaterialTransfer(selectedPR)">
        <i class="fa fa-exchange-alt"></i> Material Transfer
      </button>
      
      <span class="completed-message" *ngIf="isCompleted(selectedPR)">
        <i class="fa fa-check-circle"></i> This requisition has been fully fulfilled
      </span>
      
      <span class="rejected-message" *ngIf="isRejected(selectedPR)">
        <i class="fa fa-times-circle"></i> This requisition was rejected
      </span>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showViewModal">
  <div class="modal-content large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>PR History - {{ selectedPR.prNumber }}</h2>
      <button class="close-btn" (click)="showViewModal = false">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="tabs">
        <button class="tab-btn" [class.active]="viewTabActive === 'purchaseOrders'" (click)="viewTabActive = 'purchaseOrders'">
          <i class="fa fa-file-invoice"></i> Purchase Orders ({{ purchaseOrders.length }})
        </button>
        <button class="tab-btn" [class.active]="viewTabActive === 'stockFulfillments'" (click)="viewTabActive = 'stockFulfillments'">
          <i class="fa fa-box"></i> Stock Fulfillments ({{ stockFulfillments.length }})
        </button>
        <button class="tab-btn" [class.active]="viewTabActive === 'materialTransfers'" (click)="viewTabActive = 'materialTransfers'">
          <i class="fa fa-exchange-alt"></i> Material Transfers ({{ materialTransfers.length }})
        </button>
      </div>

      <div class="tab-content" *ngIf="viewTabActive === 'purchaseOrders'">
        <div class="empty-tab" *ngIf="purchaseOrders.length === 0">
          <i class="fa fa-file-invoice"></i>
          <p>No purchase orders created for this PR yet.</p>
        </div>
        <table class="data-table" *ngIf="purchaseOrders.length > 0">
          <thead>
            <tr>
              <th>PO Number</th>
              <th>Date</th>
              <th>Supplier</th>
              <th>Items</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let po of purchaseOrders">
              <td>{{ po.poNumber }}</td>
              <td>{{ formatDate(po.poDate) }}</td>
              <td>{{ po.supplierName }}</td>
              <td>{{ po.itemCount || po.items?.length || 0 }}</td>
              <td><span class="status-badge">{{ po.status }}</span></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="tab-content" *ngIf="viewTabActive === 'stockFulfillments'">
        <div class="empty-tab" *ngIf="stockFulfillments.length === 0">
          <i class="fa fa-box"></i>
          <p>No stock fulfillments for this PR yet.</p>
        </div>
        <table class="data-table" *ngIf="stockFulfillments.length > 0">
          <thead>
            <tr>
              <th>Fulfillment #</th>
              <th>Date</th>
              <th>Warehouse</th>
              <th>Supplier</th>
              <th>Items</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let sf of stockFulfillments">
              <td>{{ sf.fulfillmentNumber }}</td>
              <td>{{ formatDate(sf.fulfillmentDate) }}</td>
              <td>{{ sf.warehouseName || '-' }}</td>
              <td>{{ sf.supplierName || '-' }}</td>
              <td>{{ sf.items?.length || 0 }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="tab-content" *ngIf="viewTabActive === 'materialTransfers'">
        <div class="empty-tab" *ngIf="materialTransfers.length === 0">
          <i class="fa fa-exchange-alt"></i>
          <p>No material transfers for this PR yet.</p>
        </div>
        <table class="data-table" *ngIf="materialTransfers.length > 0">
          <thead>
            <tr>
              <th>Transfer #</th>
              <th>Date</th>
              <th>Project</th>
              <th>Supplier</th>
              <th>Items</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let mt of materialTransfers">
              <td>{{ mt.transferNumber }}</td>
              <td>{{ formatDate(mt.transferDate) }}</td>
              <td>{{ mt.projectName || '-' }}</td>
              <td>{{ mt.supplierName || '-' }}</td>
              <td>{{ mt.items?.length || 0 }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary">Close</button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showStockFulfillmentModal">
  <div class="modal-content large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Stock Fulfillment - {{ selectedPR.prNumber }}</h2>
      <button class="close-btn" (click)="showStockFulfillmentModal = false">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group">
          <label>Warehouse</label>
          <select class="form-control" [(ngModel)]="selectedWarehouseId">
            <option [value]="null">Select Warehouse</option>
            <option *ngFor="let wh of warehouses" [value]="wh.id">{{ wh.name }} ({{ wh.code }})</option>
          </select>
        </div>
        <div class="form-group">
          <label>Supplier</label>
          <select class="form-control" [(ngModel)]="selectedSupplierId">
            <option [value]="null">Select Supplier</option>
            <option *ngFor="let sup of suppliers" [value]="sup.id">{{ sup.name }}</option>
          </select>
        </div>
        <div class="form-group full-width">
          <label>Remarks</label>
          <textarea class="form-control" [(ngModel)]="stockFulfillmentRemarks" placeholder="Enter remarks" rows="2"></textarea>
        </div>
      </div>

      <div class="items-section">
        <div class="section-header">
          <h3>Select Items to Fulfill</h3>
        </div>
        <div class="items-table-container">
          <table class="items-table">
            <thead>
              <tr>
                <th style="width: 40px;">
                  <input type="checkbox" (change)="toggleAllItems(stockFulfillmentItems, $event)" />
                </th>
                <th>Item Name</th>
                <th style="width: 100px;">Required</th>
                <th style="width: 100px;">Already Fulfilled</th>
                <th style="width: 100px;">Remaining</th>
                <th style="width: 100px;">Qty to Fulfill</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of stockFulfillmentItems">
                <td>
                  <input type="checkbox" [(ngModel)]="item.selected" />
                </td>
                <td>{{ item.itemName }}</td>
                <td>{{ item.quantity }}</td>
                <td>{{ item.fulfilledQuantity || 0 }}</td>
                <td>{{ getRemainingQty(item) }}</td>
                <td>
                  <input type="number" class="form-control" [(ngModel)]="item.fulfillQty" 
                         [max]="getRemainingQty(item)" min="0" [disabled]="!item.selected" />
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary">Cancel</button>
      <button class="btn-primary" (click)="saveStockFulfillment()">
        <i class="fa fa-check"></i> Fulfill Selected Items
      </button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showMaterialTransferModal">
  <div class="modal-content large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Material Transfer - {{ selectedPR.prNumber }}</h2>
      <button class="close-btn" (click)="showMaterialTransferModal = false">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group">
          <label>Project Name</label>
          <input type="text" class="form-control" [(ngModel)]="transferProjectName" placeholder="Enter project name" />
        </div>
        <div class="form-group">
          <label>Supplier</label>
          <select class="form-control" [(ngModel)]="transferSupplierId">
            <option [value]="null">Select Supplier</option>
            <option *ngFor="let sup of suppliers" [value]="sup.id">{{ sup.name }}</option>
          </select>
        </div>
        <div class="form-group full-width">
          <label>Remarks</label>
          <textarea class="form-control" [(ngModel)]="materialTransferRemarks" placeholder="Enter remarks" rows="2"></textarea>
        </div>
      </div>

      <div class="items-section">
        <div class="section-header">
          <h3>Select Items to Transfer</h3>
        </div>
        <div class="items-table-container">
          <table class="items-table">
            <thead>
              <tr>
                <th style="width: 40px;">
                  <input type="checkbox" (change)="toggleAllItems(materialTransferItems, $event)" />
                </th>
                <th>Item Name</th>
                <th style="width: 100px;">Required</th>
                <th style="width: 100px;">Already Fulfilled</th>
                <th style="width: 100px;">Remaining</th>
                <th style="width: 100px;">Qty to Transfer</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of materialTransferItems">
                <td>
                  <input type="checkbox" [(ngModel)]="item.selected" />
                </td>
                <td>{{ item.itemName }}</td>
                <td>{{ item.quantity }}</td>
                <td>{{ item.fulfilledQuantity || 0 }}</td>
                <td>{{ getRemainingQty(item) }}</td>
                <td>
                  <input type="number" class="form-control" [(ngModel)]="item.fulfillQty" 
                         [max]="getRemainingQty(item)" min="0" [disabled]="!item.selected" />
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary">Cancel</button>
      <button class="btn-primary" (click)="saveMaterialTransfer()">
        <i class="fa fa-check"></i> Transfer Selected Items
      </button>
    </div>
  </div>
</div>
