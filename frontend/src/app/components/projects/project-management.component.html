<div class="projects-container">
  <div class="page-header">
    <div class="header-left">
      <h2>Project Management</h2>
      <span class="subtitle">Manage and track all your projects</span>
    </div>
    <div class="header-actions">
      <button class="btn btn-primary" (click)="openModal()">
        <i class="fas fa-plus"></i> New Project
      </button>
    </div>
  </div>

  <div class="dashboard-stats">
    <div class="stat-card" (click)="statusFilter = ''">
      <div class="stat-icon total"><i class="fas fa-folder-open"></i></div>
      <div class="stat-info">
        <span class="stat-value">{{ totalProjects }}</span>
        <span class="stat-label">Total Projects</span>
      </div>
    </div>
    <div class="stat-card" (click)="statusFilter = 'IN_PROGRESS'">
      <div class="stat-icon active"><i class="fas fa-spinner"></i></div>
      <div class="stat-info">
        <span class="stat-value">{{ activeProjects }}</span>
        <span class="stat-label">In Progress</span>
      </div>
    </div>
    <div class="stat-card" (click)="statusFilter = 'COMPLETED'">
      <div class="stat-icon completed"><i class="fas fa-check-circle"></i></div>
      <div class="stat-info">
        <span class="stat-value">{{ completedProjects }}</span>
        <span class="stat-label">Completed</span>
      </div>
    </div>
    <div class="stat-card" (click)="statusFilter = 'ON_HOLD'">
      <div class="stat-icon onhold"><i class="fas fa-pause-circle"></i></div>
      <div class="stat-info">
        <span class="stat-value">{{ onHoldProjects }}</span>
        <span class="stat-label">On Hold</span>
      </div>
    </div>
    <div class="stat-card overdue">
      <div class="stat-icon overdue"><i class="fas fa-exclamation-triangle"></i></div>
      <div class="stat-info">
        <span class="stat-value">{{ overdueProjects }}</span>
        <span class="stat-label">Overdue</span>
      </div>
    </div>
    <div class="stat-card budget">
      <div class="stat-icon budget"><i class="fas fa-dollar-sign"></i></div>
      <div class="stat-info">
        <span class="stat-value">{{ formatCurrency(totalBudget) }}</span>
        <span class="stat-label">Total Budget</span>
      </div>
    </div>
    <div class="stat-card hours">
      <div class="stat-icon hours"><i class="fas fa-clock"></i></div>
      <div class="stat-info">
        <span class="stat-value">{{ totalLoggedHours }}h</span>
        <span class="stat-label">Hours Logged</span>
      </div>
    </div>
    <div class="stat-card tasks">
      <div class="stat-icon tasks"><i class="fas fa-tasks"></i></div>
      <div class="stat-info">
        <span class="stat-value">{{ totalTasks }}</span>
        <span class="stat-label">Total Tasks</span>
      </div>
    </div>
  </div>

  <div class="toolbar">
    <div class="toolbar-left">
      <div class="view-toggle">
        <button [class.active]="mainView === 'grid'" (click)="mainView = 'grid'" title="Grid View">
          <i class="fas fa-th-large"></i>
        </button>
        <button [class.active]="mainView === 'kanban'" (click)="mainView = 'kanban'" title="Kanban View">
          <i class="fas fa-columns"></i>
        </button>
        <button [class.active]="mainView === 'list'" (click)="mainView = 'list'" title="List View">
          <i class="fas fa-list"></i>
        </button>
      </div>
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" [(ngModel)]="searchQuery" placeholder="Search projects...">
      </div>
    </div>
    <div class="toolbar-right">
      <select class="filter-select" [(ngModel)]="statusFilter">
        <option value="">All Statuses</option>
        <option *ngFor="let status of projectStatuses" [value]="status.value">{{ status.label }}</option>
      </select>
      <select class="filter-select" [(ngModel)]="clientFilter">
        <option value="">All Clients</option>
        <option *ngFor="let client of clients" [value]="client.id">{{ client.name }}</option>
      </select>
      <select class="filter-select" [(ngModel)]="billingFilter">
        <option value="">All Billing Types</option>
        <option *ngFor="let type of billingTypes" [value]="type.value">{{ type.label }}</option>
      </select>
      <button class="btn btn-sm btn-secondary" (click)="clearFilters()" *ngIf="searchQuery || statusFilter || clientFilter || billingFilter">
        <i class="fas fa-times"></i> Clear
      </button>
    </div>
  </div>

  <div class="projects-grid" *ngIf="mainView === 'grid'">
    <div class="project-card" *ngFor="let project of filteredProjects" [class.overdue]="isOverdue(project)">
      <div class="card-header">
        <span class="project-code">{{ project.projectCode }}</span>
        <div class="card-actions-menu">
          <button class="action-btn" (click)="openModal(project, true)" title="View"><i class="fas fa-eye"></i></button>
          <button class="action-btn" (click)="openModal(project)" title="Edit"><i class="fas fa-edit"></i></button>
          <button class="action-btn" (click)="duplicateProject(project)" title="Duplicate"><i class="fas fa-copy"></i></button>
          <button class="action-btn danger" (click)="deleteProject(project.id!)" title="Delete"><i class="fas fa-trash"></i></button>
        </div>
      </div>
      <div class="card-body">
        <h3 class="project-name">{{ project.name }}</h3>
        <p class="project-client"><i class="fas fa-user"></i> {{ getClientName(project.customerId) }}</p>
        <div class="project-meta">
          <span class="billing-type"><i class="fas fa-file-invoice-dollar"></i> {{ getBillingTypeLabel(project.billingType) }}</span>
          <span class="budget" *ngIf="project.estimatedCost"><i class="fas fa-dollar-sign"></i> {{ formatCurrency(project.estimatedCost) }}</span>
        </div>
        <div class="progress-section">
          <div class="progress-header">
            <span>Progress</span>
            <span>{{ project.progress }}%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="project.progress" [class.complete]="project.progress === 100"></div>
          </div>
        </div>
        <div class="date-section">
          <div class="date-item">
            <span class="date-label">Start</span>
            <span class="date-value">{{ formatDate(project.startDate) }}</span>
          </div>
          <div class="date-item">
            <span class="date-label">End</span>
            <span class="date-value">{{ formatDate(project.endDate || project.deadline) }}</span>
          </div>
        </div>
        <div class="card-footer">
          <span class="status-badge" [ngClass]="'status-' + getStatusColor(project.status)">
            {{ getStatusLabel(project.status) }}
          </span>
          <div class="stats-mini">
            <span title="Tasks"><i class="fas fa-tasks"></i> {{ project.tasks?.length || 0 }}</span>
            <span title="Hours"><i class="fas fa-clock"></i> {{ project.totalLoggedTime || 0 }}h</span>
          </div>
        </div>
        <div class="overdue-badge" *ngIf="isOverdue(project)">
          <i class="fas fa-exclamation-circle"></i> {{ getDaysRemaining(project.deadline) * -1 }} days overdue
        </div>
      </div>
    </div>
  </div>

  <div class="kanban-board" *ngIf="mainView === 'kanban'">
    <div class="kanban-column" *ngFor="let status of projectStatuses" 
         (dragover)="onDragOver($event)" 
         (drop)="onDrop($event, status.value)">
      <div class="column-header" [ngClass]="'header-' + status.color">
        <span class="column-title">{{ status.label }}</span>
        <span class="column-count">{{ getProjectsByStatus(status.value).length }}</span>
      </div>
      <div class="column-body">
        <div class="kanban-card" 
             *ngFor="let project of getProjectsByStatus(status.value)"
             draggable="true"
             (dragstart)="onDragStart($event, project)"
             (click)="openModal(project, true)">
          <div class="kanban-card-header">
            <span class="project-code">{{ project.projectCode }}</span>
            <span class="budget" *ngIf="project.estimatedCost">{{ formatCurrency(project.estimatedCost) }}</span>
          </div>
          <h4 class="project-name">{{ project.name }}</h4>
          <p class="project-client">{{ getClientName(project.customerId) }}</p>
          <div class="progress-mini">
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="project.progress"></div>
            </div>
            <span>{{ project.progress }}%</span>
          </div>
          <div class="kanban-card-footer">
            <span class="deadline" [class.overdue]="isOverdue(project)">
              <i class="fas fa-calendar"></i> {{ formatDate(project.deadline) }}
            </span>
            <div class="member-avatars" *ngIf="project.members && project.members.length > 0">
              <span class="avatar" *ngFor="let member of project.members.slice(0, 3)">
                {{ getEmployeeInitials(member.employeeId) }}
              </span>
              <span class="avatar more" *ngIf="project.members.length > 3">+{{ project.members.length - 3 }}</span>
            </div>
          </div>
        </div>
        <div class="empty-column" *ngIf="getProjectsByStatus(status.value).length === 0">
          <p>No projects</p>
        </div>
      </div>
    </div>
  </div>

  <div class="projects-list" *ngIf="mainView === 'list'">
    <table class="data-table">
      <thead>
        <tr>
          <th>Project</th>
          <th>Client</th>
          <th>Status</th>
          <th>Progress</th>
          <th>Budget</th>
          <th>Start Date</th>
          <th>Deadline</th>
          <th>Hours</th>
          <th>Tasks</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let project of filteredProjects" [class.overdue]="isOverdue(project)">
          <td>
            <div class="project-info">
              <span class="project-code">{{ project.projectCode }}</span>
              <span class="project-name">{{ project.name }}</span>
            </div>
          </td>
          <td>{{ getClientName(project.customerId) }}</td>
          <td>
            <span class="status-badge" [ngClass]="'status-' + getStatusColor(project.status)">
              {{ getStatusLabel(project.status) }}
            </span>
          </td>
          <td>
            <div class="progress-cell">
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="project.progress"></div>
              </div>
              <span>{{ project.progress }}%</span>
            </div>
          </td>
          <td>{{ formatCurrency(project.estimatedCost) }}</td>
          <td>{{ formatDate(project.startDate) }}</td>
          <td [class.overdue-text]="isOverdue(project)">{{ formatDate(project.deadline) }}</td>
          <td>{{ project.totalLoggedTime || 0 }}h</td>
          <td>{{ project.tasks?.length || 0 }}</td>
          <td>
            <div class="action-buttons">
              <button class="btn btn-sm btn-info" (click)="openModal(project, true)"><i class="fas fa-eye"></i></button>
              <button class="btn btn-sm btn-secondary" (click)="openModal(project)"><i class="fas fa-edit"></i></button>
              <button class="btn btn-sm btn-danger" (click)="deleteProject(project.id!)"><i class="fas fa-trash"></i></button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    <div class="empty-state" *ngIf="filteredProjects.length === 0">
      <i class="fas fa-folder-open"></i>
      <p>No projects found</p>
    </div>
  </div>

  <div class="empty-state" *ngIf="filteredProjects.length === 0 && mainView === 'grid'">
    <i class="fas fa-project-diagram"></i>
    <p>No projects found. Click "New Project" to create one.</p>
  </div>
</div>

<div class="modal-overlay" *ngIf="showModal">
  <div class="modal modal-xl" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ viewMode ? 'View Project' : (editMode ? 'Edit Project' : 'New Project') }}</h3>
      <button class="close-btn" (click)="closeModal()"><i class="fas fa-times"></i></button>
    </div>

    <div class="modal-tabs">
      <button [class.active]="activeTab === 'overview'" (click)="activeTab = 'overview'">Overview</button>
      <button [class.active]="activeTab === 'members'" (click)="activeTab = 'members'">Members</button>
      <button [class.active]="activeTab === 'permissions'" (click)="activeTab = 'permissions'">Client Permissions</button>
      <button [class.active]="activeTab === 'billing'" (click)="activeTab = 'billing'">Billing</button>
      <button [class.active]="activeTab === 'location'" (click)="activeTab = 'location'">Location</button>
      <button [class.active]="activeTab === 'tasks'" (click)="activeTab = 'tasks'" *ngIf="editMode">Tasks</button>
      <button [class.active]="activeTab === 'milestones'" (click)="activeTab = 'milestones'" *ngIf="editMode">Milestones</button>
      <button [class.active]="activeTab === 'timesheets'" (click)="activeTab = 'timesheets'" *ngIf="editMode">Timesheets</button>
      <button [class.active]="activeTab === 'files'" (click)="activeTab = 'files'" *ngIf="editMode">Files</button>
      <button [class.active]="activeTab === 'notes'" (click)="activeTab = 'notes'" *ngIf="editMode">Notes</button>
    </div>

    <div class="modal-body">
      <div class="tab-content" *ngIf="activeTab === 'overview'">
        <div class="form-row">
          <div class="form-group">
            <label>Project Name *</label>
            <input type="text" class="form-control" [(ngModel)]="selectedProject.name" [disabled]="viewMode">
          </div>
          <div class="form-group">
            <label>Project Code</label>
            <input type="text" class="form-control" [(ngModel)]="selectedProject.projectCode" [disabled]="true">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Client</label>
            <select class="form-control" [(ngModel)]="selectedProject.customerId" [disabled]="viewMode">
              <option [ngValue]="undefined">Select Client</option>
              <option *ngFor="let client of clients" [ngValue]="client.id">{{ client.name }}</option>
            </select>
          </div>
          <div class="form-group">
            <label>Billing Type</label>
            <select class="form-control" [(ngModel)]="selectedProject.billingType" [disabled]="viewMode">
              <option *ngFor="let type of billingTypes" [value]="type.value">{{ type.label }}</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Status</label>
            <select class="form-control" [(ngModel)]="selectedProject.status" [disabled]="viewMode">
              <option *ngFor="let status of projectStatuses" [value]="status.value">{{ status.label }}</option>
            </select>
          </div>
          <div class="form-group">
            <label>Progress (%)</label>
            <input type="number" class="form-control" [(ngModel)]="selectedProject.progress" min="0" max="100" [disabled]="viewMode">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Start Date</label>
            <input type="date" class="form-control" [(ngModel)]="selectedProject.startDate" [disabled]="viewMode">
          </div>
          <div class="form-group">
            <label>End Date</label>
            <input type="date" class="form-control" [(ngModel)]="selectedProject.endDate" [disabled]="viewMode">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Deadline</label>
            <input type="date" class="form-control" [(ngModel)]="selectedProject.deadline" [disabled]="viewMode">
          </div>
          <div class="form-group">
            <label>Completion Date</label>
            <input type="date" class="form-control" [(ngModel)]="selectedProject.completionDate" [disabled]="viewMode">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Estimated Hours</label>
            <input type="number" class="form-control" [(ngModel)]="selectedProject.estimatedHours" [disabled]="viewMode">
          </div>
          <div class="form-group">
            <label>Estimated Cost</label>
            <input type="number" class="form-control" [(ngModel)]="selectedProject.estimatedCost" [disabled]="viewMode" placeholder="0.00">
          </div>
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea class="form-control" [(ngModel)]="selectedProject.description" rows="3" [disabled]="viewMode"></textarea>
        </div>
        <div class="form-group">
          <label>Tags (comma separated)</label>
          <input type="text" class="form-control" [(ngModel)]="tagsInput" placeholder="design, urgent, phase1" [disabled]="viewMode">
        </div>
      </div>

      <div class="tab-content" *ngIf="activeTab === 'members'">
        <div class="alert alert-info" *ngIf="!editMode">
          <i class="fas fa-info-circle"></i> Please save the project first before adding members.
        </div>
        <div class="section-header">
          <h4>Project Members</h4>
          <button class="btn btn-primary btn-sm" (click)="openMemberModal()" *ngIf="!viewMode && editMode">
            <i class="fas fa-plus"></i> Add Member
          </button>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Project Manager</label>
            <select class="form-control" [(ngModel)]="selectedProject.projectManagerId" [disabled]="viewMode">
              <option [ngValue]="undefined">Select Manager</option>
              <option *ngFor="let emp of employees" [ngValue]="emp.id">{{ emp.firstName }} {{ emp.lastName }}</option>
            </select>
          </div>
        </div>
        <div class="table-container" *ngIf="selectedProject.members && selectedProject.members.length > 0">
          <table class="table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Role</th>
                <th>Hourly Rate</th>
                <th *ngIf="!viewMode">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let member of selectedProject.members; let i = index">
                <td>{{ getEmployeeName(member.employeeId) }}</td>
                <td>{{ member.role }}</td>
                <td>{{ formatCurrency(member.hourlyRate) }}</td>
                <td *ngIf="!viewMode">
                  <button class="btn btn-sm btn-danger" (click)="removeMember(i)"><i class="fas fa-trash"></i></button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="empty-state-box" *ngIf="(!selectedProject.members || selectedProject.members.length === 0) && editMode">
          <p>No members assigned yet.</p>
        </div>
      </div>

      <div class="tab-content" *ngIf="activeTab === 'permissions'">
        <h4>Client Visibility & Permissions</h4>
        <div class="permissions-grid">
          <label class="checkbox-item">
            <input type="checkbox" [(ngModel)]="selectedProject.allowCustomerViewProject" [disabled]="viewMode">
            Allow customer to view project
          </label>
          <label class="checkbox-item">
            <input type="checkbox" [(ngModel)]="selectedProject.allowCustomerViewTasks" [disabled]="viewMode">
            Allow customer to view tasks
          </label>
          <label class="checkbox-item">
            <input type="checkbox" [(ngModel)]="selectedProject.allowCustomerCommentTasks" [disabled]="viewMode">
            Allow customer to comment on tasks
          </label>
          <label class="checkbox-item">
            <input type="checkbox" [(ngModel)]="selectedProject.allowCustomerViewTaskComments" [disabled]="viewMode">
            Allow customer to view task comments
          </label>
          <label class="checkbox-item">
            <input type="checkbox" [(ngModel)]="selectedProject.allowCustomerViewTimesheets" [disabled]="viewMode">
            Allow customer to view timesheets
          </label>
          <label class="checkbox-item">
            <input type="checkbox" [(ngModel)]="selectedProject.allowCustomerViewFiles" [disabled]="viewMode">
            Allow customer to view files
          </label>
          <label class="checkbox-item">
            <input type="checkbox" [(ngModel)]="selectedProject.allowCustomerUploadFiles" [disabled]="viewMode">
            Allow customer to upload files
          </label>
          <label class="checkbox-item">
            <input type="checkbox" [(ngModel)]="selectedProject.allowCustomerViewDiscussions" [disabled]="viewMode">
            Allow customer to view discussions
          </label>
        </div>
      </div>

      <div class="tab-content" *ngIf="activeTab === 'billing'">
        <h4>Billing & Financial Settings</h4>
        <div class="form-row">
          <div class="form-group" *ngIf="selectedProject.billingType === 'FIXED_RATE'">
            <label>Fixed Rate Amount</label>
            <input type="number" class="form-control" [(ngModel)]="selectedProject.fixedRateAmount" [disabled]="viewMode">
          </div>
          <div class="form-group" *ngIf="selectedProject.billingType !== 'FIXED_RATE'">
            <label>Hourly Rate</label>
            <input type="number" class="form-control" [(ngModel)]="selectedProject.hourlyRate" [disabled]="viewMode">
          </div>
          <div class="form-group">
            <label>Currency</label>
            <select class="form-control" [(ngModel)]="selectedProject.currency" [disabled]="viewMode">
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
              <option value="GBP">GBP</option>
              <option value="INR">INR</option>
            </select>
          </div>
        </div>
        <div class="permissions-grid">
          <label class="checkbox-item">
            <input type="checkbox" [(ngModel)]="selectedProject.billableTasks" [disabled]="viewMode">
            Billable Tasks
          </label>
          <label class="checkbox-item">
            <input type="checkbox" [(ngModel)]="selectedProject.invoiceProject" [disabled]="viewMode">
            Invoice Project
          </label>
          <label class="checkbox-item">
            <input type="checkbox" [(ngModel)]="selectedProject.invoiceTasks" [disabled]="viewMode">
            Invoice Tasks
          </label>
          <label class="checkbox-item">
            <input type="checkbox" [(ngModel)]="selectedProject.invoiceTimesheets" [disabled]="viewMode">
            Invoice Timesheets
          </label>
        </div>
        <div class="stats-row" *ngIf="editMode">
          <div class="stat-card">
            <span class="stat-label">Total Logged Time</span>
            <span class="stat-value">{{ selectedProject.totalLoggedTime || 0 }} hrs</span>
          </div>
          <div class="stat-card">
            <span class="stat-label">Total Billable Time</span>
            <span class="stat-value">{{ selectedProject.totalBillableTime || 0 }} hrs</span>
          </div>
          <div class="stat-card">
            <span class="stat-label">Project Cost</span>
            <span class="stat-value">{{ formatCurrency(selectedProject.projectCost) }}</span>
          </div>
        </div>
      </div>

      <div class="tab-content" *ngIf="activeTab === 'location'">
        <h4><i class="fas fa-map-marker-alt"></i> Location & Clock-In Radius</h4>
        <p class="section-desc">Enable location tracking to require employees to be within a set radius when clocking in for this project.</p>

        <div class="permissions-grid" style="margin-bottom: 16px;">
          <label class="checkbox-item">
            <input type="checkbox" [(ngModel)]="selectedProject.locationTrackingEnabled" [disabled]="viewMode">
            Enable Location Tracking for Clock-In
          </label>
        </div>

        <div *ngIf="selectedProject.locationTrackingEnabled">
          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-map-pin"></i> Location Address</label>
              <input type="text" class="form-control" [(ngModel)]="selectedProject.locationAddress" placeholder="e.g. 123 Main St, City, State" [disabled]="viewMode">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-arrows-alt-h"></i> Latitude</label>
              <input type="number" step="0.000001" class="form-control" [(ngModel)]="selectedProject.locationLatitude" placeholder="e.g. 37.7749" [disabled]="viewMode">
            </div>
            <div class="form-group">
              <label><i class="fas fa-arrows-alt-v"></i> Longitude</label>
              <input type="number" step="0.000001" class="form-control" [(ngModel)]="selectedProject.locationLongitude" placeholder="e.g. -122.4194" [disabled]="viewMode">
            </div>
            <div class="form-group">
              <label><i class="fas fa-bullseye"></i> Radius (meters)</label>
              <input type="number" class="form-control" [(ngModel)]="selectedProject.locationRadiusMeters" placeholder="100" [disabled]="viewMode" min="10" max="10000">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group" style="flex: 1;">
              <button class="btn btn-secondary btn-sm" (click)="getCurrentLocation()" *ngIf="!viewMode" style="margin-top: 8px;">
                <i class="fas fa-crosshairs"></i> Use My Current Location
              </button>
            </div>
          </div>
          <div class="stats-row" *ngIf="selectedProject.locationLatitude && selectedProject.locationLongitude">
            <div class="stat-card">
              <span class="stat-label">Coordinates</span>
              <span class="stat-value" style="font-size: 13px;">{{ selectedProject.locationLatitude }}, {{ selectedProject.locationLongitude }}</span>
            </div>
            <div class="stat-card">
              <span class="stat-label">Allowed Radius</span>
              <span class="stat-value">{{ selectedProject.locationRadiusMeters || 100 }} meters</span>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-content" *ngIf="activeTab === 'tasks'">
        <div class="section-header">
          <h4>Tasks ({{ selectedProject.tasks?.length || 0 }})</h4>
          <button class="btn btn-primary btn-sm" (click)="openTaskModal()" *ngIf="!viewMode">
            <i class="fas fa-plus"></i> Add Task
          </button>
        </div>
        <div class="progress-info">
          <span>Task Completion: {{ calculateTaskProgress() }}%</span>
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="calculateTaskProgress()"></div>
          </div>
        </div>
        <div class="table-container" *ngIf="selectedProject.tasks && selectedProject.tasks.length > 0">
          <table class="table">
            <thead>
              <tr>
                <th>Task</th>
                <th>Assignee</th>
                <th>Status</th>
                <th>Priority</th>
                <th>Due Date</th>
                <th *ngIf="!viewMode">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let task of selectedProject.tasks; let i = index">
                <td>{{ task.name }}</td>
                <td>{{ getEmployeeName(task.assigneeId) }}</td>
                <td><span class="badge">{{ getTaskStatusLabel(task.status) }}</span></td>
                <td><span class="badge" [ngClass]="'badge-' + getTaskPriorityColor(task.priority)">{{ getTaskPriorityLabel(task.priority) }}</span></td>
                <td>{{ formatDate(task.dueDate) }}</td>
                <td *ngIf="!viewMode">
                  <button class="btn btn-sm btn-secondary" (click)="openTaskModal(task, i)"><i class="fas fa-edit"></i></button>
                  <button class="btn btn-sm btn-danger" (click)="deleteTask(i)"><i class="fas fa-trash"></i></button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="empty-state-box" *ngIf="!selectedProject.tasks || selectedProject.tasks.length === 0">
          <p>No tasks created yet.</p>
        </div>
      </div>

      <div class="tab-content" *ngIf="activeTab === 'milestones'">
        <div class="section-header">
          <h4>Milestones</h4>
          <button class="btn btn-primary btn-sm" (click)="openMilestoneModal()" *ngIf="!viewMode">
            <i class="fas fa-plus"></i> Add Milestone
          </button>
        </div>
        <div class="milestones-list" *ngIf="selectedProject.milestones && selectedProject.milestones.length > 0">
          <div class="milestone-item" *ngFor="let milestone of selectedProject.milestones; let i = index">
            <div class="milestone-info">
              <h5>{{ milestone.name }}</h5>
              <p>{{ milestone.description }}</p>
              <span class="due-date"><i class="fas fa-calendar"></i> {{ formatDate(milestone.dueDate) }}</span>
            </div>
            <div class="milestone-actions" *ngIf="!viewMode">
              <button class="btn btn-sm btn-danger" (click)="deleteMilestone(i)"><i class="fas fa-trash"></i></button>
            </div>
          </div>
        </div>
        <div class="empty-state-box" *ngIf="!selectedProject.milestones || selectedProject.milestones.length === 0">
          <p>No milestones defined yet.</p>
        </div>
      </div>

      <div class="tab-content" *ngIf="activeTab === 'timesheets'">
        <div class="section-header">
          <h4>Time Logs</h4>
          <button class="btn btn-primary btn-sm" (click)="openTimeLogModal()" *ngIf="!viewMode">
            <i class="fas fa-plus"></i> Log Time
          </button>
        </div>
        <div class="table-container" *ngIf="selectedProject.timeLogs && selectedProject.timeLogs.length > 0">
          <table class="table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Employee</th>
                <th>Hours</th>
                <th>Description</th>
                <th>Billable</th>
                <th *ngIf="!viewMode">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let log of selectedProject.timeLogs; let i = index">
                <td>{{ formatDate(log.date) }}</td>
                <td>{{ getEmployeeName(log.employeeId) }}</td>
                <td>{{ log.hours }}h</td>
                <td>{{ log.description || '-' }}</td>
                <td><span class="badge" [ngClass]="log.billable ? 'badge-success' : 'badge-secondary'">{{ log.billable ? 'Yes' : 'No' }}</span></td>
                <td *ngIf="!viewMode">
                  <button class="btn btn-sm btn-danger" (click)="deleteTimeLog(i)"><i class="fas fa-trash"></i></button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="empty-state-box" *ngIf="!selectedProject.timeLogs || selectedProject.timeLogs.length === 0">
          <p>No time logged yet.</p>
        </div>
      </div>

      <div class="tab-content" *ngIf="activeTab === 'files'">
        <div class="section-header">
          <h4>Project Files</h4>
          <button class="btn btn-primary btn-sm" (click)="openFileModal()" *ngIf="!viewMode">
            <i class="fas fa-plus"></i> Add File
          </button>
        </div>
        <div class="table-container" *ngIf="selectedProject.files && selectedProject.files.length > 0">
          <table class="table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Visibility</th>
                <th>Upload Date</th>
                <th *ngIf="!viewMode">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let file of selectedProject.files; let i = index">
                <td><i class="fas fa-file"></i> {{ file.name }}</td>
                <td>{{ file.visibility }}</td>
                <td>{{ formatDate(file.uploadDate) }}</td>
                <td *ngIf="!viewMode">
                  <button class="btn btn-sm btn-danger" (click)="deleteFile(i)"><i class="fas fa-trash"></i></button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="empty-state-box" *ngIf="!selectedProject.files || selectedProject.files.length === 0">
          <p>No files uploaded yet.</p>
        </div>
      </div>

      <div class="tab-content" *ngIf="activeTab === 'notes'">
        <div class="section-header">
          <h4>Internal Notes</h4>
          <button class="btn btn-primary btn-sm" (click)="openNoteModal()" *ngIf="!viewMode">
            <i class="fas fa-plus"></i> Add Note
          </button>
        </div>
        <div class="notes-list" *ngIf="selectedProject.notes && selectedProject.notes.length > 0">
          <div class="note-item" *ngFor="let note of selectedProject.notes; let i = index">
            <div class="note-content">{{ note.content }}</div>
            <div class="note-footer">
              <span class="note-date">{{ formatDate(note.createdAt) }}</span>
              <button class="btn btn-sm btn-danger" (click)="deleteNote(i)" *ngIf="!viewMode"><i class="fas fa-trash"></i></button>
            </div>
          </div>
        </div>
        <div class="empty-state-box" *ngIf="!selectedProject.notes || selectedProject.notes.length === 0">
          <p>No notes added yet.</p>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeModal()">{{ viewMode ? 'Close' : 'Cancel' }}</button>
      <button class="btn btn-primary" (click)="saveProject()" *ngIf="!viewMode">{{ editMode ? 'Update' : 'Create' }} Project</button>
    </div>
  </div>
</div>

<div class="modal-overlay sub-modal" *ngIf="showTaskModal" (click)="closeTaskModal()">
  <div class="modal modal-medium" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ taskEditIndex >= 0 ? 'Edit' : 'Add' }} Task</h3>
      <button class="close-btn" (click)="closeTaskModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Task Name *</label>
        <input type="text" class="form-control" [(ngModel)]="editingTask.name">
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea class="form-control" [(ngModel)]="editingTask.description" rows="2"></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Assignee</label>
          <select class="form-control" [(ngModel)]="editingTask.assigneeId">
            <option [ngValue]="undefined">Unassigned</option>
            <option *ngFor="let emp of employees" [ngValue]="emp.id">{{ emp.firstName }} {{ emp.lastName }}</option>
          </select>
        </div>
        <div class="form-group">
          <label>Status</label>
          <select class="form-control" [(ngModel)]="editingTask.status">
            <option *ngFor="let status of taskStatuses" [value]="status.value">{{ status.label }}</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Priority</label>
          <select class="form-control" [(ngModel)]="editingTask.priority">
            <option *ngFor="let p of taskPriorities" [value]="p.value">{{ p.label }}</option>
          </select>
        </div>
        <div class="form-group">
          <label>Due Date</label>
          <input type="date" class="form-control" [(ngModel)]="editingTask.dueDate">
        </div>
      </div>
      <div class="form-group">
        <label>Estimated Hours</label>
        <input type="number" class="form-control" [(ngModel)]="editingTask.estimatedHours">
      </div>
      <div class="checkbox-row">
        <label><input type="checkbox" [(ngModel)]="editingTask.billable"> Billable</label>
        <label><input type="checkbox" [(ngModel)]="editingTask.visibleToClient"> Visible to Client</label>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeTaskModal()">Cancel</button>
      <button class="btn btn-primary" (click)="saveTask()" [disabled]="!editingTask.name">Save Task</button>
    </div>
  </div>
</div>

<div class="modal-overlay sub-modal" *ngIf="showMilestoneModal" (click)="closeMilestoneModal()">
  <div class="modal modal-medium" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Add Milestone</h3>
      <button class="close-btn" (click)="closeMilestoneModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Milestone Name *</label>
        <input type="text" class="form-control" [(ngModel)]="editingMilestone.name">
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea class="form-control" [(ngModel)]="editingMilestone.description" rows="2"></textarea>
      </div>
      <div class="form-group">
        <label>Due Date</label>
        <input type="date" class="form-control" [(ngModel)]="editingMilestone.dueDate">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeMilestoneModal()">Cancel</button>
      <button class="btn btn-primary" (click)="saveMilestone()" [disabled]="!editingMilestone.name">Save</button>
    </div>
  </div>
</div>

<div class="modal-overlay sub-modal" *ngIf="showMemberModal" (click)="closeMemberModal()">
  <div class="modal modal-medium" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Add Member</h3>
      <button class="close-btn" (click)="closeMemberModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Employee *</label>
        <select class="form-control" [(ngModel)]="editingMember.employeeId">
          <option [ngValue]="undefined">Select Employee</option>
          <option *ngFor="let emp of employees" [ngValue]="emp.id">{{ emp.firstName }} {{ emp.lastName }}</option>
        </select>
      </div>
      <div class="form-group">
        <label>Role</label>
        <input type="text" class="form-control" [(ngModel)]="editingMember.role" placeholder="e.g., Developer, Designer">
      </div>
      <div class="form-group">
        <label>Hourly Rate</label>
        <input type="number" class="form-control" [(ngModel)]="editingMember.hourlyRate">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeMemberModal()">Cancel</button>
      <button class="btn btn-primary" (click)="saveMember()" [disabled]="!editingMember.employeeId">Add Member</button>
    </div>
  </div>
</div>

<div class="modal-overlay sub-modal" *ngIf="showFileModal" (click)="closeFileModal()">
  <div class="modal modal-medium" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Add File</h3>
      <button class="close-btn" (click)="closeFileModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>File Name *</label>
        <input type="text" class="form-control" [(ngModel)]="editingFile.name">
      </div>
      <div class="form-group">
        <label>Visibility</label>
        <select class="form-control" [(ngModel)]="editingFile.visibility">
          <option value="STAFF">Staff Only</option>
          <option value="CLIENT">Client Only</option>
          <option value="ALL">Everyone</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeFileModal()">Cancel</button>
      <button class="btn btn-primary" (click)="saveFile()" [disabled]="!editingFile.name">Add File</button>
    </div>
  </div>
</div>

<div class="modal-overlay sub-modal" *ngIf="showNoteModal" (click)="closeNoteModal()">
  <div class="modal modal-medium" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Add Note</h3>
      <button class="close-btn" (click)="closeNoteModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Note Content *</label>
        <textarea class="form-control" [(ngModel)]="editingNote.content" rows="4" placeholder="Enter your note..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeNoteModal()">Cancel</button>
      <button class="btn btn-primary" (click)="saveNote()" [disabled]="!editingNote.content">Add Note</button>
    </div>
  </div>
</div>

<div class="modal-overlay sub-modal" *ngIf="showTimeLogModal" (click)="closeTimeLogModal()">
  <div class="modal modal-medium" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Log Time</h3>
      <button class="close-btn" (click)="closeTimeLogModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label>Date *</label>
          <input type="date" class="form-control" [(ngModel)]="editingTimeLog.date">
        </div>
        <div class="form-group">
          <label>Hours *</label>
          <input type="number" class="form-control" [(ngModel)]="editingTimeLog.hours" step="0.25" min="0">
        </div>
      </div>
      <div class="form-group">
        <label>Employee</label>
        <select class="form-control" [(ngModel)]="editingTimeLog.employeeId">
          <option [ngValue]="undefined">Select Employee</option>
          <option *ngFor="let emp of employees" [ngValue]="emp.id">{{ emp.firstName }} {{ emp.lastName }}</option>
        </select>
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea class="form-control" [(ngModel)]="editingTimeLog.description" rows="2"></textarea>
      </div>
      <div class="checkbox-row">
        <label><input type="checkbox" [(ngModel)]="editingTimeLog.billable"> Billable</label>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeTimeLogModal()">Cancel</button>
      <button class="btn btn-primary" (click)="saveTimeLog()" [disabled]="!editingTimeLog.hours">Log Time</button>
    </div>
  </div>
</div>
