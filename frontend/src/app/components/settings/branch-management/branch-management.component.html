<div class="branch-management">
  <div class="page-header">
    <div class="header-left">
      <button *ngIf="activeTab === 'users' || activeTab === 'settings'" class="btn-back" (click)="backToBranches()">
        <i class="fas fa-arrow-left"></i> Back to Companies
      </button>
      <h1>
        <i class="fas fa-building"></i>
        <ng-container *ngIf="activeTab === 'branches'">Company Management</ng-container>
        <ng-container *ngIf="activeTab === 'users'">Company Users - {{ selectedBranch?.name }}</ng-container>
        <ng-container *ngIf="activeTab === 'settings'">Company Settings - {{ selectedBranch?.name }}</ng-container>
      </h1>
    </div>
    <div class="header-actions">
      <button *ngIf="activeTab === 'branches'" class="btn btn-primary" (click)="openAddBranchModal()">
        <i class="fas fa-plus"></i> Add Company
      </button>
      <button *ngIf="activeTab === 'users'" class="btn btn-primary" (click)="openAddUserModal()">
        <i class="fas fa-user-plus"></i> Add User
      </button>
    </div>
  </div>

  <div class="content-area" *ngIf="activeTab === 'branches'">
    <div class="loading" *ngIf="isLoading">
      <i class="fas fa-spinner fa-spin"></i> Loading companies...
    </div>

    <div class="empty-state" *ngIf="!isLoading && branches.length === 0">
      <i class="fas fa-building"></i>
      <h3>No Companies Found</h3>
      <p>Create your first company to get started with multi-company management.</p>
      <button class="btn btn-primary" (click)="openAddBranchModal()">
        <i class="fas fa-plus"></i> Create Company
      </button>
    </div>

    <div class="branches-grid" *ngIf="!isLoading && branches.length > 0">
      <div class="branch-card" *ngFor="let branch of branches" [class.inactive]="!branch.active">
        <div class="branch-header">
          <div class="branch-logo">
            <img *ngIf="branch.logoPath" [src]="branch.logoPath" [alt]="branch.name" />
            <i *ngIf="!branch.logoPath" class="fas fa-store"></i>
          </div>
          <div class="branch-status" [class.active]="branch.active" [class.inactive]="!branch.active">
            {{ branch.active ? 'Active' : 'Inactive' }}
          </div>
        </div>
        <div class="branch-body">
          <h3>{{ branch.name }}</h3>
          <span class="branch-code">{{ branch.code }}</span>
          <div class="branch-details">
            <p *ngIf="branch.address"><i class="fas fa-map-marker-alt"></i> {{ branch.address }}</p>
            <p *ngIf="branch.phone"><i class="fas fa-phone"></i> {{ branch.phone }}</p>
            <p *ngIf="branch.email"><i class="fas fa-envelope"></i> {{ branch.email }}</p>
          </div>
        </div>
        <div class="branch-actions">
          <button class="btn btn-sm btn-primary" (click)="openSettings(branch)" title="Company Settings">
            <i class="fas fa-cog"></i> Settings
          </button>
          <button class="btn btn-sm btn-secondary" (click)="selectBranch(branch)" title="Manage Users">
            <i class="fas fa-users"></i> Users
          </button>
          <button class="btn btn-sm btn-secondary" (click)="openEditBranchModal(branch)" title="Edit Company">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-sm btn-danger" (click)="deleteBranch(branch)" title="Delete Company">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="content-area" *ngIf="activeTab === 'settings'">
    <div class="loading" *ngIf="isLoading">
      <i class="fas fa-spinner fa-spin"></i> Loading settings...
    </div>

    <div class="settings-container" *ngIf="!isLoading && branchSettings">
      <div class="settings-tabs">
        <button [class.active]="settingsTab === 'general'" (click)="settingsTab = 'general'">
          <i class="fas fa-info-circle"></i> General
        </button>
        <button [class.active]="settingsTab === 'localization'" (click)="settingsTab = 'localization'">
          <i class="fas fa-globe"></i> Localization
        </button>
        <button [class.active]="settingsTab === 'tax'" (click)="settingsTab = 'tax'">
          <i class="fas fa-percent"></i> Tax & Finance
        </button>
        <button [class.active]="settingsTab === 'documents'" (click)="settingsTab = 'documents'">
          <i class="fas fa-file-alt"></i> Document Prefixes
        </button>
        <button [class.active]="settingsTab === 'branding'" (click)="settingsTab = 'branding'">
          <i class="fas fa-palette"></i> Branding
        </button>
      </div>

      <div class="settings-content">
        <div class="settings-panel" *ngIf="settingsTab === 'general'">
          <h3><i class="fas fa-building"></i> Company Information</h3>
          <div class="form-row">
            <div class="form-group">
              <label>Company Legal Name</label>
              <input type="text" [(ngModel)]="branchSettings.companyLegalName" placeholder="Legal company name for invoices" />
            </div>
            <div class="form-group">
              <label>Display Name</label>
              <input type="text" [(ngModel)]="branchSettings.displayName" placeholder="Display name" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Tax Registration Number</label>
              <input type="text" [(ngModel)]="branchSettings.taxRegistrationNumber" placeholder="e.g., EIN, VAT Number" />
            </div>
            <div class="form-group">
              <label>Business Registration Number</label>
              <input type="text" [(ngModel)]="branchSettings.businessRegistrationNumber" placeholder="Business license number" />
            </div>
          </div>
        </div>

        <div class="settings-panel" *ngIf="settingsTab === 'localization'">
          <h3><i class="fas fa-globe"></i> Regional Settings</h3>
          <div class="form-row">
            <div class="form-group">
              <label>Currency Symbol</label>
              <input type="text" [(ngModel)]="branchSettings.currencySymbol" placeholder="$" />
            </div>
            <div class="form-group">
              <label>Currency Position</label>
              <select [(ngModel)]="branchSettings.currencyPosition">
                <option value="before">Before amount ($100)</option>
                <option value="after">After amount (100$)</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Time Format</label>
              <select [(ngModel)]="branchSettings.timeFormat">
                <option value="HH:mm">24-hour (14:30)</option>
                <option value="hh:mm a">12-hour (2:30 PM)</option>
              </select>
            </div>
            <div class="form-group">
              <label>Number Format</label>
              <select [(ngModel)]="branchSettings.numberFormat">
                <option value="#,##0.00">1,234.56</option>
                <option value="#.##0,00">1.234,56</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Fiscal Year Start Month</label>
            <select [(ngModel)]="branchSettings.fiscalYearStartMonth">
              <option [value]="1">January</option>
              <option [value]="2">February</option>
              <option [value]="3">March</option>
              <option [value]="4">April</option>
              <option [value]="5">May</option>
              <option [value]="6">June</option>
              <option [value]="7">July</option>
              <option [value]="8">August</option>
              <option [value]="9">September</option>
              <option [value]="10">October</option>
              <option [value]="11">November</option>
              <option [value]="12">December</option>
            </select>
          </div>
        </div>

        <div class="settings-panel" *ngIf="settingsTab === 'tax'">
          <h3><i class="fas fa-percent"></i> Tax & Finance Settings</h3>
          <div class="form-row">
            <div class="form-group">
              <label>Default Tax Rate (%)</label>
              <input type="number" [(ngModel)]="branchSettings.defaultTaxRate" min="0" max="100" step="0.01" />
            </div>
            <div class="form-group">
              <label>Tax Label</label>
              <input type="text" [(ngModel)]="branchSettings.taxLabel" placeholder="e.g., Tax, VAT, GST" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Default Payment Terms</label>
              <select [(ngModel)]="branchSettings.defaultPaymentTerms">
                <option value="Net 15">Net 15</option>
                <option value="Net 30">Net 30</option>
                <option value="Net 45">Net 45</option>
                <option value="Net 60">Net 60</option>
                <option value="Due on Receipt">Due on Receipt</option>
              </select>
            </div>
            <div class="form-group">
              <label>Invoice Due Days</label>
              <input type="number" [(ngModel)]="branchSettings.invoiceDueDays" min="0" />
            </div>
          </div>
          <div class="form-group">
            <label>Invoice Footer Text</label>
            <textarea [(ngModel)]="branchSettings.invoiceFooter" rows="3" placeholder="Thank you for your business!"></textarea>
          </div>
          <div class="form-group">
            <label>Invoice Terms & Conditions</label>
            <textarea [(ngModel)]="branchSettings.invoiceTerms" rows="4" placeholder="Payment terms and conditions..."></textarea>
          </div>
        </div>

        <div class="settings-panel" *ngIf="settingsTab === 'documents'">
          <h3><i class="fas fa-file-alt"></i> Document Numbering</h3>
          <p class="settings-hint">Configure prefixes and starting numbers for auto-generated document IDs.</p>
          
          <div class="prefix-grid">
            <div class="prefix-item">
              <label>Invoice Prefix</label>
              <div class="prefix-input">
                <input type="text" [(ngModel)]="branchSettings.invoicePrefix" />
                <span class="next-number">Next: {{ branchSettings.invoicePrefix }}-{{ branchSettings.invoiceNextNumber }}</span>
              </div>
            </div>
            <div class="prefix-item">
              <label>Purchase Order Prefix</label>
              <div class="prefix-input">
                <input type="text" [(ngModel)]="branchSettings.purchaseOrderPrefix" />
                <span class="next-number">Next: {{ branchSettings.purchaseOrderPrefix }}-{{ branchSettings.purchaseOrderNextNumber }}</span>
              </div>
            </div>
            <div class="prefix-item">
              <label>Quotation Prefix</label>
              <div class="prefix-input">
                <input type="text" [(ngModel)]="branchSettings.quotationPrefix" />
                <span class="next-number">Next: {{ branchSettings.quotationPrefix }}-{{ branchSettings.quotationNextNumber }}</span>
              </div>
            </div>
            <div class="prefix-item">
              <label>Receipt Prefix</label>
              <div class="prefix-input">
                <input type="text" [(ngModel)]="branchSettings.receiptPrefix" />
                <span class="next-number">Next: {{ branchSettings.receiptPrefix }}-{{ branchSettings.receiptNextNumber }}</span>
              </div>
            </div>
            <div class="prefix-item">
              <label>Payroll Prefix</label>
              <div class="prefix-input">
                <input type="text" [(ngModel)]="branchSettings.payrollPrefix" />
                <span class="next-number">Next: {{ branchSettings.payrollPrefix }}-{{ branchSettings.payrollNextNumber }}</span>
              </div>
            </div>
            <div class="prefix-item">
              <label>Employee ID Prefix</label>
              <div class="prefix-input">
                <input type="text" [(ngModel)]="branchSettings.employeeIdPrefix" />
                <span class="next-number">Next: {{ branchSettings.employeeIdPrefix }}-{{ branchSettings.employeeIdNextNumber }}</span>
              </div>
            </div>
          </div>

          <div class="form-group mt-20">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="branchSettings.autoGenerateEmployeeId" />
              <span>Auto-generate Employee IDs</span>
            </label>
          </div>
        </div>

        <div class="settings-panel" *ngIf="settingsTab === 'branding'">
          <h3><i class="fas fa-palette"></i> Branding & Appearance</h3>
          
          <div class="branding-section">
            <div class="logo-upload">
              <label>Company Logo</label>
              <div class="logo-preview">
                <img *ngIf="selectedBranch?.logoPath" [src]="selectedBranch?.logoPath" alt="Company Logo" />
                <div class="logo-placeholder" *ngIf="!selectedBranch?.logoPath">
                  <i class="fas fa-building"></i>
                  <span>No logo uploaded</span>
                </div>
              </div>
              <input type="file" accept="image/*" (change)="onLogoChange($event)" id="logoInput" class="file-input" />
              <label for="logoInput" class="btn btn-secondary">
                <i class="fas fa-upload"></i> Upload Logo
              </label>
            </div>

            <div class="logo-upload">
              <label>Authorized Signature</label>
              <div class="logo-preview signature">
                <img *ngIf="branchSettings.signaturePath" [src]="branchSettings.signaturePath" alt="Signature" />
                <div class="logo-placeholder" *ngIf="!branchSettings.signaturePath">
                  <i class="fas fa-signature"></i>
                  <span>No signature uploaded</span>
                </div>
              </div>
              <input type="file" accept="image/*" (change)="onSignatureChange($event)" id="signatureInput" class="file-input" />
              <label for="signatureInput" class="btn btn-secondary">
                <i class="fas fa-upload"></i> Upload Signature
              </label>
            </div>
          </div>

          <div class="form-row mt-20">
            <div class="form-group">
              <label>Primary Color</label>
              <div class="color-input">
                <input type="color" [(ngModel)]="branchSettings.primaryColor" />
                <input type="text" [(ngModel)]="branchSettings.primaryColor" class="color-text" />
              </div>
            </div>
            <div class="form-group">
              <label>Secondary Color</label>
              <div class="color-input">
                <input type="color" [(ngModel)]="branchSettings.secondaryColor" />
                <input type="text" [(ngModel)]="branchSettings.secondaryColor" class="color-text" />
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" [(ngModel)]="branchSettings.showLogoOnInvoices" />
                <span>Show logo on invoices</span>
              </label>
            </div>
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" [(ngModel)]="branchSettings.showLogoOnReports" />
                <span>Show logo on reports</span>
              </label>
            </div>
          </div>
        </div>

        <div class="settings-actions">
          <button class="btn btn-primary" (click)="saveBranchSettings()" [disabled]="isSavingSettings">
            <i *ngIf="isSavingSettings" class="fas fa-spinner fa-spin"></i>
            <i *ngIf="!isSavingSettings" class="fas fa-save"></i>
            Save Settings
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="content-area" *ngIf="activeTab === 'users'">
    <div class="loading" *ngIf="isLoading">
      <i class="fas fa-spinner fa-spin"></i> Loading users...
    </div>

    <div class="empty-state" *ngIf="!isLoading && branchUsers.length === 0">
      <i class="fas fa-users"></i>
      <h3>No Users in This Company</h3>
      <p>Add users to allow them to access this company's data.</p>
      <button class="btn btn-primary" (click)="openAddUserModal()">
        <i class="fas fa-user-plus"></i> Add User
      </button>
    </div>

    <div class="users-table" *ngIf="!isLoading && branchUsers.length > 0">
      <table>
        <thead>
          <tr>
            <th>User</th>
            <th>Username</th>
            <th>Email</th>
            <th>Role</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of branchUsers">
            <td>
              <div class="user-info">
                <div class="avatar">{{ user.firstName?.charAt(0) || '?' }}</div>
                <span>{{ user.firstName }} {{ user.lastName }}</span>
              </div>
            </td>
            <td>{{ user.username }}</td>
            <td>{{ user.email }}</td>
            <td><span class="role-badge">{{ user.role?.name || 'N/A' }}</span></td>
            <td>
              <span class="status-badge" [class.active]="user.active" [class.inactive]="!user.active">
                {{ user.active ? 'Active' : 'Inactive' }}
              </span>
            </td>
            <td class="actions-cell">
              <button class="btn btn-sm btn-secondary" (click)="openEditUserModal(user)" title="Edit User">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-sm btn-secondary" (click)="openPasswordModal(user)" title="Reset Password">
                <i class="fas fa-key"></i>
              </button>
              <button class="btn btn-sm btn-danger" (click)="deleteUser(user)" title="Delete User">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showBranchModal" (click)="closeBranchModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ editMode ? 'Edit Company' : 'Add New Company' }}</h2>
      <button class="close-btn" (click)="closeBranchModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label>Company Code *</label>
          <input type="text" [(ngModel)]="branchForm.code" placeholder="e.g., CO001" [disabled]="editMode" />
        </div>
        <div class="form-group">
          <label>Company Name *</label>
          <input type="text" [(ngModel)]="branchForm.name" placeholder="Company name" />
        </div>
      </div>
      <div class="form-group">
        <label>Address</label>
        <input type="text" [(ngModel)]="branchForm.address" placeholder="Street address" />
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>City</label>
          <input type="text" [(ngModel)]="branchForm.city" placeholder="City" />
        </div>
        <div class="form-group">
          <label>State</label>
          <input type="text" [(ngModel)]="branchForm.state" placeholder="State" />
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Country</label>
          <input type="text" [(ngModel)]="branchForm.country" placeholder="Country" />
        </div>
        <div class="form-group">
          <label>Zip Code</label>
          <input type="text" [(ngModel)]="branchForm.zipCode" placeholder="Zip code" />
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Phone</label>
          <input type="text" [(ngModel)]="branchForm.phone" placeholder="Phone number" />
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" [(ngModel)]="branchForm.email" placeholder="Email address" />
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Currency</label>
          <select [(ngModel)]="branchForm.currency">
            <option value="USD">USD - US Dollar</option>
            <option value="EUR">EUR - Euro</option>
            <option value="GBP">GBP - British Pound</option>
            <option value="JPY">JPY - Japanese Yen</option>
            <option value="CNY">CNY - Chinese Yuan</option>
          </select>
        </div>
        <div class="form-group">
          <label>Timezone</label>
          <select [(ngModel)]="branchForm.timezone">
            <option value="UTC">UTC</option>
            <option value="America/New_York">Eastern Time (ET)</option>
            <option value="America/Chicago">Central Time (CT)</option>
            <option value="America/Denver">Mountain Time (MT)</option>
            <option value="America/Los_Angeles">Pacific Time (PT)</option>
            <option value="Europe/London">London (GMT)</option>
            <option value="Asia/Tokyo">Tokyo (JST)</option>
            <option value="Asia/Shanghai">Shanghai (CST)</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="branchForm.active" />
          <span>Active</span>
        </label>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeBranchModal()">Cancel</button>
      <button class="btn btn-primary" (click)="saveBranch()" [disabled]="isLoading">
        <i *ngIf="isLoading" class="fas fa-spinner fa-spin"></i>
        {{ editMode ? 'Update Company' : 'Create Company' }}
      </button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showUserModal" (click)="closeUserModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ editMode ? 'Edit User' : 'Add New User' }}</h2>
      <button class="close-btn" (click)="closeUserModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label>First Name *</label>
          <input type="text" [(ngModel)]="userForm.firstName" placeholder="First name" />
        </div>
        <div class="form-group">
          <label>Last Name *</label>
          <input type="text" [(ngModel)]="userForm.lastName" placeholder="Last name" />
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Username *</label>
          <input type="text" [(ngModel)]="userForm.username" placeholder="Username" [disabled]="editMode" />
        </div>
        <div class="form-group">
          <label>Email *</label>
          <input type="email" [(ngModel)]="userForm.email" placeholder="Email address" />
        </div>
      </div>
      <div class="form-group" *ngIf="!editMode">
        <label>Password *</label>
        <input type="password" [(ngModel)]="userForm.password" placeholder="Password (min 6 characters)" />
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Phone</label>
          <input type="text" [(ngModel)]="userForm.phone" placeholder="Phone number" />
        </div>
        <div class="form-group">
          <label>Role</label>
          <select [(ngModel)]="userForm.roleId">
            <option [ngValue]="undefined">Select a role</option>
            <option *ngFor="let role of roles" [ngValue]="role.id">{{ role.name }}</option>
          </select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeUserModal()">Cancel</button>
      <button class="btn btn-primary" (click)="saveUser()" [disabled]="isLoading">
        <i *ngIf="isLoading" class="fas fa-spinner fa-spin"></i>
        {{ editMode ? 'Update User' : 'Create User' }}
      </button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showPasswordModal" (click)="closePasswordModal()">
  <div class="modal modal-sm" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Reset Password</h2>
      <button class="close-btn" (click)="closePasswordModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>New Password *</label>
        <input type="password" [(ngModel)]="newPassword" placeholder="Enter new password (min 6 characters)" />
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closePasswordModal()">Cancel</button>
      <button class="btn btn-primary" (click)="resetPassword()">Reset Password</button>
    </div>
  </div>
</div>
