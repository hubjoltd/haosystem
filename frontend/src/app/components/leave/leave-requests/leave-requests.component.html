<div class="leave-requests-container">
  <div class="page-header">
    <div class="header-left">
      <h1><i class="fas fa-calendar-check"></i> Leave Requests</h1>
      <p class="subtitle">Manage leave applications and approvals</p>
    </div>
    <button class="btn-primary" (click)="openCreateModal()">
      <i class="fas fa-plus"></i> New Request
    </button>
  </div>

  <div class="filters-bar">
    <div class="search-box">
      <i class="fas fa-search"></i>
      <input type="text" placeholder="Search by employee or leave type..." [(ngModel)]="searchTerm" (ngModelChange)="filterRequests()">
    </div>
    <div class="status-tabs">
      <button [class.active]="statusFilter === 'ALL'" (click)="statusFilter = 'ALL'; filterRequests()">All</button>
      <button [class.active]="statusFilter === 'PENDING'" (click)="statusFilter = 'PENDING'; filterRequests()">Pending</button>
      <button [class.active]="statusFilter === 'APPROVED'" (click)="statusFilter = 'APPROVED'; filterRequests()">Approved</button>
      <button [class.active]="statusFilter === 'REJECTED'" (click)="statusFilter = 'REJECTED'; filterRequests()">Rejected</button>
    </div>
  </div>

  <div class="requests-table" *ngIf="!loading && filteredRequests.length > 0">
    <table>
      <thead>
        <tr>
          <th>Employee</th>
          <th>Leave Type</th>
          <th>From</th>
          <th>To</th>
          <th>Duration</th>
          <th>Reason</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let req of filteredRequests">
          <td>
            <div class="employee-info">
              <div class="avatar">{{ req.employee?.firstName?.charAt(0) || '?' }}</div>
              <span>{{ req.employee?.firstName }} {{ req.employee?.lastName }}</span>
            </div>
          </td>
          <td>
            <span class="leave-type" [style.border-left-color]="req.leaveType?.colorCode || '#008080'">
              {{ req.leaveType?.name || 'N/A' }}
            </span>
          </td>
          <td>{{ formatDate(req.startDate) }}</td>
          <td>{{ formatDate(req.endDate) }}</td>
          <td>{{ req.isHourlyLeave ? (req.totalHours + ' hrs') : (req.totalDays + ' days') }}</td>
          <td class="reason-cell">{{ req.reason || '-' }}</td>
          <td>
            <span class="status-badge" [class]="getStatusClass(req.status || '')">{{ req.status }}</span>
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn-icon view" (click)="openActivityModal(req)" title="View Activity">
                <i class="fas fa-history"></i>
              </button>
              <button class="btn-icon approve" *ngIf="req.status === 'PENDING' || req.status === 'PENDING_MANAGER' || req.status === 'PENDING_HR'" (click)="openApprovalModal(req)" title="Review">
                <i class="fas fa-check-circle"></i>
              </button>
              <button class="btn-icon cancel" *ngIf="req.status === 'PENDING' || req.status === 'PENDING_MANAGER'" (click)="cancelRequest(req.id!)" title="Cancel">
                <i class="fas fa-times-circle"></i>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="empty-state" *ngIf="!loading && filteredRequests.length === 0">
    <i class="fas fa-calendar-times"></i>
    <p>No leave requests found</p>
  </div>

  <div class="modal-overlay" *ngIf="showModal">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>New Leave Request</h2>
        <button class="btn-close"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Employee *</label>
          <select [(ngModel)]="formData.employeeId" (ngModelChange)="onEmployeeChange()">
            <option [ngValue]="null">-- Select Employee --</option>
            <option *ngFor="let emp of employees" [ngValue]="emp.id">{{ emp.firstName }} {{ emp.lastName }} ({{ emp.employeeId }})</option>
          </select>
        </div>
        <div class="form-group">
          <label>Leave Type *</label>
          <select [(ngModel)]="formData.leaveTypeId" (ngModelChange)="onLeaveTypeChange()">
            <option [ngValue]="null">-- Select Leave Type --</option>
            <option *ngFor="let lt of leaveTypes" [ngValue]="lt.id">{{ lt.name }} ({{ lt.annualEntitlement }} {{ lt.timeUnit === 'HOURS' ? 'hours' : 'days' }})</option>
          </select>
        </div>
        <div class="balance-info" *ngIf="formData.employeeId && formData.leaveTypeId && getBalanceForLeaveType(formData.leaveTypeId)">
          <div class="balance-card">
            <i class="fas fa-calendar-check"></i>
            <div class="balance-details">
              <span class="balance-label">Available Balance</span>
              <span class="balance-value">{{ getBalanceForLeaveType(formData.leaveTypeId)?.availableBalance || 0 }} {{ isHourlyLeaveType() ? 'hours' : 'days' }}</span>
            </div>
          </div>
          <div class="balance-card used">
            <i class="fas fa-calendar-minus"></i>
            <div class="balance-details">
              <span class="balance-label">Used</span>
              <span class="balance-value">{{ getBalanceForLeaveType(formData.leaveTypeId)?.used || 0 }} {{ isHourlyLeaveType() ? 'hours' : 'days' }}</span>
            </div>
          </div>
          <div class="balance-card pending">
            <i class="fas fa-clock"></i>
            <div class="balance-details">
              <span class="balance-label">Pending</span>
              <span class="balance-value">{{ getBalanceForLeaveType(formData.leaveTypeId)?.pending || 0 }} {{ isHourlyLeaveType() ? 'hours' : 'days' }}</span>
            </div>
          </div>
        </div>
        <div class="no-balance-info" *ngIf="formData.employeeId && formData.leaveTypeId && !getBalanceForLeaveType(formData.leaveTypeId)">
          <i class="fas fa-info-circle"></i>
          <span>No leave balance found for this employee and leave type. Balance will be initialized on first request.</span>
        </div>
        <!-- Day-based leave inputs -->
        <div *ngIf="!isHourlyLeaveType()">
          <div class="form-row">
            <div class="form-group">
              <label>Start Date *</label>
              <input type="date" [(ngModel)]="formData.startDate">
            </div>
            <div class="form-group">
              <label>End Date *</label>
              <input type="date" [(ngModel)]="formData.endDate">
            </div>
          </div>
          <div class="form-group">
            <label>Day Type</label>
            <select [(ngModel)]="formData.dayType">
              <option value="FULL_DAY">Full Day</option>
              <option value="HALF_DAY_AM">Half Day (Morning)</option>
              <option value="HALF_DAY_PM">Half Day (Afternoon)</option>
            </select>
          </div>
        </div>

        <!-- Hourly leave inputs -->
        <div *ngIf="isHourlyLeaveType()">
          <div class="form-group">
            <label>Date *</label>
            <input type="date" [(ngModel)]="formData.startDate">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Start Time *</label>
              <input type="time" [(ngModel)]="formData.startTime" (ngModelChange)="calculateHours()">
            </div>
            <div class="form-group">
              <label>End Time *</label>
              <input type="time" [(ngModel)]="formData.endTime" (ngModelChange)="calculateHours()">
            </div>
          </div>
          <div class="form-group">
            <label>Total Hours</label>
            <input type="number" [(ngModel)]="formData.totalHours" readonly class="readonly-field">
          </div>
        </div>
        <div class="form-group">
          <label>Reason *</label>
          <textarea [(ngModel)]="formData.reason" rows="3" placeholder="Please provide reason for leave..."></textarea>
        </div>
        <div class="form-group">
          <label>Emergency Contact</label>
          <input type="text" [(ngModel)]="formData.emergencyContact" placeholder="Phone number">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeModal()" [disabled]="saving">Cancel</button>
        <button class="btn-primary" (click)="submitRequest()" [disabled]="saving">
          <i class="fas fa-spinner fa-spin" *ngIf="saving"></i>
          {{ saving ? 'Submitting...' : 'Submit Request' }}
        </button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" *ngIf="showApprovalModal">
    <div class="modal approval-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Review Leave Request</h2>
        <button class="btn-close"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" *ngIf="selectedRequest">
        <div class="approval-stage-indicator">
          <div class="stage" [class.active]="getApprovalStage(selectedRequest) === 'manager'" [class.completed]="selectedRequest.managerApprovalStatus === 'APPROVED'">
            <div class="stage-icon">
              <i class="fas" [class.fa-check]="selectedRequest.managerApprovalStatus === 'APPROVED'" [class.fa-user-tie]="selectedRequest.managerApprovalStatus !== 'APPROVED'"></i>
            </div>
            <span>Manager</span>
          </div>
          <div class="stage-connector"></div>
          <div class="stage" [class.active]="getApprovalStage(selectedRequest) === 'hr'" [class.completed]="selectedRequest.hrApprovalStatus === 'APPROVED'">
            <div class="stage-icon">
              <i class="fas" [class.fa-check]="selectedRequest.hrApprovalStatus === 'APPROVED'" [class.fa-users]="selectedRequest.hrApprovalStatus !== 'APPROVED'"></i>
            </div>
            <span>HR</span>
          </div>
        </div>
        <div class="request-summary">
          <div class="summary-item">
            <span class="label">Employee</span>
            <span class="value">{{ selectedRequest.employee?.firstName }} {{ selectedRequest.employee?.lastName }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Leave Type</span>
            <span class="value">{{ selectedRequest.leaveType?.name }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Duration</span>
            <span class="value">{{ formatDate(selectedRequest.startDate) }} - {{ formatDate(selectedRequest.endDate) }} ({{ selectedRequest.totalDays }} days)</span>
          </div>
          <div class="summary-item">
            <span class="label">Reason</span>
            <span class="value">{{ selectedRequest.reason }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Current Status</span>
            <span class="value status-text">{{ getApprovalStatusText(selectedRequest) }}</span>
          </div>
        </div>
        <div class="form-group">
          <label>Remarks</label>
          <textarea [(ngModel)]="approverRemarks" rows="3" placeholder="Add any comments..."></textarea>
        </div>
      </div>
      <div class="modal-footer" *ngIf="selectedRequest && getApprovalStage(selectedRequest) === 'manager'">
        <button class="btn-reject" (click)="managerReject()">
          <i class="fas fa-times"></i> Reject
        </button>
        <button class="btn-approve" (click)="managerApprove()">
          <i class="fas fa-check"></i> Manager Approve
        </button>
      </div>
      <div class="modal-footer" *ngIf="selectedRequest && getApprovalStage(selectedRequest) === 'hr'">
        <button class="btn-reject" (click)="hrReject()">
          <i class="fas fa-times"></i> Reject
        </button>
        <button class="btn-approve" (click)="hrApprove()">
          <i class="fas fa-check"></i> HR Approve (Final)
        </button>
      </div>
      <div class="modal-footer" *ngIf="selectedRequest && !getApprovalStage(selectedRequest)">
        <button class="btn-secondary">Close</button>
      </div>
    </div>
  </div>

  <!-- Activity Timeline Modal -->
  <div class="modal-overlay" *ngIf="showActivityModal">
    <div class="modal activity-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Leave Request Activity</h2>
        <button class="btn-close" (click)="closeActivityModal()"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body" *ngIf="activityRequest">
        <div class="request-info-bar">
          <span><strong>{{ activityRequest.employee?.firstName }} {{ activityRequest.employee?.lastName }}</strong></span>
          <span class="separator">|</span>
          <span>{{ activityRequest.leaveType?.name }}</span>
          <span class="separator">|</span>
          <span>{{ formatDate(activityRequest.startDate) }} - {{ formatDate(activityRequest.endDate) }}</span>
          <span class="status-badge" [class]="getStatusClass(activityRequest.status || '')">{{ activityRequest.status }}</span>
        </div>
        <app-activity-timeline
          [activities]="activityItems"
          [loading]="loadingActivity"
          [showAddNote]="true"
          title="Activity Stream"
          (addNote)="onAddNote($event)"
        ></app-activity-timeline>
      </div>
    </div>
  </div>
</div>
