<div class="daily-attendance">
  <div class="page-header">
    <div class="header-left">
      <h1>Daily Attendance</h1>
      <p class="subtitle">View attendance records by date</p>
    </div>
    <button class="btn-add-entry" (click)="openManualEntryModal()">
      <i class="fas fa-plus"></i> Add Entry
    </button>
  </div>

  <div class="summary-cards">
    <div class="summary-card total">
      <div class="card-icon">
        <i class="fas fa-users"></i>
      </div>
      <div class="card-info">
        <span class="card-label">Total Employees</span>
        <span class="card-value">{{ employees.length }}</span>
      </div>
    </div>
    <div class="summary-card present">
      <div class="card-icon">
        <i class="fas fa-user-check"></i>
      </div>
      <div class="card-info">
        <span class="card-label">Present</span>
        <span class="card-value">{{ countByStatus('PRESENT') + countWorking() }}</span>
      </div>
    </div>
    <div class="summary-card absent">
      <div class="card-icon">
        <i class="fas fa-user-times"></i>
      </div>
      <div class="card-info">
        <span class="card-label">Absent</span>
        <span class="card-value">{{ employees.length - (countByStatus('PRESENT') + countWorking()) }}</span>
      </div>
    </div>
  </div>

  <div class="attendance-table-section">
    <div class="table-header">
      <div class="date-label">
        <i class="fas fa-calendar-alt"></i>
        <span>Attendance for {{ formatDisplayDate(selectedDate) }}</span>
      </div>
      <div class="filters">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" placeholder="Search employee..." [(ngModel)]="searchTerm" (ngModelChange)="onSearchChange()" />
        </div>
        <select class="filter-select" [(ngModel)]="filterProject" (ngModelChange)="applyFilters()">
          <option value="">All Projects</option>
          <option *ngFor="let proj of projectList" [value]="proj">{{ proj }}</option>
        </select>
        <input type="date" [(ngModel)]="selectedDate" (change)="onDateChange()" class="date-picker" />
      </div>
    </div>

    <div *ngIf="loading" class="loading-row">
      <i class="fas fa-spinner fa-spin"></i> Loading...
    </div>

    <div class="table-wrapper">
      <table class="attendance-table" *ngIf="!loading">
        <thead>
          <tr>
            <th class="col-check"><input type="checkbox" [(ngModel)]="selectAll" (change)="toggleSelectAll()" /></th>
            <th>Employee ID</th>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Type</th>
            <th>Clock In</th>
            <th>Clock Out</th>
            <th>Regular</th>
            <th>OT</th>
            <th>Project</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let record of paginatedRecords" [class.editing-row]="editingRowId === record.id">
            <td class="col-check"><input type="checkbox" [(ngModel)]="record.selected" /></td>
            <td>{{ record.employee?.employeeCode || record.employee?.id || '—' }}</td>
            <td>{{ record.employee?.firstName || '—' }}</td>
            <td>{{ record.employee?.lastName || '—' }}</td>
            <td>
              <span *ngIf="record.status !== 'ABSENT'" class="type-badge work">Work</span>
              <span *ngIf="record.status === 'ABSENT'" class="type-badge absent">Absent</span>
            </td>
            <td>
              <span *ngIf="editingRowId !== record.id">{{ formatTime(record.clockIn) }}</span>
              <input *ngIf="editingRowId === record.id" type="time" [(ngModel)]="editClockIn" class="inline-time-input" />
            </td>
            <td>
              <span *ngIf="editingRowId !== record.id">{{ formatTime(record.clockOut) }}</span>
              <input *ngIf="editingRowId === record.id" type="time" [(ngModel)]="editClockOut" class="inline-time-input" />
            </td>
            <td class="hours-col">{{ record.regularHours ? record.regularHours.toFixed(1) : '—' }}</td>
            <td class="hours-col">{{ record.overtimeHours ? record.overtimeHours.toFixed(1) : '—' }}</td>
            <td>{{ record.projectName || record.project?.name || '—' }}</td>
            <td class="actions-cell">
              <ng-container *ngIf="editingRowId !== record.id">
                <button class="btn-action btn-edit" (click)="startInlineEdit(record)" title="Edit">
                  <i class="fas fa-pencil-alt"></i>
                </button>
                <button class="btn-action btn-delete" (click)="confirmDelete(record)" title="Delete">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </ng-container>
              <ng-container *ngIf="editingRowId === record.id">
                <button class="btn-action btn-save-inline" (click)="saveInlineEdit(record)" title="Save">
                  <i class="fas fa-check"></i>
                </button>
                <button class="btn-action btn-cancel-inline" (click)="cancelInlineEdit()" title="Cancel">
                  <i class="fas fa-times"></i>
                </button>
              </ng-container>
            </td>
          </tr>
          <tr *ngIf="filteredRecords.length === 0">
            <td colspan="11" class="no-data">No attendance records found for this date</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="pagination-bar" *ngIf="filteredRecords.length > 0">
      <div class="pagination-info">
        Showing {{ (currentPage - 1) * pageSize + 1 }} - {{ Math.min(currentPage * pageSize, filteredRecords.length) }} of {{ filteredRecords.length }}
      </div>
      <div class="pagination-controls">
        <button class="page-btn" (click)="goToPage(currentPage - 1)" [disabled]="currentPage === 1">
          <i class="fas fa-chevron-left"></i>
        </button>
        <button class="page-btn" *ngFor="let page of getPageNumbers()"
                [class.active]="page === currentPage"
                (click)="goToPage(page)">{{ page }}</button>
        <button class="page-btn" (click)="goToPage(currentPage + 1)" [disabled]="currentPage === totalPages">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>

    <div class="bulk-actions" *ngIf="getSelectedRecords().length > 0">
      <span>{{ getSelectedRecords().length }} record(s) selected</span>
      <button class="btn-bulk-approve" (click)="bulkApprove()" [disabled]="bulkApproving">
        <i class="fas fa-check-double"></i> Approve Selected
      </button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showManualEntryModal" (click)="closeManualEntryModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Add Attendance Entry</h2>
      <button class="close-btn" (click)="closeManualEntryModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Employee</label>
        <select [(ngModel)]="manualEntry.employeeId" class="form-control">
          <option [ngValue]="null">Select employee</option>
          <option *ngFor="let emp of employees" [ngValue]="emp.id">
            {{ emp.firstName }} {{ emp.lastName }} ({{ emp.employeeCode }})
          </option>
        </select>
      </div>
      <div class="form-group">
        <label>Date</label>
        <input type="date" [(ngModel)]="manualEntry.attendanceDate" class="form-control" />
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Clock In</label>
          <div class="time-input-wrapper">
            <i class="fas fa-clock"></i>
            <input type="time" [(ngModel)]="manualEntry.clockIn" class="form-control time-input" />
          </div>
        </div>
        <div class="form-group">
          <label>Clock Out</label>
          <div class="time-input-wrapper">
            <i class="fas fa-clock"></i>
            <input type="time" [(ngModel)]="manualEntry.clockOut" class="form-control time-input" />
          </div>
        </div>
      </div>
      <div class="form-group">
        <label>Project <span class="optional-label">(Optional)</span></label>
        <select [(ngModel)]="manualEntry.projectName" class="form-control">
          <option value="">Select project</option>
          <option *ngFor="let proj of projectList" [value]="proj">{{ proj }}</option>
        </select>
      </div>
      <div class="form-group">
        <label>Notes <span class="optional-label">(Optional)</span></label>
        <textarea [(ngModel)]="manualEntry.remarks" class="form-control" rows="3" placeholder="Add any notes"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeManualEntryModal()">Cancel</button>
      <button class="btn-add" (click)="saveManualEntry()" [disabled]="loading">
        Add Entry
      </button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showDeleteConfirm" (click)="cancelDelete()">
  <div class="modal-content modal-sm" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Confirm Delete</h2>
      <button class="close-btn" (click)="cancelDelete()"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <p class="confirm-text">Are you sure you want to delete this attendance record? This action cannot be undone.</p>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" (click)="cancelDelete()">Cancel</button>
      <button class="btn-delete-confirm" (click)="executeDelete()" [disabled]="loading">
        Delete
      </button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showEditModal" (click)="closeEditModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Edit Attendance</h2>
      <button class="close-btn" (click)="closeEditModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <div class="employee-info-display" *ngIf="editingRecord?.employee">
        <span class="label">Employee:</span>
        <span class="value">{{ getEmployeeName(editingRecord?.employee) }}</span>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Clock In</label>
          <input type="time" [(ngModel)]="editForm.clockIn" (ngModelChange)="onEditTimeChange()" class="form-control" />
        </div>
        <div class="form-group">
          <label>Clock Out</label>
          <input type="time" [(ngModel)]="editForm.clockOut" (ngModelChange)="onEditTimeChange()" class="form-control" />
        </div>
      </div>
      <div class="calculated-hours" *ngIf="editForm.calculatedHours > 0">
        <i class="fas fa-clock"></i>
        <span>Calculated Hours: <strong>{{ editForm.calculatedHours }} hrs</strong></span>
      </div>
      <div class="form-group">
        <label>Status</label>
        <select [(ngModel)]="editForm.status" class="form-control">
          <option value="PRESENT">Present</option>
          <option value="ABSENT">Absent</option>
          <option value="HALF_DAY">Half Day</option>
          <option value="ON_LEAVE">On Leave</option>
        </select>
      </div>
      <div class="form-group">
        <label>Remarks</label>
        <textarea [(ngModel)]="editForm.remarks" class="form-control" rows="2"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeEditModal()">Cancel</button>
      <button class="btn-add" (click)="saveEditRecord()" [disabled]="loading">
        <i class="fas fa-save"></i> Save Changes
      </button>
    </div>
  </div>
</div>
