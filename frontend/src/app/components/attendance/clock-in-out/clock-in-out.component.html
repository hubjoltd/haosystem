<div class="clock-container">
  <div class="page-header">
    <h1>Clock In / Clock Out</h1>
    <p class="subtitle">Employee time tracking</p>
  </div>

  <div *ngIf="message" class="alert" [class.success]="messageType === 'success'" [class.error]="messageType === 'error'">
    {{ message }}
  </div>

  <div class="filters-row">
    <div class="filter-group">
      <select class="filter-select" [(ngModel)]="selectedProject">
        <option value="all">All Projects</option>
        <option *ngFor="let proj of projectList" [value]="proj.name">{{ proj.name }}</option>
      </select>

      <input type="date" class="filter-date" [(ngModel)]="selectedDate" (ngModelChange)="onDateChange()" />

      <span class="day-badge">{{ dayName }}</span>
    </div>
    <div class="filter-actions">
      <button class="btn-pdf" (click)="downloadPDF()">
        <i class="fas fa-file-pdf"></i> Download PDF
      </button>
    </div>
  </div>

  <div class="table-section">
    <div class="section-header">
      <div class="section-title">
        <span class="green-dot"></span>
        <div>
          <h2>Employees</h2>
          <p>Manage employee attendance</p>
        </div>
      </div>
      <div class="search-box">
        <i class="fas fa-search search-icon"></i>
        <input type="text" placeholder="Search employee..." [(ngModel)]="searchQuery" (ngModelChange)="onSearchChange()" />
      </div>
    </div>

    <div class="table-wrapper">
      <table class="employee-table">
        <thead>
          <tr>
            <th class="col-select"><input type="checkbox" [(ngModel)]="selectAll" (change)="toggleSelectAll()" /></th>
            <th class="col-id">EMP ID</th>
            <th class="col-name">EMPLOYEE</th>
            <th class="col-position">POSITION</th>
            <th class="col-dept">DEPARTMENT</th>
            <th class="col-status">STATUS</th>
            <th class="col-geo">GEOFENCE</th>
            <th class="col-time">CLOCK IN</th>
            <th class="col-time">CLOCK OUT</th>
            <th class="col-lunch">LUNCH</th>
            <th class="col-hours">HOURS</th>
            <th class="col-action">ACTION</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="loadingEmployees || loadingRecords">
            <td colspan="12" class="loading-cell">
              <i class="fas fa-spinner fa-spin"></i> Loading...
            </td>
          </tr>
          <tr *ngIf="!loadingEmployees && !loadingRecords && filteredRows.length === 0">
            <td colspan="12" class="empty-cell">No employees found</td>
          </tr>
          <tr *ngFor="let row of filteredRows" [class.row-active]="getStatus(row) === 'clocked_in'">
            <td class="col-select"><input type="checkbox" [(ngModel)]="row.selected" (change)="onRowSelect()" /></td>
            <td class="col-id">{{ row.employee.employeeCode }}</td>
            <td class="col-name">
              <div class="employee-cell">
                <span class="avatar" [style.background-color]="getAvatarColor(row.employee)">{{ getInitials(row.employee) }}</span>
                <span class="emp-name">{{ row.employee.firstName }} {{ row.employee.lastName }}</span>
              </div>
            </td>
            <td class="col-position">{{ row.employee.designation?.title || row.employee.jobRole?.title || '—' }}</td>
            <td class="col-dept">{{ row.employee.department?.name || '—' }}</td>
            <td class="col-status">
              <span class="status-badge" [ngClass]="{
                'status-completed': getStatus(row) === 'completed',
                'status-clocked': getStatus(row) === 'clocked_in',
                'status-not': getStatus(row) === 'not_clocked'
              }">{{ getStatusLabel(row) }}</span>
            </td>
            <td class="col-geo">
              <span *ngIf="isOnSite(row) === true" class="geo-on">✓ On Site</span>
              <span *ngIf="isOnSite(row) === false" class="geo-off">✗ Off Site</span>
              <span *ngIf="isOnSite(row) === null" class="geo-none">—</span>
            </td>
            <td class="col-time">
              <span class="time-with-edit">
                {{ getClockTime(row.record?.clockIn) }}
                <button *ngIf="row.selected && row.record?.clockIn" class="btn-edit-pencil" (click)="openEditModal(row)" title="Edit">
                  <i class="fas fa-pencil-alt"></i>
                </button>
              </span>
            </td>
            <td class="col-time">
              <span class="time-with-edit">
                {{ getClockTime(row.record?.clockOut) }}
                <button *ngIf="row.selected && row.record?.clockOut" class="btn-edit-pencil" (click)="openEditModal(row)" title="Edit">
                  <i class="fas fa-pencil-alt"></i>
                </button>
              </span>
            </td>
            <td class="col-lunch">{{ getLunchHour(row) }}</td>
            <td class="col-hours">{{ getHours(row) }}</td>
            <td class="col-action">
              <div class="action-group">
                <button *ngIf="getStatus(row) === 'not_clocked'" class="btn-action btn-clock-in" (click)="openClockInModal(row.employee)" [disabled]="isProcessing(row.employee.id)">
                  <i class="fas fa-spinner fa-spin" *ngIf="isProcessing(row.employee.id) && loadingClockIn"></i>
                  <span *ngIf="!isProcessing(row.employee.id) || !loadingClockIn">Clock In</span>
                </button>
                <button *ngIf="getStatus(row) === 'clocked_in'" class="btn-action btn-clock-out" (click)="clockOut(row.employee)" [disabled]="isProcessing(row.employee.id)">
                  <i class="fas fa-spinner fa-spin" *ngIf="isProcessing(row.employee.id) && loadingClockOut"></i>
                  <span *ngIf="!isProcessing(row.employee.id) || !loadingClockOut">Clock Out</span>
                </button>
                <span *ngIf="getStatus(row) === 'completed'" class="action-done">—</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showClockInModal" (click)="cancelClockIn()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h3>Clock In - Select Location</h3>
    <p class="modal-question">Where are you clocking in from?</p>
    <select class="modal-select" [(ngModel)]="selectedLocation">
      <option value="ON_SITE">On Site</option>
      <option value="OFF_SITE">Off Site</option>
      <option value="REMOTE">Remote</option>
      <option value="FIELD">Field</option>
    </select>
    <div class="modal-actions">
      <button class="btn-cancel" (click)="cancelClockIn()">Cancel</button>
      <button class="btn-confirm" (click)="confirmClockIn()" [disabled]="loadingClockIn">Confirm Clock In</button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showEditModal" (click)="cancelEdit()">
  <div class="modal-content edit-modal" (click)="$event.stopPropagation()">
    <div class="edit-modal-header">
      <h3><i class="fas fa-edit"></i> Edit Attendance</h3>
      <button class="btn-close-modal" (click)="cancelEdit()"><i class="fas fa-times"></i></button>
    </div>
    <div class="edit-modal-body" *ngIf="editEmployee">
      <div class="edit-employee-info">
        <span class="avatar" [style.background-color]="getAvatarColor(editEmployee.employee)">{{ getInitials(editEmployee.employee) }}</span>
        <div>
          <span class="edit-emp-name">{{ editEmployee.employee.firstName }} {{ editEmployee.employee.lastName }}</span>
          <span class="edit-emp-code">{{ editEmployee.employee.employeeCode }}</span>
        </div>
      </div>
      <div class="edit-form-row">
        <div class="edit-form-group">
          <label>Clock In</label>
          <input type="time" class="edit-time-input" [(ngModel)]="editClockIn" />
        </div>
        <div class="edit-form-group">
          <label>Clock Out</label>
          <input type="time" class="edit-time-input" [(ngModel)]="editClockOut" />
        </div>
      </div>
      <div class="edit-form-row">
        <div class="edit-form-group" style="flex: 1;">
          <label>Location</label>
          <select class="edit-time-input" [(ngModel)]="editLocationType">
            <option value="ON_SITE">On Site</option>
            <option value="OFF_SITE">Off Site</option>
            <option value="REMOTE">Remote</option>
            <option value="FIELD">Field</option>
          </select>
        </div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" (click)="cancelEdit()">Cancel</button>
      <button class="btn-confirm" (click)="saveEdit()" [disabled]="savingEdit">
        <i class="fas fa-spinner fa-spin" *ngIf="savingEdit"></i>
        <span *ngIf="!savingEdit">Save Changes</span>
      </button>
    </div>
  </div>
</div>
