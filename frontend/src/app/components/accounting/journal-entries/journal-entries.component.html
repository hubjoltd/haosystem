<div class="journal-entries">
  <div class="page-header">
    <h1>Journal Entries</h1>
    <button class="btn btn-primary" (click)="openNewDialog()">
      <i class="fas fa-plus"></i> New Journal Entry
    </button>
  </div>

  <div class="filters-section">
    <div class="filter-group">
      <div class="search-input">
        <i class="fas fa-search"></i>
        <input type="text" [(ngModel)]="searchText" placeholder="Search entries..." />
      </div>
    </div>
    <div class="filter-group">
      <select [(ngModel)]="selectedStatus">
        <option *ngFor="let status of statusOptions" [value]="status.value">{{ status.label }}</option>
      </select>
    </div>
  </div>

  <div class="entries-table">
    <div class="loading-spinner" *ngIf="loading">
      <i class="fas fa-spinner fa-spin"></i> Loading...
    </div>
    
    <table *ngIf="!loading">
      <thead>
        <tr>
          <th style="width: 130px">Entry #</th>
          <th style="width: 120px">Date</th>
          <th>Description</th>
          <th style="width: 120px" class="text-right">Debit</th>
          <th style="width: 120px" class="text-right">Credit</th>
          <th style="width: 100px">Status</th>
          <th style="width: 140px">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let entry of entries">
          <td>
            <span class="entry-number">{{ entry.entryNumber }}</span>
          </td>
          <td>{{ entry.entryDate }}</td>
          <td>
            <div class="description-cell">
              <span>{{ entry.description }}</span>
              <span class="reference" *ngIf="entry.referenceNumber">Ref: {{ entry.referenceNumber }}</span>
            </div>
          </td>
          <td class="text-right">{{ formatCurrency(entry.totalDebit || 0) }}</td>
          <td class="text-right">{{ formatCurrency(entry.totalCredit || 0) }}</td>
          <td>
            <span class="status-badge" [ngClass]="entry.status === 'Posted' ? 'posted' : 'draft'">
              {{ entry.status }}
            </span>
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn-icon" (click)="viewEntry(entry)" title="View">
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn-icon success" (click)="confirmPost(entry)" title="Post" 
                      *ngIf="entry.status === 'Draft'">
                <i class="fas fa-check"></i>
              </button>
              <button class="btn-icon warning" (click)="confirmReverse(entry)" title="Reverse" 
                      *ngIf="entry.status === 'Posted'">
                <i class="fas fa-undo"></i>
              </button>
              <button class="btn-icon danger" (click)="confirmDeleteEntry(entry)" title="Delete" 
                      *ngIf="entry.status === 'Draft'">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
        <tr *ngIf="entries.length === 0">
          <td colspan="7" class="text-center">
            <div class="empty-state">
              <i class="fas fa-book"></i>
              <p>No journal entries found</p>
              <button class="btn btn-outline" (click)="openNewDialog()">Create First Entry</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="modal-overlay" *ngIf="displayDialog" (click)="displayDialog = false"></div>
  <div class="modal modal-large" *ngIf="displayDialog">
    <div class="modal-header">
      <h3>{{ isEdit ? 'View Journal Entry' : 'New Journal Entry' }}</h3>
      <button class="btn-close" (click)="displayDialog = false">&times;</button>
    </div>
    <div class="modal-body">
      <div class="entry-header">
        <div class="form-row">
          <label for="entryDate">Date *</label>
          <input type="date" id="entryDate" [(ngModel)]="newEntry.entryDate" [readonly]="isEdit" />
        </div>
        <div class="form-row description-row">
          <label for="description">Description *</label>
          <input type="text" id="description" [(ngModel)]="newEntry.description" 
                 [readonly]="isEdit && newEntry.status === 'Posted'" />
        </div>
        <div class="form-row">
          <label for="reference">Reference #</label>
          <input type="text" id="reference" [(ngModel)]="newEntry.referenceNumber" 
                 [readonly]="isEdit && newEntry.status === 'Posted'" />
        </div>
      </div>

      <div class="lines-section">
        <div class="lines-header">
          <h4>Journal Lines</h4>
          <button class="btn btn-text" (click)="addLine()" *ngIf="!isEdit || newEntry.status === 'Draft'">
            <i class="fas fa-plus"></i> Add Line
          </button>
        </div>

        <table class="lines-table">
          <thead>
            <tr>
              <th style="width: 40%">Account</th>
              <th>Description</th>
              <th style="width: 130px">Debit</th>
              <th style="width: 130px">Credit</th>
              <th style="width: 50px" *ngIf="!isEdit || newEntry.status === 'Draft'"></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let line of newEntry.lines; let i = index">
              <td>
                <select [(ngModel)]="line.account" [disabled]="isEdit && newEntry.status === 'Posted'">
                  <option [ngValue]="null">Select Account</option>
                  <option *ngFor="let acc of accounts" [ngValue]="acc">{{ acc.accountCode }} - {{ acc.accountName }}</option>
                </select>
              </td>
              <td>
                <input type="text" [(ngModel)]="line.description" placeholder="Line description"
                       [readonly]="isEdit && newEntry.status === 'Posted'" />
              </td>
              <td>
                <input type="number" [(ngModel)]="line.debitAmount" step="0.01" min="0"
                       [readonly]="isEdit && newEntry.status === 'Posted'" />
              </td>
              <td>
                <input type="number" [(ngModel)]="line.creditAmount" step="0.01" min="0"
                       [readonly]="isEdit && newEntry.status === 'Posted'" />
              </td>
              <td *ngIf="!isEdit || newEntry.status === 'Draft'">
                <button class="btn-icon danger" (click)="removeLine(i)" [disabled]="newEntry.lines.length <= 2">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          </tbody>
          <tfoot>
            <tr class="totals-row">
              <td colspan="2" class="text-right"><strong>Totals:</strong></td>
              <td><strong>{{ formatCurrency(calculateTotals().debit) }}</strong></td>
              <td><strong>{{ formatCurrency(calculateTotals().credit) }}</strong></td>
              <td *ngIf="!isEdit || newEntry.status === 'Draft'"></td>
            </tr>
            <tr class="balance-row" *ngIf="!calculateTotals().balanced">
              <td [attr.colspan]="isEdit && newEntry.status === 'Posted' ? 4 : 5" class="text-center error-message">
                <i class="fas fa-exclamation-triangle"></i>
                Entry is out of balance by {{ formatCurrency(calculateTotals().debit - calculateTotals().credit) }}
              </td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="displayDialog = false">Close</button>
      <button class="btn btn-primary" (click)="saveEntry()" 
              *ngIf="!isEdit" [disabled]="!calculateTotals().balanced">Save as Draft</button>
    </div>
  </div>

  <div class="modal-overlay" *ngIf="showDeleteConfirm" (click)="cancelAction()"></div>
  <div class="modal confirm-modal" *ngIf="showDeleteConfirm">
    <div class="modal-header">
      <h3>Confirm Delete</h3>
    </div>
    <div class="modal-body">
      <p>Are you sure you want to delete this journal entry?</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cancelAction()">Cancel</button>
      <button class="btn btn-danger" (click)="deleteEntry()">Delete</button>
    </div>
  </div>

  <div class="modal-overlay" *ngIf="showPostConfirm" (click)="cancelAction()"></div>
  <div class="modal confirm-modal" *ngIf="showPostConfirm">
    <div class="modal-header">
      <h3>Confirm Post</h3>
    </div>
    <div class="modal-body">
      <p>Are you sure you want to post this journal entry? This action cannot be undone.</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cancelAction()">Cancel</button>
      <button class="btn btn-success" (click)="postEntry()">Post</button>
    </div>
  </div>

  <div class="modal-overlay" *ngIf="showReverseConfirm" (click)="cancelAction()"></div>
  <div class="modal confirm-modal" *ngIf="showReverseConfirm">
    <div class="modal-header">
      <h3>Confirm Reversal</h3>
    </div>
    <div class="modal-body">
      <p>Are you sure you want to reverse this journal entry?</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cancelAction()">Cancel</button>
      <button class="btn btn-warning" (click)="reverseEntry()">Reverse</button>
    </div>
  </div>
</div>
