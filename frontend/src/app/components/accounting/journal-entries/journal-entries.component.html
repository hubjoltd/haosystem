<div class="inventory-page">
  <div class="page-header">
    <div>
      <h1>Journal Entries</h1>
      <div class="breadcrumb">
        <a routerLink="/app">Home</a>
        <span>/</span>
        <span>Accounting</span>
        <span>/</span>
        <span>Journal Entries</span>
      </div>
    </div>
    <button class="btn btn-primary" (click)="openNewDialog()">
      <i class="fas fa-plus"></i> New Journal Entry
    </button>
  </div>

  <div class="card">
    <div class="card-header-row">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" [(ngModel)]="searchText" placeholder="Search entries..." />
      </div>
      <div class="filters">
        <select class="form-control filter-select" [(ngModel)]="selectedStatus">
          <option *ngFor="let status of statusOptions" [value]="status.value">{{ status.label }}</option>
        </select>
      </div>
    </div>

    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>Entry #</th>
            <th>Date</th>
            <th>Description</th>
            <th class="text-right">Debit</th>
            <th class="text-right">Credit</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="loading">
            <td colspan="7" class="empty-state">
              <i class="fas fa-spinner fa-spin"></i>
            </td>
          </tr>
          <tr *ngIf="!loading && entries.length === 0">
            <td colspan="7" class="empty-state">
              <i class="fas fa-book"></i>
              <p>No journal entries found. Click "New Journal Entry" to create one.</p>
            </td>
          </tr>
          <tr *ngFor="let entry of entries">
            <td><strong class="entry-number">{{ entry.entryNumber }}</strong></td>
            <td>{{ entry.entryDate }}</td>
            <td>
              {{ entry.description }}
              <small class="text-muted" *ngIf="entry.referenceNumber"><br/>Ref: {{ entry.referenceNumber }}</small>
            </td>
            <td class="text-right">{{ formatCurrency(entry.totalDebit || 0) }}</td>
            <td class="text-right">{{ formatCurrency(entry.totalCredit || 0) }}</td>
            <td>
              <span class="badge" [ngClass]="entry.status === 'Posted' ? 'badge-success' : 'badge-warning'">
                {{ entry.status }}
              </span>
            </td>
            <td>
              <div class="action-buttons">
                <button class="btn btn-sm btn-secondary" (click)="viewEntry(entry)" title="View">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-success" (click)="confirmPost(entry)" title="Post" *ngIf="entry.status === 'Draft'">
                  <i class="fas fa-check"></i>
                </button>
                <button class="btn btn-sm btn-warning" (click)="confirmReverse(entry)" title="Reverse" *ngIf="entry.status === 'Posted'">
                  <i class="fas fa-undo"></i>
                </button>
                <button class="btn btn-sm btn-danger" (click)="confirmDeleteEntry(entry)" title="Delete" *ngIf="entry.status === 'Draft'">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="displayDialog">
  <div class="modal modal-xl" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ isEdit ? 'View Journal Entry' : 'New Journal Entry' }}</h2>
      <button class="close-btn" (click)="displayDialog = false"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <div class="entry-header">
        <div class="form-group">
          <label>Date <span class="required">*</span></label>
          <input type="date" class="form-control" [(ngModel)]="newEntry.entryDate" [readonly]="isEdit" />
        </div>
        <div class="form-group flex-grow">
          <label>Description <span class="required">*</span></label>
          <input type="text" class="form-control" [(ngModel)]="newEntry.description" placeholder="Entry description"
                 [readonly]="isEdit && newEntry.status === 'Posted'" />
        </div>
        <div class="form-group">
          <label>Reference #</label>
          <input type="text" class="form-control" [(ngModel)]="newEntry.referenceNumber" placeholder="Optional"
                 [readonly]="isEdit && newEntry.status === 'Posted'" />
        </div>
      </div>

      <div class="lines-section">
        <div class="lines-header">
          <h4>Journal Lines</h4>
          <button class="btn btn-sm btn-primary" (click)="addLine()" *ngIf="!isEdit || newEntry.status === 'Draft'">
            <i class="fas fa-plus"></i> Add Line
          </button>
        </div>

        <table class="table lines-table">
          <thead>
            <tr>
              <th style="width: 40%">Account</th>
              <th>Description</th>
              <th style="width: 120px">Debit</th>
              <th style="width: 120px">Credit</th>
              <th style="width: 50px" *ngIf="!isEdit || newEntry.status === 'Draft'"></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let line of newEntry.lines; let i = index">
              <td>
                <select class="form-control" [(ngModel)]="line.account" [disabled]="isEdit && newEntry.status === 'Posted'">
                  <option [ngValue]="null">Select Account</option>
                  <option *ngFor="let acc of accounts" [ngValue]="acc">{{ acc.accountCode }} - {{ acc.accountName }}</option>
                </select>
              </td>
              <td>
                <input type="text" class="form-control" [(ngModel)]="line.description" placeholder="Line description"
                       [readonly]="isEdit && newEntry.status === 'Posted'" />
              </td>
              <td>
                <input type="number" class="form-control text-right" [(ngModel)]="line.debitAmount" step="0.01" min="0"
                       [readonly]="isEdit && newEntry.status === 'Posted'" />
              </td>
              <td>
                <input type="number" class="form-control text-right" [(ngModel)]="line.creditAmount" step="0.01" min="0"
                       [readonly]="isEdit && newEntry.status === 'Posted'" />
              </td>
              <td *ngIf="!isEdit || newEntry.status === 'Draft'">
                <button class="btn btn-sm btn-danger" (click)="removeLine(i)" [disabled]="newEntry.lines.length <= 2">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          </tbody>
          <tfoot>
            <tr class="totals-row">
              <td colspan="2" class="text-right"><strong>Totals:</strong></td>
              <td class="text-right"><strong>{{ formatCurrency(calculateTotals().debit) }}</strong></td>
              <td class="text-right"><strong>{{ formatCurrency(calculateTotals().credit) }}</strong></td>
              <td *ngIf="!isEdit || newEntry.status === 'Draft'"></td>
            </tr>
            <tr *ngIf="!calculateTotals().balanced" class="balance-error">
              <td [attr.colspan]="isEdit && newEntry.status === 'Posted' ? 4 : 5">
                <div class="alert alert-danger">
                  <i class="fas fa-exclamation-triangle"></i>
                  Entry out of balance by {{ formatCurrency(calculateTotals().debit - calculateTotals().credit) }}
                </div>
              </td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="displayDialog = false">Close</button>
      <button class="btn btn-primary" (click)="saveEntry()" *ngIf="!isEdit" [disabled]="!calculateTotals().balanced">
        Save as Draft
      </button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showDeleteConfirm">
  <div class="modal modal-sm" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Confirm Delete</h2>
    </div>
    <div class="modal-body">
      <p>Are you sure you want to delete this journal entry?</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cancelAction()">Cancel</button>
      <button class="btn btn-danger" (click)="deleteEntry()">Delete</button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showPostConfirm">
  <div class="modal modal-sm" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Confirm Post</h2>
    </div>
    <div class="modal-body">
      <p>Are you sure you want to post this journal entry? This action cannot be undone.</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cancelAction()">Cancel</button>
      <button class="btn btn-success" (click)="postEntry()">Post</button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showReverseConfirm">
  <div class="modal modal-sm" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Confirm Reversal</h2>
    </div>
    <div class="modal-body">
      <p>Are you sure you want to reverse this journal entry?</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cancelAction()">Cancel</button>
      <button class="btn btn-warning" (click)="reverseEntry()">Reverse</button>
    </div>
  </div>
</div>
