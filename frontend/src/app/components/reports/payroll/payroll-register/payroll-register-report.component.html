<div class="report-container">
  <div class="report-header">
    <h2><i class="fas fa-clipboard-list"></i> Payroll Register</h2>
    <p class="subtitle">Monthly or annual payroll register with detailed employee records</p>
  </div>

  <!-- Loading State - Full Screen Spinner -->
  <div class="loading-container" *ngIf="loading">
    <div class="loading-spinner">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Loading payroll data...</p>
      <span class="loading-subtext">Please wait while we fetch your payroll information</span>
    </div>
  </div>

  <!-- Filters and Summary (visible only when data is ready) -->
  <ng-container >
    <div class="filter-section">
      <div class="filter-row">
        <div class="filter-group">
          <label>Report Type</label>
          <select [(ngModel)]="reportType" (change)="onReportTypeChange()" [disabled]="loading">
            <option value="monthly">Monthly</option>
            <option value="annual">Annual</option>
          </select>
        </div>
        
        <div class="filter-group" *ngIf="reportType === 'monthly'">
          <label>Payroll Run</label>
          <select [(ngModel)]="selectedRunId" (change)="onRunChange()" [disabled]="loading">
            <option *ngFor="let run of payrollRuns" [ngValue]="run.id">
              {{ run.payrollRunNumber }} ({{ formatDate(run.periodStartDate) }} - {{ formatDate(run.periodEndDate) }})
            </option>
          </select>
        </div>
        
        <div class="filter-group" *ngIf="reportType === 'annual'">
          <label>Year</label>
          <select [(ngModel)]="selectedYear" (change)="onYearChange()" [disabled]="loading">
            <option *ngFor="let year of years" [ngValue]="year">{{ year }}</option>
          </select>
        </div>
        
        <div class="filter-group search">
          <label>Search</label>
          <input type="text" [(ngModel)]="searchTerm" (input)="applyFilters()" placeholder="Search by name or code..." [disabled]="loading">
        </div>
        
        <div class="export-buttons">
          <button class="btn-export pdf" (click)="exportToPDF()" [disabled]="filteredRecords.length === 0 || loading">
            <i class="fas fa-file-pdf"></i> PDF
          </button>
          <button class="btn-export excel" (click)="exportToExcel()" [disabled]="filteredRecords.length === 0 || loading">
            <i class="fas fa-file-excel"></i> Excel
          </button>
          <button class="btn-export csv" (click)="exportToCSV()" [disabled]="filteredRecords.length === 0 || loading">
            <i class="fas fa-file-csv"></i> CSV
          </button>
        </div>
      </div>
    </div>

    <div class="summary-cards" >
      <div class="summary-card">
        <div class="card-icon"><i class="fas fa-users"></i></div>
        <div class="card-content">
          <span class="card-value">{{ filteredRecords.length }}</span>
          <span class="card-label">Employees</span>
        </div>
      </div>
      <div class="summary-card">
        <div class="card-icon gross"><i class="fas fa-dollar-sign"></i></div>
        <div class="card-content">
          <span class="card-value">{{ formatCurrency(totals.grossPay) }}</span>
          <span class="card-label">Total Gross Pay</span>
        </div>
      </div>
      <div class="summary-card">
        <div class="card-icon deductions"><i class="fas fa-minus-circle"></i></div>
        <div class="card-content">
          <span class="card-value">{{ formatCurrency(totals.totalDeductions) }}</span>
          <span class="card-label">Total Deductions</span>
        </div>
      </div>
      <div class="summary-card">
        <div class="card-icon net"><i class="fas fa-wallet"></i></div>
        <div class="card-content">
          <span class="card-value">{{ formatCurrency(totals.netPay) }}</span>
          <span class="card-label">Total Net Pay</span>
        </div>
      </div>
    </div>
  </ng-container>

  <!-- Loading State While Fetching Records -->
  <div class="loading-state" *ngIf="loading && payrollRuns.length > 0">
    <i class="fas fa-spinner fa-spin"></i>
    <p>Loading payroll records...</p>
  </div>

  <div class="table-container" *ngIf="!loading && payrollRuns.length > 0">
    <table class="report-table" *ngIf="filteredRecords.length > 0">
      <thead>
        <tr>
          <th>Employee</th>
          <th>Code</th>
          <th>Department</th>
          <th class="text-right">Base Pay</th>
          <th class="text-right">Overtime</th>
          <th class="text-right">Gross Pay</th>
          <th class="text-right">Deductions</th>
          <th class="text-right">Taxes</th>
          <th class="text-right">Net Pay</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let record of filteredRecords" (click)="openDetailsModal(record)" class="clickable-row">
          <td>
            <div class="employee-info">
              <span class="name">{{ getEmployeeName(record) }}</span>
            </div>
          </td>
          <td><span class="employee-code">{{ getEmployeeCode(record) }}</span></td>
          <td>{{ getDepartment(record) }}</td>
          <td class="text-right">{{ formatCurrency(record.basePay || 0) }}</td>
          <td class="text-right">{{ formatCurrency(record.overtimePay || 0) }}</td>
          <td class="text-right amount-gross">{{ formatCurrency(record.grossPay || 0) }}</td>
          <td class="text-right amount-deduction">{{ formatCurrency(record.totalDeductions || 0) }}</td>
          <td class="text-right amount-tax">{{ formatCurrency(record.totalTaxes || 0) }}</td>
          <td class="text-right amount-net">{{ formatCurrency(record.netPay || 0) }}</td>
        </tr>
      </tbody>
      <tfoot>
        <tr class="totals-row">
          <td colspan="3"><strong>Grand Total ({{ filteredRecords.length }} employees)</strong></td>
          <td class="text-right"><strong>-</strong></td>
          <td class="text-right"><strong>-</strong></td>
          <td class="text-right"><strong>{{ formatCurrency(totals.grossPay) }}</strong></td>
          <td class="text-right"><strong>{{ formatCurrency(totals.totalDeductions) }}</strong></td>
          <td class="text-right"><strong>{{ formatCurrency(totals.totalTaxes) }}</strong></td>
          <td class="text-right"><strong>{{ formatCurrency(totals.netPay) }}</strong></td>
        </tr>
      </tfoot>
    </table>

    <div class="empty-state" *ngIf="filteredRecords.length === 0">
      <i class="fas fa-clipboard-list"></i>
      <p>No payroll records found for the selected period</p>
    </div>
  </div>

  <div class="loading-state" *ngIf="loading">
    <i class="fas fa-spinner fa-spin"></i>
    <p>Loading payroll data...</p>
  </div>
</div>

<!-- Payroll Details Modal -->
<div class="payroll-modal-overlay" *ngIf="showDetailsModal" (click)="closeDetailsModal()">
  <div class="payroll-modal" (click)="$event.stopPropagation()" *ngIf="selectedRecord">
    <div class="modal-header">
      <h3><i class="fas fa-receipt"></i> Payroll Details</h3>
      <button class="close-btn" (click)="closeDetailsModal()"><i class="fas fa-times"></i></button>
    </div>

    <div class="modal-body">
      <!-- Employee Information -->
      <div class="details-section">
        <h4>Employee Information</h4>
        <div class="details-grid">
          <div class="detail-row">
            <span class="label">Employee Name:</span>
            <span class="value">{{ getEmployeeName(selectedRecord) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Employee Code:</span>
            <span class="value">{{ getEmployeeCode(selectedRecord) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Department:</span>
            <span class="value">{{ getDepartment(selectedRecord) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Employee Type:</span>
            <span class="value">{{ selectedRecord.employeeType || 'Full-time' }}</span>
          </div>
        </div>
      </div>

      <!-- Earnings Section -->
      <div class="details-section earnings">
        <h4><i class="fas fa-plus-circle"></i> Earnings</h4>
        <div class="details-grid">
          <div class="detail-row">
            <span class="label">Base Pay:</span>
            <span class="value">{{ formatCurrency(selectedRecord.basePay || 0) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Hourly Rate:</span>
            <span class="value">{{ formatCurrency(selectedRecord.hourlyRate || 0) }}/hr</span>
          </div>
          <div class="detail-row">
            <span class="label">Regular Hours:</span>
            <span class="value">{{ selectedRecord.regularHours || 0 }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Overtime Hours:</span>
            <span class="value">{{ selectedRecord.overtimeHours || 0 }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Overtime Pay:</span>
            <span class="value">{{ formatCurrency(selectedRecord.overtimePay || 0) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Bonuses:</span>
            <span class="value">{{ formatCurrency(selectedRecord.bonuses || 0) }}</span>
          </div>
          <div class="detail-row highlight">
            <span class="label">Gross Salary:</span>
            <span class="value">{{ formatCurrency(selectedRecord.grossPay || 0) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Reimbursement:</span>
            <span class="value">{{ formatCurrency(selectedRecord.reimbursements || 0) }}</span>
          </div>
        </div>
      </div>

      <!-- Taxes Section -->
      <div class="details-section taxes">
        <h4><i class="fas fa-percent"></i> Taxes</h4>
        <div class="details-grid">
          <div class="detail-row">
            <span class="label">Federal Tax:</span>
            <span class="value tax">{{ formatCurrency(selectedRecord.federalTax || 0) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">State Tax:</span>
            <span class="value tax">{{ formatCurrency(selectedRecord.stateTax || 0) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Local Tax:</span>
            <span class="value tax">{{ formatCurrency(selectedRecord.localTax || 0) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Social Security:</span>
            <span class="value tax">{{ formatCurrency(selectedRecord.socialSecurityTax || 0) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Medicare:</span>
            <span class="value tax">{{ formatCurrency(selectedRecord.medicareTax || 0) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Disability Tax:</span>
            <span class="value tax">{{ formatCurrency(selectedRecord.disabilityTax || 0) }}</span>
          </div>
          <div class="detail-row highlight">
            <span class="label">Total Taxes:</span>
            <span class="value tax">{{ formatCurrency(selectedRecord.totalTaxes || 0) }}</span>
          </div>
        </div>
      </div>

      <!-- Deductions Section -->
      <div class="details-section deductions">
        <h4><i class="fas fa-minus-circle"></i> Deductions</h4>
        <div class="details-grid">
          <div class="detail-row">
            <span class="label">Health Insurance:</span>
            <span class="value">{{ formatCurrency(selectedRecord.healthInsurance || 0) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Dental Insurance:</span>
            <span class="value">{{ formatCurrency(selectedRecord.dentalInsurance || 0) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Vision Insurance:</span>
            <span class="value">{{ formatCurrency(selectedRecord.visionInsurance || 0) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">401(k) Retirement:</span>
            <span class="value">{{ formatCurrency(selectedRecord.retirement401k || 0) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">HSA Contribution:</span>
            <span class="value">{{ formatCurrency(selectedRecord.hsaContribution || 0) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Pre-Tax Deductions:</span>
            <span class="value">{{ formatCurrency(selectedRecord.preTaxDeductions || 0) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Post-Tax Deductions:</span>
            <span class="value">{{ formatCurrency(selectedRecord.postTaxDeductions || 0) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Loan Deductions:</span>
            <span class="value">{{ formatCurrency(selectedRecord.loanDeductions || 0) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Garnishments:</span>
            <span class="value">{{ formatCurrency(selectedRecord.garnishments || 0) }}</span>
          </div>
          <div class="detail-row highlight">
            <span class="label">Total Deductions:</span>
            <span class="value">{{ formatCurrency(selectedRecord.totalDeductions || 0) }}</span>
          </div>
        </div>
      </div>

      <!-- Employer Contributions Section -->
      <div class="details-section contributions">
        <h4><i class="fas fa-building"></i> Employer Contributions</h4>
        <div class="details-grid">
          <div class="detail-row">
            <span class="label">Employer SS:</span>
            <span class="value">{{ formatCurrency(selectedRecord.employerSocialSecurity || 0) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Employer Medicare:</span>
            <span class="value">{{ formatCurrency(selectedRecord.employerMedicare || 0) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Employer Health Insurance:</span>
            <span class="value">{{ formatCurrency(selectedRecord.employerHealthContribution || 0) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Employer 401(k) Match:</span>
            <span class="value">{{ formatCurrency(selectedRecord.employer401kMatch || 0) }}</span>
          </div>
          <div class="detail-row highlight">
            <span class="label">Total Contributions:</span>
            <span class="value">{{ formatCurrency(selectedRecord.totalEmployerContributions || 0) }}</span>
          </div>
        </div>
      </div>

      <!-- Net Pay Section -->
      <div class="details-section net-pay">
        <h4><i class="fas fa-wallet"></i> Net Pay</h4>
        <div class="net-pay-display">
          <span class="net-pay-label">Total Net Pay:</span>
          <span class="net-pay-amount">{{ formatCurrency(selectedRecord.netPay || 0) }}</span>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-close" (click)="closeDetailsModal()">Close</button>
      </div>
    </div>
  </div>
</div>
